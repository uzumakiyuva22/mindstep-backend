<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MindStep ‚Äî Lesson</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root { --primary-red:#ff2d55; --primary-blue:#0066ff; --cyan:#00e5ff; }
    body {
      font-family: Inter, sans-serif;
      background: linear-gradient(135deg,#030314,#06122a);
      color: #eaf6ff;
      min-height: 100vh;
      display:flex; flex-direction:column; align-items:center;
      padding:30px 20px;
    }
    h1 { font-family: Orbitron; text-shadow:0 0 12px var(--cyan); }

    button {
      padding:10px 24px; border:none; border-radius:10px;
      font-weight:700;
      background:linear-gradient(90deg,var(--primary-red),var(--primary-blue));
      color:#fff; cursor:pointer; transition:.3s; margin-top:10px;
    }
    button:hover { transform:scale(1.05); box-shadow:0 0 20px var(--cyan); }

    select,textarea {
      width:100%; margin-top:10px; padding:10px; border-radius:8px;
      border:none; background:#0e0f1a; color:#fff; font-family:monospace;
    }

    pre {
      background:#0c0d12; color:#00ffb7;
      padding:14px; border-radius:10px; white-space:pre-wrap;
      margin-top:10px; font-family:Consolas,monospace;
    }

    iframe {
      width:100%; height:300px; border:1px solid #333;
      border-radius:10px; background:#fff; margin-top:10px;
    }
    .container { max-width:800px; width:100%; }

    /* Popup box (Course Completed) */
    .popup {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.7);
      justify-content:center; align-items:center;
      z-index:1000;
    }
    .popup-content {
      background:#11182a; color:#eaf6ff; padding:30px 40px;
      border-radius:12px; text-align:center;
      box-shadow:0 0 25px var(--cyan);
    }
    .popup-content h2 {
      font-family: Orbitron; color:var(--cyan);
      text-shadow:0 0 10px var(--primary-blue);
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 id="lessonTitle">Lesson</h1>
    <p id="lessonDesc">Loading lesson...</p>

    <!-- Language selection -->
    <div id="langSelectArea">
      <label for="lang">Select Language:</label>
      <select id="lang">
        <option value="java">Java</option>
        <option value="python">Python</option>
        <option value="javascript">JavaScript</option>
        <option value="html">HTML</option>
        <option value="css">CSS</option>
      </select>
    </div>

    <!-- Code area -->
    <textarea id="code" rows="12"></textarea>

    <button id="runBtn">Run Code</button>
    <pre id="output">Ready.</pre>
    <iframe id="preview" style="display:none;"></iframe>

    <!-- Mark Complete -->
    <button id="completeBtn">‚úÖ Mark Complete</button>
  </div>

  <!-- Final Popup -->
  <div class="popup" id="popupBox">
    <div class="popup-content">
      <h2>üéâ Course Completed!</h2>
      <p>You have finished all lessons in this course.</p>
      <button id="closePopup">Close & Return to Main Page</button>
    </div>
  </div>

  <script>
   // === lesson.js (Fully working with advanced backend) ===
document.addEventListener("DOMContentLoaded", () => {

  // ------------------------ PARAMS ------------------------
  const params = new URLSearchParams(window.location.search);
  const lessonId = params.get("lessonId");
  const courseSlug = params.get("course") || "python";

  // ------------------------ USER --------------------------
  const user = JSON.parse(localStorage.getItem("mindstep_user") || "null");
  if (!user) {
    alert("Please login!");
    window.location.href = "LoginPage.html";
    return;
  }
  const userId = user._id;

  // ------------------------ UI ELEMENTS --------------------
  const titleEl = document.getElementById("lessonTitle");
  const descEl  = document.getElementById("lessonDesc");
  const taskContainer = document.getElementById("tasks") || document.body;

  const progressCircle = document.getElementById("progressArc");
  const progressText   = document.getElementById("progressText");

  // Setup progress ring
  const R = 28;
  const C = 2 * Math.PI * R;
  if (progressCircle) {
    progressCircle.style.strokeDasharray = C;
    progressCircle.style.strokeDashoffset = C;
  }

  // ---------------------------------------------------------
  // LOAD LESSON + TASKS
  // ---------------------------------------------------------
  async function loadLesson() {
    try {
      const res = await fetch(`/api/lesson/${lessonId}`);
      const data = await res.json();

      if (!data.success) {
        console.error("Lesson load failed:", data);
        return;
      }

      const lesson = data.lesson;
      const tasks  = data.tasks;

      // Set lesson title/desc
      titleEl.textContent = lesson.title;
      descEl.textContent  = lesson.content || "Learn and complete the tasks below.";

      // Clear task container
      taskContainer.innerHTML = "";

      // Show each task
      tasks.forEach((task, index) => {
        const card = document.createElement("div");
        card.style = `
          margin-bottom:18px;
          padding:16px;
          border-radius:12px;
          background:rgba(255,255,255,0.04);
        `;

        card.innerHTML = `
          <h3 style="font-family:Orbitron;">Task ${index+1}: ${task.title}</h3>
          <p style="opacity:0.85;">${task.description || ""}</p>

          <textarea id="code_${task._id}" 
            style="width:100%;height:140px;margin-top:8px;background:#0a0f18;color:#eaf6ff;border-radius:10px;padding:10px;font-family:monospace;">
${task.starterCode || ""}
          </textarea>

          <button data-task="${task._id}" class="runBtn" 
            style="margin-top:10px;padding:10px 18px;border:none;border-radius:10px;font-weight:700;
                   background:linear-gradient(90deg,#ff2d55,#0066ff);color:white;cursor:pointer;">
            ‚ñ∂ Run & Check
          </button>

          <pre id="out_${task._id}" 
            style="margin-top:8px;background:#000;color:#00ffb7;padding:12px;border-radius:10px;white-space:pre-wrap;">
          </pre>
        `;

        taskContainer.appendChild(card);
      });

      attachTaskEvents(tasks);

      loadProgress();

    } catch (err) {
      console.error("Error loading lesson: ", err);
    }
  }

  // ---------------------------------------------------------
  // RUN & CHECK TASK
  // ---------------------------------------------------------
  function attachTaskEvents(tasks) {
    taskContainer.addEventListener("click", async (e) => {
      const btn = e.target.closest(".runBtn");
      if (!btn) return;

      const taskId = btn.dataset.task;
      const task = tasks.find(t => t._id === taskId);
      const outBox = document.getElementById(`out_${taskId}`);
      const codeBox = document.getElementById(`code_${taskId}`);

      const code = codeBox.value;

      // Send to backend
      outBox.textContent = "Running...";

      try {
        const res = await fetch("/api/task/check", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            userId,
            courseId: task.course_id,
            lessonId,
            taskId,
            language: task.language,
            code
          })
        });

        const data = await res.json();
        let status = data.passed ? "‚úî Correct" : "‚ùå Wrong";

        outBox.textContent = 
          `Output:\n${data.output}\n\nResult: ${status}`;

        if (data.passed) {
          loadProgress();
        }

      } catch (err) {
        outBox.textContent = "Error: " + err.message;
      }
    });
  }

  // ---------------------------------------------------------
  // UPDATE PROGRESS
  // ---------------------------------------------------------
  async function loadProgress() {
    try {
      const res = await fetch(`/api/course/${courseSlug}/progress/${userId}`);
      const data = await res.json();

      if (!data.success) return;

      const pct = Number(data.percent || 0);

      // Animate circle
      if (progressCircle) {
        progressCircle.style.strokeDashoffset = C * (1 - pct/100);
      }
      if (progressText) {
        progressText.textContent = pct + "%";
      }

    } catch (err) {
      console.error("Progress error:", err);
    }
  }

  // ---------------------------------------------------------
  // INIT
  // ---------------------------------------------------------
  loadLesson();
});
  </script>
</body>
</html>
