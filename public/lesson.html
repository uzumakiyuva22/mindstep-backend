<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MindStep â€” Lesson</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root { --primary-red:#ff2d55; --primary-blue:#0066ff; --cyan:#00e5ff; }
    body {
      font-family: Inter, sans-serif;
      background: linear-gradient(135deg,#030314,#06122a);
      color: #eaf6ff;
      min-height: 100vh;
      display:flex; flex-direction:column; align-items:center;
      padding:30px 20px;
    }
    h1 { font-family: Orbitron; text-shadow:0 0 12px var(--cyan); }

    button {
      padding:10px 24px; border:none; border-radius:10px;
      font-weight:700;
      background:linear-gradient(90deg,var(--primary-red),var(--primary-blue));
      color:#fff; cursor:pointer; transition:.3s; margin-top:10px;
    }
    button:hover { transform:scale(1.05); box-shadow:0 0 20px var(--cyan); }

    select,textarea {
      width:100%; margin-top:10px; padding:10px; border-radius:8px;
      border:none; background:#0e0f1a; color:#fff; font-family:monospace;
    }

    pre {
      background:#0c0d12; color:#00ffb7;
      padding:14px; border-radius:10px; white-space:pre-wrap;
      margin-top:10px; font-family:Consolas,monospace;
    }

    iframe {
      width:100%; height:300px; border:1px solid #333;
      border-radius:10px; background:#fff; margin-top:10px;
    }
    .container { max-width:800px; width:100%; }

    /* Popup box (Course Completed) */
    .popup {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.7);
      justify-content:center; align-items:center;
      z-index:1000;
    }
    .popup-content {
      background:#11182a; color:#eaf6ff; padding:30px 40px;
      border-radius:12px; text-align:center;
      box-shadow:0 0 25px var(--cyan);
    }
    .popup-content h2 {
      font-family: Orbitron; color:var(--cyan);
      text-shadow:0 0 10px var(--primary-blue);
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 id="lessonTitle">Lesson</h1>
    <p id="lessonDesc">Loading lesson...</p>

    <!-- Language selection -->
    <div id="langSelectArea">
      <label for="lang">Select Language:</label>
      <select id="lang">
        <option value="java">Java</option>
        <option value="python">Python</option>
        <option value="javascript">JavaScript</option>
        <option value="html">HTML</option>
        <option value="css">CSS</option>
      </select>
    </div>

    <!-- Code area -->
    <textarea id="code" rows="12"></textarea>

    <button id="runBtn">Run Code</button>
    <pre id="output">Ready.</pre>
    <iframe id="preview" style="display:none;"></iframe>

    <!-- Mark Complete -->
    <button id="completeBtn">âœ… Mark Complete</button>
  </div>

  <!-- Final Popup -->
  <div class="popup" id="popupBox">
    <div class="popup-content">
      <h2>ðŸŽ‰ Course Completed!</h2>
      <p>You have finished all lessons in this course.</p>
      <button id="closePopup">Close & Return to Main Page</button>
    </div>
  </div>

  <script>
  // === lesson.js (FINAL 100% FIXED VERSION FOR ADVANCED BACKEND) ===
document.addEventListener("DOMContentLoaded", () => {

  // ----------------------------------------------------
  // PARAMS
  // ----------------------------------------------------
  const params = new URLSearchParams(window.location.search);
  const lessonId = params.get("lessonId");
  const courseSlug = params.get("course");

  if (!lessonId || !courseSlug) {
    alert("Invalid lesson link!");
    return;
  }

  // ----------------------------------------------------
  // USER
  // ----------------------------------------------------
  const user = JSON.parse(localStorage.getItem("mindstep_user") || "null");
  if (!user) {
    alert("Please login!");
    location.href = "LoginPage.html";
    return;
  }
  const userId = user._id;

  // ----------------------------------------------------
  // UI ELEMENTS
  // ----------------------------------------------------
  const titleEl = document.getElementById("lessonTitle");
  const descEl  = document.getElementById("lessonDesc");

  // If #tasks does not exist â†’ create it inside container
  let taskContainer = document.getElementById("tasks");
  if (!taskContainer) {
    taskContainer = document.createElement("div");
    taskContainer.id = "tasks";
    taskContainer.style.marginTop = "20px";
    document.querySelector(".container").appendChild(taskContainer);
  }

  const runBtnGlobal = document.getElementById("runBtn");
  const codeBoxGlobal = document.getElementById("code");
  const languageSelect = document.getElementById("lang");
  const outputBox = document.getElementById("output");
  const previewFrame = document.getElementById("preview");
  const completeBtn = document.getElementById("completeBtn");

  const popup = document.getElementById("popupBox");
  const closePopup = document.getElementById("closePopup");

  // ----------------------------------------------------
  // LOAD LESSON DETAILS
  // ----------------------------------------------------
  async function loadLesson() {
    try {
      const res = await fetch(`/api/lesson/${lessonId}/details`);
      const data = await res.json();

      if (!data.success) {
        console.error("Lesson load failed", data);
        return;
      }

      const lesson = data.lesson;
      const tasks = data.tasks;

      titleEl.textContent = lesson.title;
      descEl.textContent = lesson.description || "";

      // Render tasks
      taskContainer.innerHTML = "";

      tasks.forEach((task, idx) => {
        const block = document.createElement("div");
        block.style = `
          padding:16px;
          background:rgba(255,255,255,0.05);
          border-radius:12px;
          margin-bottom:18px;
        `;

        block.innerHTML = `
          <h3 style="font-family:Orbitron;">Task ${idx + 1}: ${task.title}</h3>
          <p style="opacity:.85;">${task.description}</p>

          <textarea id="task_code_${task._id}" 
            style="width:100%;height:140px;background:#05070f;color:#eaf6ff;border-radius:10px;padding:10px;margin-top:8px;font-family:monospace;">${task.starterCode || ""}</textarea>

          <button data-id="${task._id}" class="runTaskBtn"
            style="margin-top:12px;padding:10px 18px;border:none;border-radius:10px;font-weight:700;
            background:linear-gradient(90deg,#ff2d55,#0066ff);cursor:pointer;color:white;">
            â–¶ Run & Check
          </button>

          <pre id="task_out_${task._id}" 
            style="background:#000;padding:12px;margin-top:10px;border-radius:10px;color:#00ffb7;">Output will appear here...</pre>
        `;

        taskContainer.appendChild(block);
      });

      attachTaskRunner(tasks);
      loadProgress();

    } catch (err) {
      console.error("Lesson load error:", err);
    }
  }

  // ----------------------------------------------------
  // TASK RUNNER
  // ----------------------------------------------------
  function attachTaskRunner(tasks) {

    taskContainer.addEventListener("click", async (e) => {
      const btn = e.target.closest(".runTaskBtn");
      if (!btn) return;

      const taskId = btn.dataset.id;
      const task = tasks.find(t => t._id === taskId);

      const codeBox = document.getElementById(`task_code_${taskId}`);
      const outBox = document.getElementById(`task_out_${taskId}`);

      const code = codeBox.value;
      outBox.textContent = "Running...";

      // HTML / CSS PREVIEW (NO RUNNER)
      if (task.language === "html" || task.language === "css") {
        previewFrame.style.display = "block";
        previewFrame.srcdoc = code;
        outBox.textContent = "Preview updated âœ”";
        return;
      }

      // Send to backend code runner
      try {
        const res = await fetch("/api/task/run", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            userId,
            taskId,
            lessonId,
            courseSlug,
            language: task.language,
            code
          })
        });

        const data = await res.json();

        outBox.textContent = `Output:\n${data.output}\n\nResult: ${data.passed ? "âœ” Correct" : "âŒ Incorrect"}`;

        // If correct â†’ save completion
        if (data.passed) {
          await saveTaskCompletion(taskId);
          loadProgress();
        }

      } catch (err) {
        outBox.textContent = "Error: " + err.message;
      }
    });
  }

  // ----------------------------------------------------
  // SAVE TASK COMPLETION
  // ----------------------------------------------------
  async function saveTaskCompletion(taskId) {
    await fetch("/api/task/submit", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ userId, taskId, lessonId, courseSlug })
    });
  }

  // ----------------------------------------------------
  // LOAD PROGRESS + COURSE COMPLETION
  // ----------------------------------------------------
  async function loadProgress() {
    try {
      const res = await fetch(`/api/course/${courseSlug}/progress/${userId}`);
      const data = await res.json();
      if (!data.success) return;

      const pct = data.percent;

      // Auto-complete popup
      if (pct === 100) {
        popup.style.display = "flex";
      }

    } catch (err) {
      console.error("Progress error:", err);
    }
  }

  // Close popup
  closePopup.onclick = () => {
    popup.style.display = "none";
    location.href = "MainPage.html";
  };

  // ----------------------------------------------------
  // INIT
  // ----------------------------------------------------
  loadLesson();

});
  </script>
</body>
</html>
