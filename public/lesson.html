<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>MindStep â€” Quantum Lab</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@500;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      /* Theme Variables */
      --bg-app: #0f111a;
      --bg-panel: #1a1d2d;
      --bg-editor: #131521;
      --bg-gutter: #181a25;
      
      --primary: #6366f1; 
      --primary-hover: #4f46e5;
      --accent: #06b6d4; 
      
      --success: #10b981;
      --error: #ef4444;
      --text-main: #e2e8f0;
      --text-muted: #64748b;
      
      --border: rgba(255, 255, 255, 0.08);
      
      --font-ui: 'Inter', sans-serif;
      --font-head: 'Outfit', sans-serif;
      --font-code: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }

    body {
      background-color: var(--bg-app);
      color: var(--text-main);
      font-family: var(--font-ui);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* --- TOP NAVIGATION --- */
    .navbar {
      height: 60px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px;
      z-index: 20;
    }

    .brand {
      display: flex; align-items: center; gap: 12px;
      font-family: var(--font-head); font-weight: 700; font-size: 1.1rem;
      color: #fff; text-decoration: none;
    }
    .brand i { color: var(--primary); font-size: 1.3rem; }

    .progress-pills { display: flex; gap: 6px; }
    .pill {
      width: 30px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 4px;
      transition: 0.3s ease;
    }
    .pill.active { background: var(--primary); box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
    .pill.completed { background: var(--success); }

    .status-badge {
      font-size: 0.8rem; color: var(--text-muted); font-family: var(--font-code);
      display: flex; align-items: center; gap: 8px;
    }
    .status-dot {
      width: 8px; height: 8px; background: var(--success); border-radius: 50%;
      box-shadow: 0 0 8px var(--success); animation: pulse 2s infinite;
    }

    /* --- MAIN WORKSPACE --- */
    .workspace {
      flex: 1;
      display: grid;
      grid-template-columns: 350px 1fr;
      overflow: hidden;
      transition: 0.3s ease;
    }
    .workspace.focus-mode { grid-template-columns: 0px 1fr; }

    /* --- LEFT PANEL --- */
    .guide-panel {
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      overflow: hidden; position: relative;
    }
    .guide-content {
      padding: 30px; overflow-y: auto; flex: 1;
    }
    .guide-content h1 { font-family: var(--font-head); font-size: 1.8rem; margin-bottom: 15px; color: #fff; }
    .guide-content p { line-height: 1.7; color: var(--text-muted); margin-bottom: 20px; font-size: 0.95rem; }
    .guide-content code { 
      background: rgba(99, 102, 241, 0.1); color: var(--accent); 
      padding: 2px 6px; border-radius: 4px; font-family: var(--font-code); font-size: 0.85em; 
    }

    /* --- RIGHT PANEL (EDITOR) --- */
    .editor-area {
      display: flex; flex-direction: column;
      background: var(--bg-app);
      position: relative;
    }

    /* Editor Toolbar */
    .toolbar {
      height: 40px; background: #151824;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 15px;
    }
    .file-tab {
      background: var(--bg-editor);
      padding: 5px 15px; border-top: 2px solid var(--primary);
      color: #fff; font-family: var(--font-code); font-size: 0.8rem;
      display: flex; align-items: center; gap: 8px;
    }
    .lang-tips {
        font-family: var(--font-ui); font-size: 0.75rem; color: var(--text-muted);
        display: flex; gap: 15px;
    }
    .tip-item i { margin-right: 5px; color: var(--accent); }

    .tool-actions { display: flex; gap: 5px; }
    .tool-btn {
      background: transparent; border: 1px solid transparent; color: var(--text-muted);
      width: 30px; height: 30px; border-radius: 6px; cursor: pointer;
      display: grid; place-items: center; transition: 0.2s;
    }
    .tool-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .tool-btn.active { color: var(--primary); background: rgba(99, 102, 241, 0.1); }

    /* IDE Container */
    .ide-container {
        flex: 1; display: flex; position: relative; overflow: hidden;
        background: var(--bg-editor);
    }

    /* Line Numbers */
    .line-numbers {
        width: 45px;
        background: var(--bg-gutter);
        border-right: 1px solid var(--border);
        color: var(--text-muted);
        font-family: var(--font-code);
        font-size: 14px;
        line-height: 1.6;
        text-align: right;
        padding: 20px 10px 20px 0;
        user-select: none;
        overflow: hidden;
    }

    /* The Actual Textarea */
    .code-wrapper { flex: 1; position: relative; }
    textarea.code-editor {
      width: 100%; height: 100%;
      background: transparent; color: #e0e0e0;
      border: none; padding: 20px;
      font-family: var(--font-code); font-size: 14px; line-height: 1.6;
      resize: none; white-space: pre; overflow: auto;
      tab-size: 4;
    }
    textarea.code-editor:focus { outline: none; }

    /* Terminal */
    .terminal-panel {
      height: 180px; background: #0b0d14;
      border-top: 1px solid var(--border);
      display: flex; flex-direction: column;
    }
    .terminal-header {
      padding: 8px 15px; background: rgba(255,255,255,0.02);
      font-family: var(--font-code); font-size: 0.75rem; text-transform: uppercase;
      color: var(--text-muted); display: flex; justify-content: space-between;
    }
    .terminal-body {
      flex: 1; padding: 15px; overflow-y: auto;
      font-family: var(--font-code); font-size: 0.85rem; color: var(--success);
    }
    .web-preview { width: 100%; height: 100%; background: #fff; border:none; display:none; }

    /* --- FOOTER --- */
    .action-bar {
      height: 70px; background: var(--bg-panel);
      border-top: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 30px; z-index: 20;
    }

    .btn {
      padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;
      font-weight: 600; font-family: var(--font-head); letter-spacing: 0.5px;
      transition: all 0.2s; display: flex; align-items: center; gap: 8px;
    }
    
    .btn-back { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
    .btn-back:hover { border-color: var(--text-main); color: #fff; }

    .btn-run {
      background: var(--primary); color: #fff;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    .btn-run:hover { background: var(--primary-hover); transform: translateY(-2px); }
    .btn-run:disabled { opacity: 0.6; cursor: wait; transform: none; }

    .btn-next {
      background: var(--success); color: #000;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    /* --- TOAST & LOADERS --- */
    #customToast {
      position: fixed; top: 80px; right: 20px;
      background: #1e293b; border-left: 4px solid var(--primary);
      padding: 15px 25px; border-radius: 4px; color: #fff;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      transform: translateX(120%); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 9999; display: flex; align-items: center; gap: 12px; font-weight: 500;
    }
    #customToast.active { transform: translateX(0); }
    #customToast.success { border-color: var(--success); }
    #customToast.error { border-color: var(--error); }

    .loader-overlay {
      position: absolute; top:0; left:0; width:100%; height:100%;
      background: var(--bg-app); z-index: 50;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    
    .finish-screen { text-align: center; animation: popIn 0.5s ease; }
    @keyframes popIn { from{transform:scale(0.9); opacity:0;} to{transform:scale(1); opacity:1;} }
    @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(16,185,129,0.7);} 70%{box-shadow:0 0 0 6px rgba(16,185,129,0);} 100%{box-shadow:0 0 0 0 rgba(16,185,129,0);} }

    /* Responsive */
    @media (max-width: 900px) {
      .workspace { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
      .guide-panel { height: auto; max-height: 30vh; border-right: none; border-bottom: 1px solid var(--border); }
      .terminal-panel { height: 150px; }
      .line-numbers { display: none; } /* Hide numbers on small screens */
    }
  </style>
</head>
<body>

  <div id="customToast"><i class="fas fa-info-circle"></i> <span>Notification</span></div>

  <nav class="navbar">
    <a href="#" class="brand" onclick="window.history.back()">
      <i class="fas fa-cube"></i> MindStep
    </a>
    <div id="progressTrack" class="progress-pills"></div>
    <div class="status-badge">
      <div class="status-dot"></div> Connected
    </div>
  </nav>

  <div id="mainStage" style="flex:1; display:flex; flex-direction:column; position:relative;">
    
    <div class="loader-overlay" id="globalLoader">
      <i class="fas fa-circle-notch fa-spin fa-3x" style="color:var(--primary); margin-bottom:20px;"></i>
      <p style="color:var(--text-muted); font-family:var(--font-code);">INITIALIZING LAB ENVIRONMENT...</p>
    </div>

    <div class="workspace" id="workspaceContainer" style="opacity:0;">
      <div class="guide-panel" id="guidePanel">
        <div class="guide-content" id="guideContent">
          </div>
      </div>

      <div class="editor-area">
        <div class="toolbar">
          <div class="file-tab">
             <i id="langIcon" class="fas fa-code"></i> <span id="langName">SCRIPT</span>
          </div>
          <div class="lang-tips" id="langTips">
             </div>
          <div class="tool-actions">
            <button class="tool-btn" onclick="toggleFocus()" title="Focus Mode"><i class="fas fa-expand-alt"></i></button>
            <button class="tool-btn" onclick="adjustFont(1)" title="Zoom In"><i class="fas fa-search-plus"></i></button>
            <button class="tool-btn" onclick="adjustFont(-1)" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
            <button class="tool-btn" onclick="copyCode()" title="Copy Code"><i class="far fa-copy"></i></button>
            <button class="tool-btn" onclick="resetCode()" title="Reset Code"><i class="fas fa-undo-alt"></i></button>
          </div>
        </div>

        <div class="ide-container">
            <div class="line-numbers" id="lineNumbers">1</div>
            <div class="code-wrapper">
              <textarea id="editor" class="code-editor" spellcheck="false" placeholder="// Start typing..."></textarea>
            </div>
        </div>

        <div class="terminal-panel">
          <div class="terminal-header">
            <span>Terminal Output</span>
            <span id="statusText">Ready</span>
          </div>
          <div class="terminal-body">
            <iframe id="preview" class="web-preview"></iframe>
            <div id="console" style="white-space: pre-wrap;">> Waiting for code execution...</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="action-bar">
    <button id="backBtn" class="btn btn-back" disabled><i class="fas fa-arrow-left"></i> Previous</button>
    <div style="font-size:0.8rem; color:var(--text-muted); display:none;" id="shortcutHint">Press Ctrl + Enter to Run</div>
    <button id="actionBtn" class="btn btn-run">Run Code <i class="fas fa-play"></i></button>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // --- STATE ---
  const state = {
    steps: [], currentIndex: 0, userCode: {}, 
    passedTasks: new Set(), user: null, lessonId: null,
    currentFontSize: 14,
    initialTaskCode: {},
    currentLang: 'text'
  };

  const params = new URLSearchParams(window.location.search);
  state.lessonId = params.get("lesson");
  const courseSlug = params.get("course"); 
  const savedUser = localStorage.getItem("mindstep_user");
  state.user = savedUser ? JSON.parse(savedUser) : { _id: "guest" };

  // --- EDITOR INTELLIGENCE LOGIC (FIXED) ---
  function setupEditorBehavior() {
    const textarea = document.getElementById('editor');
    const lineNumbers = document.getElementById('lineNumbers');

    const updateLineNumbers = () => {
        const lines = textarea.value.split('\n').length;
        lineNumbers.innerHTML = Array(lines).fill(0).map((_, i) => i + 1).join('<br>');
    };

    textarea.addEventListener('input', updateLineNumbers);
    textarea.addEventListener('scroll', () => { lineNumbers.scrollTop = textarea.scrollTop; });

    textarea.addEventListener('keydown', (e) => {
        // Tab Handling
        if (e.key === 'Tab') {
            e.preventDefault();
            document.execCommand('insertText', false, '    ');
        }
        
        // Smart Enter
        if (e.key === 'Enter') {
            e.preventDefault();
            const cursorPos = textarea.selectionStart;
            const currentLine = textarea.value.substr(0, cursorPos).split('\n').pop();
            const indentation = currentLine.match(/^\s*/)[0];
            
            let extraIndent = "";
            const lastChar = currentLine.trim().slice(-1);
            
            if ([':', '{', '('].includes(lastChar)) {
                extraIndent = "    ";
            }
            
            document.execCommand('insertText', false, '\n' + indentation + extraIndent);
        }

        // Auto-Close Brackets & Quotes
        const pairs = { '(':')', '{':'}', '[':']', '"':'"', "'":"'" };
        if (pairs[e.key]) {
            e.preventDefault();
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.substring(0, start) + e.key + pairs[e.key] + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + 1;
            updateLineNumbers();
        }
    });
  }

  setupEditorBehavior();

  // --- UI HELPER: Update Lang Context ---
  function updateLanguageContext(lang) {
      state.currentLang = lang.toLowerCase();
      const iconMap = {
          'python': 'fab fa-python', 'java': 'fab fa-java', 
          'javascript': 'fab fa-js', 'html': 'fab fa-html5', 'css': 'fab fa-css3-alt'
      };
      const tipsMap = {
          'python': '<span class="tip-item"><i class="fas fa-indent"></i> Use 4 spaces for indentation</span>',
          'java': '<span class="tip-item"><i class="fas fa-code"></i> Use { } for blocks</span> <span class="tip-item"><i class="fas fa-semicolon"></i> End lines with ;</span>',
          'javascript': '<span class="tip-item"><i class="fas fa-code"></i> Use { } for blocks</span>',
          'html': '<span class="tip-item"><i class="fas fa-code"></i> Use < > tags</span>'
      };

      document.getElementById('langIcon').className = iconMap[state.currentLang] || 'fas fa-code';
      document.getElementById('langName').innerText = lang.toUpperCase() + " SCRIPT";
      document.getElementById('langTips').innerHTML = tipsMap[state.currentLang] || '';
  }

  // --- STANDARD FUNCTIONS ---
  function showToast(msg, type="info") {
    const t = document.getElementById('customToast');
    t.className = type; 
    let icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : (type === 'error' ? '<i class="fas fa-times-circle"></i>' : '<i class="fas fa-info-circle"></i>');
    t.innerHTML = `${icon} <span>${msg}</span>`;
    t.classList.add('active');
    setTimeout(() => t.classList.remove('active'), 3500);
  }

  window.adjustFont = (delta) => {
    state.currentFontSize += delta;
    if(state.currentFontSize < 10) state.currentFontSize = 10;
    if(state.currentFontSize > 24) state.currentFontSize = 24;
    document.getElementById("editor").style.fontSize = `${state.currentFontSize}px`;
    document.getElementById("lineNumbers").style.fontSize = `${state.currentFontSize}px`;
  }

  window.toggleFocus = () => {
    document.querySelector(".workspace").classList.toggle("focus-mode");
    document.querySelector(".tool-btn[onclick='toggleFocus()']").classList.toggle("active");
  }

  window.copyCode = () => {
    navigator.clipboard.writeText(document.getElementById("editor").value).then(() => showToast("Code copied!", "success"));
  }

  window.resetCode = () => {
    const step = state.steps[state.currentIndex];
    if(step.type === 'task') {
      const original = state.initialTaskCode[step.data._id] || "";
      const editor = document.getElementById("editor");
      editor.value = original;
      editor.dispatchEvent(new Event('input')); // Force line number update
      state.userCode[step.data._id] = original;
      showToast("Code reset", "info");
    }
  }

  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      const btn = document.getElementById('actionBtn');
      if (!btn.disabled && btn.offsetParent !== null) btn.click();
    }
  });

  // --- BOOT LOGIC ---
  async function boot() {
    if(!state.lessonId) { 
        console.warn("No Lesson ID.");
        mockBoot(); return; 
    }
    try {
      const res = await fetch(`/api/lesson/${state.lessonId}/details`);
      const data = await res.json();
      if(!data.success) throw new Error("API Error");
      buildSteps(data);
    } catch(err) { 
        console.error(err);
        showToast("Error loading lesson", "error");
    }
  }

  function mockBoot() {
      buildSteps({
          lesson: { title: "Demo Mode", content: "Server disconnected." },
          tasks: [{ _id:"t1", title:"Demo Task", description:"Connect server.", language:"python", code:"print('Hello')" }]
      });
  }

  function buildSteps(data) {
    state.steps = [];
    const theory = data.lesson.lesson || data.lesson || { title: "Lesson", intro: "Welcome" };
    state.steps.push({ type: 'theory', data: theory });
    if (data.tasks && Array.isArray(data.tasks)) {
      data.tasks.forEach(t => {
        state.steps.push({ type: 'task', data: t });
        state.initialTaskCode[t._id] = t.code || ""; 
      });
    }
    state.steps.push({ type: 'finish' });
    renderProgress();
    document.getElementById("globalLoader").style.display = 'none';
    document.getElementById("workspaceContainer").style.opacity = '1';
    renderStage(0);
  }

  function renderProgress() {
    const track = document.getElementById('progressTrack');
    track.innerHTML = '';
    state.steps.forEach((_, i) => {
      const p = document.createElement('div');
      p.className = 'pill';
      p.id = `pill-${i}`;
      track.appendChild(p);
    });
  }

  function renderStage(index) {
    state.currentIndex = index;
    state.steps.forEach((_, i) => {
      const p = document.getElementById(`pill-${i}`);
      p.className = 'pill';
      if(i < index) p.classList.add('completed');
      else p.classList.remove('completed');
      if(i === index) p.classList.add('active');
      else p.classList.remove('active');
    });

    document.getElementById('backBtn').disabled = index === 0;
    document.getElementById('backBtn').onclick = () => renderStage(Math.max(0, index - 1));

    const step = state.steps[index];
    const ws = document.getElementById("workspaceContainer");
    const editorWrapper = document.querySelector(".editor-area");

    ws.style.display = "grid"; 
    editorWrapper.style.display = "flex"; 

    if(step.type === 'theory') renderTheory(step.data);
    else if(step.type === 'task') renderTask(step.data);
    else renderFinish();
  }

  function renderTheory(data) {
    const guideBox = document.getElementById("guideContent");
    const deepEx = (data.deepExplanation||[]).map(p=>`<p>${p}</p>`).join("");
    guideBox.innerHTML = `<div style="padding-bottom:50px;"><span style="color:var(--accent); font-weight:700; font-size:0.8rem; letter-spacing:1px;">KNOWLEDGE BASE</span><h1>${data.title||"Topic"}</h1><p>${data.intro || data.description || ""}</p>${deepEx}</div>`;
    document.querySelector(".editor-area").style.display = "none";
    document.getElementById("workspaceContainer").style.display = "block"; 
    const btn = document.getElementById('actionBtn');
    btn.innerHTML = `Start Coding <i class="fas fa-arrow-right"></i>`;
    btn.className = "btn btn-run"; btn.disabled = false;
    btn.onclick = () => goNext();
  }

  function renderTask(task) {
    const guideBox = document.getElementById("guideContent");
    const lang = (task.language || "text").toLowerCase();
    const isWeb = lang === 'html' || lang === 'css';
    
    updateLanguageContext(lang);

    guideBox.innerHTML = `<span style="color:var(--accent); font-weight:700; font-size:0.8rem; letter-spacing:1px;">OBJECTIVE</span><h1>${task.title}</h1><hr style="border:0; border-top:1px solid var(--border); margin:15px 0;"><p>${task.description}</p>`;

    document.querySelector(".editor-area").style.display = "flex";
    document.getElementById("workspaceContainer").style.display = "grid";
    
    const editor = document.getElementById("editor");
    editor.value = state.userCode[task._id] || task.code || "";
    editor.dispatchEvent(new Event('input')); 
    
    editor.oninput = (e) => {
        state.userCode[task._id] = e.target.value;
    };

    document.getElementById("preview").style.display = isWeb ? 'block' : 'none';
    document.getElementById("console").style.display = isWeb ? 'none' : 'block';
    document.getElementById("console").innerText = "> Waiting for execution...";
    document.getElementById("statusText").innerText = "Idle";
    document.getElementById("statusText").style.color = "var(--text-muted)";

    const btn = document.getElementById('actionBtn');
    if(state.passedTasks.has(task._id)) setSuccessState(btn);
    else {
      btn.innerHTML = `Run Code <i class="fas fa-play"></i>`; 
      btn.className = "btn btn-run"; 
      btn.onclick = () => runCode(task);
      document.getElementById("shortcutHint").style.display = "block";
    }
  }

  async function runCode(task) {
    const btn = document.getElementById('actionBtn');
    const code = document.getElementById("editor").value;
    const consoleBox = document.getElementById("console");
    const preview = document.getElementById("preview");
    const statusText = document.getElementById("statusText");
    const lang = (task.language || "text").toLowerCase();

    if(!code.trim()) { showToast("Type some code first!", "error"); return; }

    btn.disabled = true; btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Checking...`;
    statusText.innerText = "Evaluating..."; statusText.style.color = "var(--accent)";
    
    if(lang !== 'html' && lang !== 'css') consoleBox.innerText = "> Sending to server...\n> Verifying output...";

    try {
      const res = await fetch("/api/task/submit", { 
          method: "POST", headers: {"Content-Type":"application/json"}, 
          body: JSON.stringify({ userId: state.user._id, lessonId: state.lessonId, taskId: task._id, code }) 
      });
      const data = await res.json();

      if (data.output) consoleBox.innerText = data.output;

      if ((lang === 'html' || lang === 'css') && data.passed) {
          const doc = preview.contentDocument || preview.contentWindow.document;
          doc.open(); doc.write(code); doc.close();
          preview.style.display = 'block'; consoleBox.style.display = 'none';
      }

      if (data.passed === true) {
        statusText.innerText = "Correct"; statusText.style.color = "var(--success)";
        state.passedTasks.add(task._id);
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.8 }, colors: ['#6366f1', '#10b981'] });
        showToast("Perfect Match! Task Completed.", "success");
        setSuccessState(btn);
      } else {
        statusText.innerText = "Incorrect"; statusText.style.color = "var(--error)";
        if(data.output && (data.output.includes("Logic Error") || data.output.includes("Required"))) {
             // Logic error shown by backend
        }
        throw new Error("Answer does not match expected output.");
      }
    } catch(e) {
      if (!consoleBox.innerText.includes(e.message) && !consoleBox.innerText.includes("Logic Error")) {
          consoleBox.innerText += "\n\n[SYSTEM ERROR]: " + e.message;
      }
      btn.disabled = false; btn.innerHTML = `Run Code <i class="fas fa-play"></i>`;
      showToast("Incorrect Answer. Try again!", "error");
    }
  }

  function setSuccessState(btn) {
    btn.innerHTML = `Next Step <i class="fas fa-arrow-right"></i>`; 
    btn.className = "btn btn-next"; btn.disabled = false;
    btn.onclick = () => goNext();
    document.getElementById("shortcutHint").style.display = "none";
  }

  function goNext() {
    if(state.currentIndex < state.steps.length - 1) renderStage(state.currentIndex + 1);
  }

  async function renderFinish() {
    document.getElementById("workspaceContainer").style.display = "none";
    document.querySelector(".action-bar").style.display = "none"; 
    const taskSteps = state.steps.filter(s => s.type === 'task');
    if (state.passedTasks.size < taskSteps.length) {
       showToast("Complete all tasks first!", "error");
       renderStage(state.currentIndex - 1); return;
    }
    document.getElementById("mainStage").innerHTML = `<div style="flex:1; display:flex; align-items:center; justify-content:center;"><div class="finish-screen"><i class="fas fa-trophy" style="font-size:6rem; color:var(--success); margin-bottom:30px; filter:drop-shadow(0 0 30px rgba(16,185,129,0.4));"></i><h1 style="font-family:var(--font-head); font-size:2.5rem; margin-bottom:15px;">Module Complete!</h1><p style="color:var(--text-muted); margin-bottom:30px;">All systems nominal. Experience data saved.</p><button id="finishBtn" class="btn btn-run" style="margin:0 auto; padding:15px 40px;"><i class="fas fa-th"></i> Return to Hub</button></div></div>`;
    if(state.lessonId && state.user._id !== "guest") {
        try { await fetch("/api/complete", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ userId: state.user._id, lessonId: state.lessonId }) }); } catch(e) { console.error("Sync Error", e); }
    }
    confetti({ particleCount: 200, spread: 120, origin: { y: 0.6 } });
    document.getElementById("finishBtn").onclick = () => { if(courseSlug) window.location.href = `course.html?course=${courseSlug}&ts=${Date.now()}`; else window.history.back(); };
  }

  boot();
});
</script>
</body>
</html>