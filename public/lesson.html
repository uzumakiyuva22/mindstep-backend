<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MindStep ‚Äî Quantum IDE</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

    <style>
        :root {
            --bg-root: #09090b;
            --bg-sidebar: #121214;
            --bg-editor: #1e1e1e;
            --bg-terminal: #0c0c0c;
            --border: #27272a;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --accent: #38bdf8;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
            --text: #e4e4e7;
            --text-dim: #a1a1aa;
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        body.theme-neon {
            --bg-root: #0b0014;
            --bg-sidebar: #130024;
            --bg-editor: #1a0b2e;
            --bg-terminal: #05010a;
            --border: #3c1f5e;
            --primary: #d946ef;
            --accent: #22d3ee;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            background-color: var(--bg-root);
            color: var(--text);
            font-family: var(--font-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* NAVBAR */
        .navbar {
            height: 60px;
            flex-shrink: 0;
            background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 50;
        }

        .brand {
            font-weight: 800;
            font-size: 1.2rem;
            color: var(--text);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand i {
            color: var(--primary);
            font-size: 1.4rem;
            filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
        }

        /* XP HIDDEN FOR VIVA */
        .xp-container {
            display: none !important;
        }

        .level-badge {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--accent);
        }

        .xp-bar-wrapper {
            width: 100px;
            height: 6px;
            background: #27272a;
            border-radius: 3px;
            overflow: hidden;
        }

        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.5s ease;
        }

        .xp-text {
            font-size: 0.75rem;
            color: var(--text-dim);
            font-family: var(--font-code);
        }

        /* WORKSPACE */
        .workspace {
            flex: 1;
            display: grid;
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .workspace.mode-reading {
            grid-template-columns: 1fr 0px;
        }

        .workspace.mode-coding {
            grid-template-columns: 35% 65%;
        }

        /* Left Panel (Guide/Content) */
        .guide-panel {
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .guide-content {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
            scroll-behavior: smooth;
        }

        .guide-content h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--text);
        }

        .guide-content p {
            line-height: 1.7;
            color: var(--text-dim);
            margin-bottom: 20px;
        }

        .guide-content code {
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--accent);
            font-family: var(--font-code);
        }

        .badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 15px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .badge-theory {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .badge-task {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent);
            border: 1px solid rgba(56, 189, 248, 0.2);
        }

        /* --- RICH CONTENT STYLES --- */
        .theory-section {
            margin-bottom: 25px;
        }

        .theory-section h3 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-left: 3px solid var(--primary);
            padding-left: 10px;
        }

        .theory-section ul {
            padding-left: 20px;
            color: var(--text-dim);
        }

        .theory-section li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .concept-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .concept-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 6px;
        }

        .concept-term {
            color: var(--success);
            font-weight: bold;
            font-family: var(--font-code);
            display: block;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .code-block {
            background: #111;
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 6px;
            font-family: var(--font-code);
            color: #a5b4fc;
            overflow-x: auto;
            font-size: 0.85rem;
            margin-top: 10px;
            line-height: 1.5;
        }

        .analogy-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            padding: 15px;
            border-radius: 8px;
            color: #fbbf24;
            margin-top: 10px;
        }

        .mistake-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 15px;
            border-radius: 8px;
            color: #fca5a5;
            margin-top: 10px;
        }

        /* File Input UI */
        .file-input-group {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .file-input-group label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-editor);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .file-input-wrapper i {
            color: var(--primary);
        }

        #fileNameInput {
            background: transparent;
            border: none;
            color: var(--text);
            font-family: var(--font-code);
            font-size: 0.9rem;
            flex: 1;
        }

        .hint-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Right Panel */
        .ide-panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-editor);
            height: 100%;
            position: relative;
        }

        .toolbar {
            height: 40px;
            background: #27272a;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            flex-shrink: 0;
        }

        .file-tab {
            background: var(--bg-editor);
            padding: 0 20px;
            height: 100%;
            border-top: 2px solid var(--primary);
            color: var(--text);
            font-family: var(--font-code);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: grid;
            place-items: center;
            transition: 0.2s;
        }

        .icon-btn:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.1);
        }

        .editor-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 200px;
        }

        #monaco-editor {
            width: 100%;
            height: 100%;
        }

        /* PROJECT UPLOAD UI */
        .project-upload-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
            background: var(--bg-editor);
            color: var(--text);
            text-align: center;
        }

        .upload-box {
            border: 2px dashed var(--primary);
            padding: 40px;
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.05);
            width: 100%;
            max-width: 500px;
            transition: 0.3s;
            cursor: pointer;
        }

        .upload-box:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent);
        }

        .upload-box i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        /* Terminal */
        .terminal {
            height: 40px;
            min-height: 40px;
            flex-shrink: 0;
            background: var(--bg-terminal);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: height 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            position: absolute;
            bottom: 0;
            width: 100%;
            z-index: 20;
        }

        .terminal.expanded {
            height: 60% !important;
            border-top: 2px solid var(--primary);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
        }

        .term-header {
            padding: 0 15px;
            height: 40px;
            background: #27272a;
            font-family: var(--font-main);
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            cursor: pointer;
        }

        .term-body {
            flex: 1;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: #ccc;
            overflow-y: auto;
            white-space: pre-wrap;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            cursor: text;
        }

        .term-log {
            flex: 1;
        }

        .preview-area {
            width: 100%;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
        }

        .preview-area iframe {
            max-width: 100%;
        }

        .term-line {
            margin-bottom: 6px;
            display: flex;
            gap: 10px;
            line-height: 1.5;
        }

        .term-input-line {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .term-prompt {
            color: var(--success);
            font-weight: bold;
        }

        #termInput {
            background: transparent;
            border: none;
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            flex: 1;
            outline: none;
        }

        /* API PREVIEW */
        .api-preview {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin: 15px 0;
            overflow: hidden;
            animation: fadeIn 0.5s;
        }

        .api-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .method-badge {
            background: var(--success);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            margin-right: 8px;
        }

        .api-body {
            padding: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: #a5b4fc;
        }

        .action-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            font-family: var(--font-main);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .action-btn:hover {
            background: var(--primary-hover);
        }

        .action-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Footer */
        .footer {
            height: 60px;
            flex-shrink: 0;
            background: var(--bg-sidebar);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 50;
        }

        .btn {
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-family: var(--font-main);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--border);
        }

        .btn-run {
            background: var(--primary);
            color: #fff;
        }

        .btn-next {
            background: var(--success);
            color: #000;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Progress */
        .progress-container {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .step-pill {
            width: 30px;
            height: 4px;
            background: #27272a;
            border-radius: 2px;
            cursor: pointer;
            transition: 0.3s;
        }

        .step-pill.active {
            background: var(--primary);
            width: 40px;
            box-shadow: 0 0 10px var(--primary);
        }

        .step-pill.completed {
            background: var(--success);
        }

        .step-pill.locked {
            opacity: 0.3;
            cursor: not-allowed;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-root);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        #customToast {
            position: fixed;
            top: 80px;
            right: 30px;
            background: #27272a;
            padding: 12px 20px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
            color: #fff;
            transform: translateX(150%);
            transition: 0.3s;
            z-index: 200;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
        }

        /* ADDED: Bug report modal styles */
        .issue-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(2px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 300;
        }

        .issue-modal.active {
            display: flex;
        }

        .issue-modal-card {
            width: 100%;
            max-width: 620px;
            background: #111114;
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 18px 60px rgba(0, 0, 0, 0.6);
            overflow: hidden;
        }

        .issue-modal-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: #17171b;
        }

        .issue-modal-title {
            font-size: 1rem;
            font-weight: 700;
        }

        .issue-modal-body {
            padding: 18px 20px;
            display: grid;
            gap: 12px;
        }

        .issue-field label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .issue-field input,
        .issue-field textarea {
            width: 100%;
            background: #0b0b0f;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            padding: 10px 12px;
            font-family: var(--font-main);
            font-size: 0.9rem;
        }

        .issue-field textarea {
            min-height: 120px;
            resize: vertical;
        }

        .issue-modal-foot {
            padding: 14px 20px 18px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Mobile */
        @media (max-width: 900px) {
            .workspace.mode-coding {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .guide-panel {
                max-height: 35vh;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .ide-panel {
                height: auto;
                min-height: 0;
            }

            .terminal {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 40px;
                z-index: 999;
                transition: height 0.3s ease;
            }

            .terminal.expanded {
                height: 60vh !important;
            }

            #monaco-editor {
                height: 100% !important;
                min-height: 300px;
            }
        }

        @media (max-width: 600px) {
            .navbar {
                padding: 0 12px;
            }

            .xp-container {
                display: none;
            }

            .footer {
                padding: 10px;
                gap: 10px;
                height: auto;
            }

            .footer .btn {
                flex: 1;
                justify-content: center;
            }

            .file-input-wrapper {
                flex-direction: column;
                align-items: stretch;
            }

            #fileNameInput {
                width: 100%;
            }

            .issue-modal-card {
                max-width: 100%;
            }
        }
    </style>
</head>

<body>

    <div id="loadingOverlay">
        <i class="fas fa-cube fa-spin fa-3x" style="color:var(--primary); margin-bottom:20px;"></i>
        <p style="color:var(--text-dim); font-family:var(--font-code);">INITIALIZING DEV ENV...</p>
    </div>

    <div id="customToast"></div>

    <nav class="navbar">
        <a href="#" class="brand" onclick="window.history.back()">
            <i class="fas fa-cube"></i> <span>MindStep</span>
        </a>
        <div style="display:flex; gap:20px; align-items:center;">
            <div class="xp-container">
                <span class="level-badge" id="levelDisplay">LVL 1</span>
                <div class="xp-bar-wrapper">
                    <div class="xp-bar-fill" id="xpBar"></div>
                </div>
                <span class="xp-text" id="xpText">0 XP</span>
            </div>
            <div class="progress-container" id="progressBar"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <!-- ADDED: Report Issue button -->
            <button class="btn btn-secondary" style="padding:8px 14px;" onclick="openIssueModal()">
                <i class="fas fa-bug"></i> Report Issue
            </button>
            <button class="icon-btn" onclick="toggleTheme()" title="Switch Theme"><i
                    class="fas fa-palette"></i></button>
            <div
                style="font-size:0.85rem; color:var(--text-dim); display:flex; gap:8px; align-items:center; background:#18181b; padding:6px 12px; border-radius:20px; border:1px solid var(--border);">
                <div style="width:6px; height:6px; background:var(--success); border-radius:50%;"></div>
                <span id="saveStatus">Synced</span>
            </div>
        </div>
    </nav>

    <div class="workspace mode-reading" id="mainWorkspace" style="opacity:0;">

        <div class="guide-panel">
            <div class="guide-content" id="guideContent"></div>
            <div style="padding: 0 30px 30px 30px;">
                <div id="hintBox" class="hint-box">
                    <div style="color:var(--warning); font-weight:700; margin-bottom:5px;"><i
                            class="fas fa-lightbulb"></i> Concept Hint</div>
                    <div id="hintText" style="color:var(--text);"></div>
                </div>
            </div>
        </div>

        <div class="ide-panel">
            <div class="toolbar">
                <div class="file-tab">
                    <i class="fas fa-file-code" id="langIcon" style="color:var(--primary);"></i> <span
                        id="langName">server.js</span>
                </div>
                <div class="toolbar-actions">
                    <button class="icon-btn" onclick="copyCode()" title="Copy Code"><i class="far fa-copy"></i></button>
                    <button class="icon-btn" onclick="resetCode()" title="Reset Code"><i
                            class="fas fa-undo"></i></button>
                </div>
            </div>

            <div class="editor-container">
                <div id="monaco-editor"></div>
            </div>

            <div id="projectUploadArea" class="project-upload-container">
                <div class="upload-box" onclick="document.getElementById('projectFileInput').click()">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h2 id="uploadTitle">Submit Project</h2>
                    <p id="uploadHint" style="color:var(--text-dim); margin-bottom:20px;"></p>

                    <input type="file" id="projectFileInput" accept=".zip,.pdf,.docx" style="display:none;"
                        onchange="handleProjectUpload(this.files[0])">

                    <button class="btn btn-run" style="margin: 0 auto; pointer-events: none;">
                        <i class="fas fa-paper-plane"></i> Choose File
                    </button>
                    <div id="uploadStatus" style="margin-top:20px; font-weight: 500;"></div>
                    <div id="adminFeedback"
                        style="margin-top:20px; display:none; color:var(--text-dim); font-size:0.9rem;"></div>
                </div>
            </div>

            <div class="terminal" id="terminalArea">
                <div class="term-header" onclick="toggleTerminal()">
                    <span><i class="fas fa-terminal" style="margin-right:8px; opacity:0.7;"></i> TERMINAL /
                        PREVIEW</span>
                    <div style="display:flex; gap:10px;">
                        <button class="icon-btn" style="width:auto; padding:0 10px; font-size:0.8rem;">
                            <i class="fas fa-expand" id="termExpandIcon"></i> <span id="termExpandText">Expand</span>
                        </button>
                        <button class="icon-btn" onclick="event.stopPropagation(); clearTerminal()" title="Clear"><i
                                class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="term-body" id="termBody" onclick="document.getElementById('termInput').focus()">
                    <div id="previewArea" class="preview-area"></div>
                    <div id="termLog" class="term-log">
                        <div style="color:var(--text-dim); margin-bottom:10px; font-style:italic;">
                            # Welcome to MindStep Shell v1.0 <br>
                            # Step 1: Write Code. Step 2: Check Logic. Step 3: Action.
                        </div>
                    </div>
                    <div class="term-input-line">
                        <span class="term-prompt">user@mindstep:~$</span>
                        <input type="text" id="termInput" autocomplete="off" spellcheck="false">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <button class="btn btn-secondary" id="prevBtn" disabled><i class="fas fa-arrow-left"></i> Previous</button>
        <div style="font-size:0.8rem; color:var(--text-dim); font-family:var(--font-code);">Write Code & Check Logic
        </div>
        <button class="btn btn-run" id="runBtn">Check Logic <i class="fas fa-check-circle"></i></button>
    </div>

    <!-- ADDED: Bug report modal -->
    <div class="issue-modal" id="issueModal">
        <div class="issue-modal-card" role="dialog" aria-modal="true" aria-labelledby="issueModalTitle">
            <div class="issue-modal-head">
                <div class="issue-modal-title" id="issueModalTitle"><i class="fas fa-bug"></i> Report an Issue</div>
                <button class="icon-btn" type="button" onclick="closeIssueModal()" title="Close"><i class="fas fa-times"></i></button>
            </div>
            <form id="issueForm">
                <div class="issue-modal-body">
                    <div class="issue-field">
                        <label for="issueErrorMessage">Error Message</label>
                        <input id="issueErrorMessage" name="errorMessage" type="text" maxlength="300" required>
                    </div>
                    <div class="issue-field">
                        <label for="issueDescription">Description</label>
                        <textarea id="issueDescription" name="description" maxlength="5000" required></textarea>
                    </div>
                    <div class="issue-field">
                        <label for="issueScreenshot">Screenshot (Optional, max 5MB)</label>
                        <input id="issueScreenshot" name="screenshot" type="file" accept="image/*">
                    </div>
                </div>
                <div class="issue-modal-foot">
                    <button type="button" class="btn btn-secondary" onclick="closeIssueModal()">Cancel</button>
                    <button type="submit" class="btn btn-run" id="issueSubmitBtn"><i class="fas fa-paper-plane"></i> Submit</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });

        document.addEventListener("DOMContentLoaded", () => {
            const state = {
                steps: [], idx: 0, userCode: {}, passed: new Set(),
                lessonId: new URLSearchParams(location.search).get("lesson"),
                courseId: new URLSearchParams(location.search).get("course"),
                reviewRequested: new URLSearchParams(location.search).get("review") === "true",
                isReviewMode: false,
                userId: JSON.parse(localStorage.getItem("mindstep_user") || '{"_id":"guest"}')._id,
                defaults: {}, mockMode: false, failCounts: {},
                taskProgress: {},
                completedFromServer: new Set(),
                xp: parseInt(localStorage.getItem("mindstep_xp") || "0"),
                editorInstance: null,

                fileName: "server.js",
                isLogicValid: false,
                cmdHistory: [],
                cmdHistoryIdx: -1
            };

            const els = {
                termLog: document.getElementById("termLog"),
                termInput: document.getElementById("termInput"),
                termBody: document.getElementById("termBody"),
                previewArea: document.getElementById("previewArea"),
                terminalArea: document.getElementById("terminalArea"),
                termExpandIcon: document.getElementById("termExpandIcon"),
                termExpandText: document.getElementById("termExpandText"),
                runBtn: document.getElementById("runBtn"),
                prevBtn: document.getElementById("prevBtn"),
                guide: document.getElementById("guideContent"),
                ws: document.getElementById("mainWorkspace"),
                dots: document.getElementById("progressBar"),
                xpBar: document.getElementById("xpBar"),
                xpText: document.getElementById("xpText"),
                lvlDisplay: document.getElementById("levelDisplay"),
                hintBox: document.getElementById("hintBox"),
                hintText: document.getElementById("hintText"),
                langName: document.getElementById("langName"),
                saveStatus: document.getElementById("saveStatus"),
                issueModal: document.getElementById("issueModal"),
                issueForm: document.getElementById("issueForm"),
                issueErrorMessage: document.getElementById("issueErrorMessage"),
                issueDescription: document.getElementById("issueDescription"),
                issueScreenshot: document.getElementById("issueScreenshot"),
                issueSubmitBtn: document.getElementById("issueSubmitBtn")
            };

            function getAllowedProjectFormats(stepData) {
                const raw = stepData?.submission?.allowedFormats;
                if (Array.isArray(raw) && raw.length > 0) {
                    return raw.map(f => String(f).toLowerCase().replace(/^\./, "")).filter(Boolean);
                }
                return ["zip"];
            }

            async function loadTaskProgress() {
                if (!state.userId || state.userId === "guest" || !state.lessonId) return false;
                try {
                    const progressRes = await fetch(`/api/progress/${state.userId}/${state.lessonId}`);
                    const progressData = await progressRes.json();
                    if (!progressData.success) return false;

                    state.isReviewMode = Boolean(progressData.lessonCompleted) || state.reviewRequested;
                    state.completedFromServer = new Set(progressData.passedTaskIds || []);
                    const before = state.passed.size;
                    // Do not preload "passed" in review mode. User must pass again in-session.
                    if (!state.isReviewMode) {
                        (progressData.passedTaskIds || []).forEach(id => state.passed.add(id));
                    }
                    state.taskProgress = progressData.taskProgress || {};
                    return state.passed.size !== before;
                } catch (e) {
                    console.warn("Failed to load progress");
                    return false;
                }
            }

            function formatAttemptDate(value) {
                if (!value) return "N/A";
                const d = new Date(value);
                if (Number.isNaN(d.getTime())) return "N/A";
                return d.toLocaleString("en-US", {
                    day: "2-digit",
                    month: "short",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit"
                });
            }

            async function syncTaskProgress(task, passed, output = "") {
                if (state.mockMode) return;
                if (!task || !task._id || !state.userId || state.userId === "guest" || !state.lessonId) return;

                try {
                    const res = await fetch("/api/task/progress", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            userId: state.userId,
                            lessonId: state.lessonId,
                            taskId: task._id,
                            passed: Boolean(passed),
                            output
                        })
                    });
                    const data = await res.json();
                    if (data && data.success && data.progress) {
                        state.taskProgress[task._id] = data.progress;
                    }
                } catch (e) {
                    console.warn("Progress sync failed:", e && e.message ? e.message : e);
                }
            }

            // --- TERMINAL UI ---
            window.toggleTerminal = (forceState) => {
                const isCurrentlyExpanded = els.terminalArea.classList.contains('expanded');
                const shouldExpand = forceState !== undefined ? forceState : !isCurrentlyExpanded;

                if (shouldExpand) {
                    els.terminalArea.classList.add('expanded');
                    els.termExpandIcon.className = "fas fa-compress";
                    els.termExpandText.innerText = "Minimize";
                    els.termBody.scrollTop = 0;
                    els.termInput.focus();
                } else {
                    els.terminalArea.classList.remove('expanded');
                    els.termExpandIcon.className = "fas fa-expand";
                    els.termExpandText.innerText = "Expand";
                }
            };

            window.clearTerminal = () => {
                els.termLog.innerHTML = `<div style="color:var(--text-dim); font-style:italic;"># Terminal cleared.</div>`;
            };

            function scrollToBottom() {
                els.termBody.scrollTop = els.termBody.scrollHeight;
            }

            function addLog(msg, type = 'log') {
                const color = type === 'error' ? 'var(--error)' : (type === 'success' ? 'var(--success)' : (type === 'warning' ? 'var(--warning)' : 'var(--text-dim)'));
                els.termLog.innerHTML += `<div class="term-line" style="color:${color};">${msg}</div>`;
                
                // Smart auto-scroll: only scroll if user is already near bottom
                const isNearBottom = els.termBody.scrollHeight - els.termBody.scrollTop <= els.termBody.clientHeight + 50;
                if (isNearBottom) {
                    els.termBody.scrollTop = els.termBody.scrollHeight;
                }
            }

            window.addEventListener("focusin", (e) => {
                if (window.innerWidth < 900 && e.target.id === "termInput") {
                    els.terminalArea.classList.add('expanded');
                    els.termExpandIcon.className = "fas fa-compress";
                    els.termExpandText.innerText = "Minimize";
                }
            });

            window.addEventListener("focus", async () => {
                const changed = await loadTaskProgress();
                if (changed && typeof state.idx === "number" && state.steps.length) {
                    renderStep(state.idx);
                }
            });

            // --- INIT & MOCK DATA ---
            function initMonaco() {
                return new Promise((resolve) => {
                    require(['vs/editor/editor.main'], function () {
                        state.editorInstance = monaco.editor.create(document.getElementById('monaco-editor'), {
                            value: "", language: 'javascript', theme: 'vs-dark',
                            fontSize: 15, fontFamily: "'JetBrains Mono', monospace",
                            automaticLayout: true, minimap: { enabled: false },
                            scrollBeyondLastLine: false, padding: { top: 16, bottom: 16 }
                        });
                        state.editorInstance.onDidChangeModelContent(() => {
                            const code = state.editorInstance.getValue();
                            const step = state.steps[state.idx];

                            // Auto Save Indicator
                            els.saveStatus.innerText = "Saving...";
                            setTimeout(() => els.saveStatus.innerText = "Synced", 500);

                            if (state.isLogicValid) {
                                state.isLogicValid = false;
                                els.runBtn.className = "btn btn-run";
                                els.runBtn.innerHTML = `Check Logic <i class="fas fa-check-circle"></i>`;
                                els.runBtn.disabled = false;
                            }

                            if (step && step.type === 'task') {
                                state.userCode[step.data._id] = code;
                                localStorage.setItem(`draft_${state.userId}_${step.data._id}`, code);
                            }
                        });
                        state.editorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => els.runBtn.click());
                        resolve();
                    });
                });
            }

            async function init() {
                // Lesson ID Guard
                if (!state.lessonId) {
                    showToast("Invalid lesson link", "error");
                    return;
                }

                // Load Task Progress First
                await loadTaskProgress();

                if (localStorage.getItem("theme") === "neon") document.body.classList.add("theme-neon");
                updateXP();
                await initMonaco();
                setupTerminalInput();

                try {
                    const res = await fetch(`/api/lesson/${state.lessonId}/details`);
                    const data = await res.json();
                    if (!data.success) throw new Error("API Fail");
                    loadData(data);
                } catch (e) {
                    state.mockMode = true;
                    loadMockData();
                }
            }

            function loadMockData() {
                loadData({
                    lesson: {
                        title: "Express Basics",
                        description: "Learn to create a server and API endpoints.",
                        lesson: {
                            intro: "Express.js is a minimal and flexible Node.js web application framework.",
                            learningOutcomes: ["Setup Server", "Create Routes", "Handle Data"],
                            deepExplanation: ["Express simplifies the server creation process."],
                            conceptBreakdown: [{ concept: "Server", explanation: "Computes requests" }],
                            summary: "Express is essential for Node backend."
                        }
                    },
                    tasks: [
                        {
                            _id: "demo_task_1",
                            title: "1. Setup Server",
                            description: "Initialize an Express app and listen on port 3000.\n\nType: Server Task",
                            type: "server",
                            validation: { patterns: ["express", "app\\.listen", "3000"], hints: ["Use app.listen(3000)"] },
                            language: "javascript"
                        },
                        {
                            _id: "demo_project_task",
                            title: "Final Project",
                            description: "Upload your project zip.",
                            type: "project"
                        }
                    ]
                });
            }

            function loadData(data) {
                state.steps = [];
                const mainDoc = data.lesson || {};
                const richContent = mainDoc.lesson || mainDoc || {};

                // VIDEO, NOTES, PDF INJECTION
                let mediaHtml = "";

                // 1. VIDEO
                if (mainDoc.video) {
                    let url = mainDoc.video;
                    if (url.includes("youtube.com/watch")) {
                        const videoId = url.split("v=")[1].split("&")[0];
                        url = `https://www.youtube.com/embed/${videoId}`;
                    } else if (url.includes("youtu.be/")) {
                        const videoId = url.split("youtu.be/")[1];
                        url = `https://www.youtube.com/embed/${videoId}`;
                    }

                    mediaHtml += `
            <div class="theory-section">
                <h3 style="color:var(--accent);">üé• Lesson Video</h3>
                <div style="position:relative; padding-top:56.25%; margin-bottom:20px;">
                    <iframe src="${url}" 
                        style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:10px; border:1px solid var(--border);" 
                        frameborder="0" allowfullscreen>
                    </iframe>
                </div>
            </div>`;
                }

                // 2. NOTES (With XSS Protection)
                if (mainDoc.notes) {
                    const safeNotes = mainDoc.notes.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>");
                    mediaHtml += `
            <div class="theory-section">
                <h3 style="color:var(--accent);">üìù Instructor Notes</h3>
                <div style="color:var(--text-dim); line-height:1.7; background:rgba(255,255,255,0.02); padding:15px; border-radius:8px; border:1px solid var(--border);">
                    ${safeNotes}
                </div>
            </div>`;
                }

                // 3. PDF
                if (mainDoc.pdf) {
                    mediaHtml += `
            <div class="theory-section" style="margin-bottom:20px;">
                <a href="${mainDoc.pdf}" target="_blank" class="action-btn" style="width:100%; justify-content:center; background:rgba(56,189,248,0.1); border:1px solid var(--accent); color:var(--accent); text-decoration:none;">
                    <i class="fas fa-file-pdf"></i> Download Study Material (PDF)
                </a>
            </div>`;
                }

                let theoryHtml = "";
                if (richContent.intro) theoryHtml += `<p style="font-size: 1.1rem; line-height: 1.6; color: var(--text);">${richContent.intro}</p><hr style="border-color:var(--border); margin: 20px 0;">`;
                else if (mainDoc.description) theoryHtml += `<p style="font-size: 1.1rem; line-height: 1.6; color: var(--text);">${mainDoc.description}</p><hr style="border-color:var(--border); margin: 20px 0;">`;

                if (richContent.learningOutcomes && richContent.learningOutcomes.length > 0) {
                    theoryHtml += `<div class="theory-section"><h3>üéØ What you will learn</h3><ul>${richContent.learningOutcomes.map(item => `<li>${item}</li>`).join('')}</ul></div>`;
                }
                if (richContent.deepExplanation && richContent.deepExplanation.length > 0) {
                    theoryHtml += `<div class="theory-section"><h3>üìñ Core Concepts</h3>${richContent.deepExplanation.map(text => `<p>${text}</p>`).join('')}</div>`;
                }
                if (richContent.conceptBreakdown && richContent.conceptBreakdown.length > 0) {
                    theoryHtml += `<div class="theory-section"><h3>‚ö° Key Terms</h3><div class="concept-grid">${richContent.conceptBreakdown.map(c => `<div class="concept-card"><span class="concept-term">${c.concept}</span><span style="font-size:0.9rem;">${c.explanation}</span></div>`).join('')}</div></div>`;
                }
                if (richContent.realWorldAnalogy && richContent.realWorldAnalogy.length > 0) {
                    theoryHtml += `<div class="theory-section"><h3>üåç Real World Analogy</h3><div class="analogy-box"><ul style="margin:0; padding-left:20px; color:inherit;">${richContent.realWorldAnalogy.map(a => `<li>${a}</li>`).join('')}</ul></div></div>`;
                }
                if (richContent.example && richContent.example.code) {
                    theoryHtml += `<div class="theory-section"><h3>üíª Example: ${richContent.example.description || "Code Snippet"}</h3><pre class="code-block"><code>${richContent.example.code}</code></pre></div>`;
                }
                if (richContent.commonMistakes && richContent.commonMistakes.length > 0) {
                    theoryHtml += `<div class="theory-section"><h3>‚ö†Ô∏è Common Mistakes</h3><div class="mistake-box"><ul style="margin:0; padding-left:20px; color:inherit;">${richContent.commonMistakes.map(m => `<li>${m}</li>`).join('')}</ul></div></div>`;
                }
                if (richContent.summary) {
                    theoryHtml += `<hr style="border-color:var(--border); margin: 20px 0;"><p style="font-style:italic; color:var(--accent);">üí° <strong>Summary:</strong> ${richContent.summary}</p>`;
                }

                // Combine Media + Theory
                const fullTheoryHtml = mediaHtml + theoryHtml;

                state.steps.push({ type: 'theory', data: { title: mainDoc.title || "Module", html: fullTheoryHtml || "<p>No content available.</p>" } });

                (data.tasks || []).forEach(t => {
                    state.steps.push({ type: t.type === 'project' ? 'project' : 'task', data: t });
                    state.defaults[t._id] = "";
                    state.failCounts[t._id] = 0;
                    const draft = localStorage.getItem(`draft_${state.userId}_${t._id}`);
                    if (draft) state.userCode[t._id] = draft;
                    if (t.type === "project" && state.completedFromServer.has(t._id)) {
                        state.passed.add(t._id);
                    }
                });

                if (data.lesson && data.lesson.type === "project") {
                    state.steps.push({
                        type: "project",
                        data: data.lesson
                    });
                }

                state.steps.push({ type: 'finish' });

                // üî• AUTO RESUME FEATURE (FIXED) üî•
                let stepToRender = 0;
                const savedStep = localStorage.getItem(`lastStep_${state.lessonId}`);

                if (savedStep) {
                    const stepIndex = parseInt(savedStep);
                    // Safety Check: If trying to jump ahead without passing previous tasks
                    if (stepIndex > 0 && state.passed.size === 0) {
                        console.warn("Resetting progress due to mismatch");
                        localStorage.removeItem(`lastStep_${state.lessonId}`);
                        stepToRender = 0;
                    } else {
                        stepToRender = stepIndex;
                    }
                }

                renderStep(stepToRender);

                document.getElementById("loadingOverlay").style.opacity = '0';
                setTimeout(() => document.getElementById("loadingOverlay").style.display = 'none', 500);
                els.ws.style.opacity = '1';
            }

            // --- üî• RENDER STEP (SWITCHES UI) üî• ---
            window.renderStep = (i) => {
                // üî• AUTO RESUME SAVE üî•
                localStorage.setItem(`lastStep_${state.lessonId}`, i);

                // ‚úÖ FIX: Strict Previous Step Check
                if (i > 0) {
                    const prevStep = state.steps[i - 1];
                    if (!state.isReviewMode && prevStep && (prevStep.type === 'task' || prevStep.type === 'project')) {
                        if (!state.passed.has(prevStep.data._id)) {
                            showToast("Complete previous task first!", "error");
                            return;
                        }
                    }
                }

                toggleTerminal(false);
                state.isLogicValid = false;
                els.termLog.innerHTML = `<div style="color:var(--text-dim); font-style:italic;"># Ready.</div>`;

                state.idx = i;
                const step = state.steps[i];

                els.dots.innerHTML = state.steps.map((s, idx) => {
                    let status = idx === i ? 'active' : (idx < i ? 'completed' : '');
                    // Visual lock only
                    let locked = (!state.isReviewMode && idx > 0 && state.steps[idx - 1].type !== 'theory' && !state.passed.has(state.steps[idx - 1].data._id));
                    return `<div class="step-pill ${status} ${locked ? 'locked' : ''}" onclick="${!locked ? `renderStep(${idx})` : ''}"></div>`;
                }).join("");

                els.prevBtn.disabled = i === 0;
                els.prevBtn.onclick = () => renderStep(i - 1);
                els.hintBox.style.display = 'none';

                // RESET UI STATES
                document.getElementById('projectUploadArea').style.display = 'none';
                document.querySelector('.editor-container').style.display = 'block';
                if (step.type !== 'theory' && step.type !== 'finish') els.terminalArea.style.display = 'flex';

                if (step.type === 'theory') {
                    els.ws.className = "workspace mode-reading";
                    els.guide.innerHTML = `<div class="badge badge-theory"><i class="fas fa-book-open"></i> Theory</div><h1>${step.data.title}</h1><hr>${step.data.html}`;
                    els.runBtn.innerHTML = `Start Coding <i class="fas fa-arrow-right"></i>`;
                    els.runBtn.className = "btn btn-run";
                    els.runBtn.style.display = 'block';
                    els.runBtn.onclick = () => renderStep(i + 1);
                    els.terminalArea.style.display = 'none';
                }
                // üî• PROJECT UPLOAD STEP LOGIC (FIXED) üî•
                else if (step.type === 'project') {
                    els.ws.className = "workspace mode-coding";
                    document.querySelector('.editor-container').style.display = 'none'; // Hide Editor
                    els.terminalArea.style.display = 'none';     // Hide Terminal
                    document.getElementById('projectUploadArea').style.display = 'flex'; // Show Upload Box

                    const titleEl = document.getElementById("uploadTitle");
                    const hintEl = document.getElementById("uploadHint");
                    const formats = getAllowedProjectFormats(step.data);
                    const acceptList = formats.map(f => `.${f}`).join(",");
                    const formatListHtml = formats.map(f => `<b>.${f}</b>`).join(", ");

                    titleEl.innerText = "Submit Final Project";
                    hintEl.innerHTML = `Upload your file in one of these formats: ${formatListHtml}.`;
                    document.getElementById("projectFileInput").setAttribute("accept", acceptList);
                    if (state.isReviewMode) {
                        titleEl.innerText = "Practice Mode";
                        hintEl.innerHTML = "Lesson is completed. Practice is allowed; project upload stays disabled.";
                    }

                    els.guide.innerHTML = `
            <div class="badge badge-task"><i class="fas fa-trophy"></i> Final Project</div>
            <h1>${step.data.title}</h1>
            <hr>
            <p>${step.data.description}</p>
            ${state.isReviewMode ? `<div class="hint-box" style="display:block; border-color:var(--accent); background:rgba(56, 189, 248, 0.12);"><i class="fas fa-eye"></i> Practice mode is active. Coding practice is allowed; progress will not be saved.</div>` : ""}
            <div class="hint-box" style="display:block; border-color:var(--success); background:rgba(34,197,94,0.1);">
                <i class="fas fa-info-circle"></i> <b>Instructions:</b><br>
                1. Complete your work locally.<br>
                2. Prepare the final file in: ${formats.map(f => "." + f).join(", ")}.<br>
                3. Upload the file here.
            </div>
        `;
                    const projectAlreadyApproved = state.completedFromServer.has(step.data._id) || state.passed.has(step.data._id);
                    if (projectAlreadyApproved) {
                        els.runBtn.style.display = 'block';
                        els.runBtn.disabled = false;
                        els.runBtn.className = "btn btn-next";
                        els.runBtn.innerHTML = `Next Task <i class="fas fa-arrow-right"></i>`;
                        els.runBtn.onclick = () => renderStep(i + 1);
                    } else {
                        els.runBtn.style.display = 'none';
                    }
                }
                // CODING TASK STEP
                else if (step.type === 'task') {
                    els.ws.className = "workspace mode-coding";
                    els.terminalArea.style.display = 'flex';
                    els.runBtn.style.display = 'block';
                    const currentTaskProgress = state.taskProgress[step.data._id] || {};
                    const attempts = Number(currentTaskProgress.attempts || 0);
                    const progressSummaryHtml = `
            <div class="hint-box" style="display:block; border-color:var(--border); background:rgba(255,255,255,0.03); margin-top:12px;">
              <i class="fas fa-chart-line"></i> Attempts: <b>${attempts}</b><br>
              Last Attempt: <b>${formatAttemptDate(currentTaskProgress.lastAttemptAt)}</b>
            </div>`;
                    const reviewModeHtml = state.isReviewMode
                        ? `<div class="hint-box" style="display:block; border-color:var(--accent); background:rgba(56, 189, 248, 0.12);">
              <i class="fas fa-eye"></i> This lesson is already completed. You are in practice mode and DB updates are disabled.
            </div>`
                        : "";

                    const fileInputHtml = `
            <div class="file-input-group">
                <label>1. File Name</label>
                <div class="file-input-wrapper">
                    <i class="fas fa-file-code"></i>
                    <input type="text" id="fileNameInput" value="${state.fileName}" placeholder="e.g. server.js">
                </div>
            </div>
        `;

                    // ‚úÖ FIX: Specific MongoDB Hint
                    let mongoHint = "";
                    if (step.data.type === 'mongodb' && step.data.language === 'json') {
                        mongoHint = `<div class="hint-box" style="display:block; border-color:var(--accent); background:rgba(56, 189, 248, 0.1);">
              <i class="fas fa-info-circle"></i> <b>Note:</b><br>
              This is a MongoDB document task.<br>
              You only need to create a valid JSON object.<br>
              No code execution is required.</div>`;
                    }

                    els.guide.innerHTML = `
            <div class="badge badge-task"><i class="fas fa-code"></i> Task ${i}</div>
            <h1>${step.data.title}</h1>
            <hr>
            ${fileInputHtml}
            <p style="white-space:pre-wrap;">${step.data.description}</p>
            ${mongoHint}
            ${reviewModeHtml}
            ${progressSummaryHtml}
        `;

                    const fnInput = document.getElementById("fileNameInput");
                    fnInput.addEventListener("input", (e) => {
                        state.fileName = e.target.value.trim() || "untitled";
                        els.langName.innerText = state.fileName;
                    });

                    const lang = (step.data.language || "javascript").toLowerCase();
                    
                    switch(lang) {
                        case "react":
                        case "jsx":
                            state.fileName = "App.jsx";
                            break;

                        case "html":
                            state.fileName = "index.html";
                            break;

                        case "css":
                            state.fileName = "style.html";
                            break;

                        case "javascript":
                        case "js":
                            state.fileName = "script.js";
                            break;

                        case "node":
                            state.fileName = "server.js";
                            break;

                        case "java":
                            state.fileName = "Main.java";
                            break;

                        case "python":
                            state.fileName = "script.py";
                            break;

                        case "mongodb":
                        case "json":
                            state.fileName = "document.json";
                            break;

                        default:
                            state.fileName = "file.txt";
                    }

                    els.langName.innerText = state.fileName;
                    document.getElementById("fileNameInput").value = state.fileName;

                    monaco.editor.setModelLanguage(state.editorInstance.getModel(), lang);
                    state.editorInstance.setValue(state.userCode[step.data._id] || "");

                    if (!state.isReviewMode && state.passed.has(step.data._id)) setSuccessBtn();
                    else {
                        els.runBtn.innerHTML = `Check Logic <i class="fas fa-check-circle"></i>`;
                        els.runBtn.className = "btn btn-run";
                        els.runBtn.onclick = () => runCode(step.data);
                        els.runBtn.disabled = false;
                    }
                }
                else if (step.type === 'finish') finishLesson();
            };

            // üî• SUBMIT PROJECT FUNCTION (WITH ANIMATION) üî•
            window.handleProjectUpload = async (file) => {
                if (state.isReviewMode) {
                    showToast("Review mode: submission is disabled.", "warning");
                    return;
                }

                // ‚úÖ SECURITY CHECK: GUEST GUARD (IMPROVED)
                if (!state.userId || state.userId === "guest") {
                    showToast("Login required to submit project", "error");
                    setTimeout(() => window.location.href = "LoginPage.html", 1500); // Redirect logic
                    return;
                }

                if (!file) return;

                if (file.size > 50 * 1024 * 1024) {
                    showToast("File is too large (Max 50MB)", "error");
                    return;
                }

                const statusText = document.getElementById('uploadStatus');
                statusText.innerHTML = `<span style="color:var(--warning)"><i class="fas fa-spinner fa-spin"></i> Uploading...</span>`;

                const formData = new FormData();
                formData.append('projectFile', file);
                formData.append('userId', state.userId);
                formData.append('lessonId', state.lessonId);

                // ‚úÖ FIX: Attach Course ID for Progress Tracking
                if (state.courseId) {
                    formData.append('courseId', state.courseId);
                }

                const step = state.steps[state.idx];
                const stepData = step.data;
                const projType = stepData.projectType || "code";
                const allowedFormats = getAllowedProjectFormats(stepData);
                const fileExt = (file.name.split(".").pop() || "").toLowerCase();
                if (!allowedFormats.includes(fileExt)) {
                    showToast(`Allowed formats: ${allowedFormats.map(f => "." + f).join(", ")}`, "error");
                    statusText.innerHTML = `<span style="color:var(--error)"><i class="fas fa-times-circle"></i> Upload Failed</span>`;
                    return;
                }

                formData.append('projectType', projType);
                formData.append('taskId', stepData._id || "");

                try {
                    const res = await fetch('/api/project/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();

                    if (data.success) {
                        statusText.innerHTML = `<span style="color:var(--success)"><i class="fas fa-check-circle"></i> Upload Complete!</span>`;

                        const adminFb = document.getElementById("adminFeedback");
                        adminFb.style.display = "block";

                        const uploadedExt = (file.name.split(".").pop() || "").toLowerCase();
                        const isDoc = ["pdf", "docx"].includes(uploadedExt);
                        const fileIcon = isDoc ? "fa-file-alt" : "fa-file-archive";
                        const typeText = isDoc ? "Project Document" : "Project Submission";

                        adminFb.innerHTML = `
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; margin-bottom:10px;">
                    <i class="fas ${fileIcon}" style="color:var(--accent)"></i> 
                    <b>${typeText} Received</b><br>
                    <span style="font-size:0.8rem; color:var(--text-dim)">${file.name}</span>
                </div>
                <b>Admin Review:</b> Pending (ETA: 24‚Äì48 hrs) <i class="fas fa-clock" style="color:var(--warning)"></i>
            `;

                        confetti({ particleCount: 250, spread: 120, origin: { y: 0.6 } });
                        showToast("Project Submitted Successfully! üéì", "success");

                        state.passed.add(state.steps[state.idx].data._id);
                        await loadTaskProgress();
                        renderStep(state.idx);
                        updateXP(100, false);

                        // ‚úÖ FIX: REMOVED AUTO-COMPLETE
                        showToast("Waiting for admin approval", "warning");

                    } else {
                        throw new Error(data.message);
                    }
                } catch (err) {
                    statusText.innerHTML = `<span style="color:var(--error)"><i class="fas fa-times-circle"></i> Upload Failed</span>`;
                    showToast(err.message, "error");
                }
            };

            // --- LOGIC CHECK (Step 1) ---
            async function runCode(task) {
                if (['html', 'css'].includes(task.language)) {
                    toggleTerminal(true);
                    const code = state.editorInstance.getValue();
                    
                    // üî• USE MASTER VALIDATOR FOR HTML/CSS
                    const validation = validateTask(code, task);
                    
                    if (!validation.passed) {
                        addLog(`‚ùå ${validation.message}`, "error");
                        handleFailure(task);
                        return;
                    }
                    
                    addLog(validation.message, "success");
                    addLog("[INFO] Rendering HTML Preview...", "log");
                    const iframe = document.createElement("iframe");
                    iframe.style.width = "100%";
                    iframe.style.height = "350px";
                    iframe.style.border = "1px solid #333";
                    iframe.style.background = "#fff";
                    iframe.srcdoc = code;
                    els.previewArea.innerHTML = "";
                    els.previewArea.appendChild(iframe);
                    toggleTerminal(true);
                    els.termBody.scrollTop = 0;
                    addLog("[SUCCESS] Preview rendered.", "success");
                    await syncTaskProgress(task, true, "Preview rendered.");
                    handleSuccess(task);
                    return;
                }

                // üî• FIX: MongoDB JSON Guard (NO EXECUTION)
                if (task.type === "mongodb" && task.language === "json") {
                    const code = state.editorInstance.getValue();
                    toggleTerminal(true);
                    els.termLog.innerHTML = "";
                    addLog("[INFO] Validating MongoDB document structure...", "log");

                    try {
                        const parsed = JSON.parse(code);

                        if (typeof parsed !== "object" || Array.isArray(parsed) || parsed === null) {
                            throw new Error("Document must be a valid JSON object.");
                        }

                        // üî• REAL INSERT
                        const res = await fetch("/api/mongo/insert", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                data: parsed,
                                userId: state.userId,
                                lessonId: state.lessonId,
                                taskId: task._id
                            })
                        });

                        const data = await res.json();

                        if (!data.success) throw new Error(data.message);

                        addLog("[SUCCESS] Document saved to MongoDB.", "success");
                        addLog("Inserted ID: " + data.insertedId, "log");

                        const btn = document.createElement("button");
                        btn.className = "action-btn";
                        btn.innerHTML = `<i class="fas fa-database"></i> View in DB`;
                        btn.onclick = () => viewSavedData(data.insertedId);

                        els.termLog.appendChild(btn);
                        scrollToBottom();

                        await syncTaskProgress(task, true, "Document saved to MongoDB.");
                        handleSuccess(task);

                    } catch (e) {
                        addLog("[ERROR] " + e.message, "error");
                        handleFailure(task);
                    }

                    return;
                }

                async function viewSavedData(id) {
                    addLog("Fetching document...", "log");

                    const res = await fetch(`/api/mongo/get/${id}`);
                    const data = await res.json();

                    if (data.success) {
                        addLog("----- Stored Document -----", "success");
                        addLog(JSON.stringify(data.document, null, 2), "log");
                    } else {
                        addLog("Document not found", "error");
                    }
                }

                const code = state.editorInstance.getValue();
                if (!code.trim()) return showToast("Code is empty!", "error");

                toggleTerminal(true);
                els.termLog.innerHTML = '';

                addLog("[SYSTEM] Analyzing code structure...", "log");
                els.runBtn.disabled = true;
                els.runBtn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Checking...`;

                setTimeout(async () => {
                    const analysis = validateTask(code, task);

                    if (analysis.passed) {
                        state.isLogicValid = true;
                        addLog("[SUCCESS] Logic Verified.", "success");

                        els.runBtn.className = "btn btn-secondary";
                        els.runBtn.innerHTML = "Logic OK - Wait for Action";
                        els.runBtn.disabled = true;

                        const title = task.title.toLowerCase();
                        const hasListen = code.includes("app.listen");
                        const lang = (task.language || "javascript").toLowerCase();
                        const course = (state.courseId || new URLSearchParams(window.location.search).get("course") || "").toLowerCase();
                        const fileName = (state.fileName || "").trim().toLowerCase();
                        const dotIdx = fileName.lastIndexOf(".");
                        const fileExt = dotIdx >= 0 ? fileName.slice(dotIdx) : "";

                        // ===============================
                        // üî• REACT LIVE COMPILER (BABEL)
                        // ===============================
                        // React preview must depend only on selected course.
                        if (course === "react") {
                            toggleTerminal(true);
                            els.termLog.innerHTML = "";

                            addLog("[INFO] Rendering React Live Preview...", "success");

                            const userCode = state.editorInstance.getValue();
                            // Strip ALL imports and exports
                            let cleanCode = userCode
                                .replace(/^import\s+.*?from\s+['"].*?['"];?$/gm, "")
                                .replace(/^export\s+(default\s+)?/gm, "")
                                .trim();

                            // Try to detect a user-defined component name from the code
                            //  - function ComponentName() {...}
                            //  - const ComponentName = () => {...}
                            let detectedComponentName = null;
                            const fnMatch = cleanCode.match(/function\s+([A-Z][A-Za-z0-9_]*)/);
                            if (fnMatch && fnMatch[1]) {
                                detectedComponentName = fnMatch[1];
                            } else {
                                const varMatch = cleanCode.match(/(?:const|let|var)\s+([A-Z][A-Za-z0-9_]*)\s*=\s*(?:\(|async|function|[A-Za-z0-9_])/);
                                if (varMatch && varMatch[1]) detectedComponentName = varMatch[1];
                            }

                            const safeCode = cleanCode
                                .replace(/<!DOCTYPE[\s\S]*?<body>/i, "")
                                .replace(/<\/body>[\s\S]*?<\/html>/i, "")
                                .replace(/<\/script>/gi, "<\\/script>");

                            const iframe = document.createElement("iframe");
                            iframe.style.width = "100%";
                            iframe.style.height = "500px";
                            iframe.style.border = "2px solid #6366f1";
                            iframe.style.borderRadius = "8px";
                            iframe.style.background = "#ffffff";
                            iframe.style.marginTop = "10px";
                            iframe.style.display = "block";
                            // Minimal sandbox - just allow scripts
                            iframe.setAttribute('sandbox', 'allow-scripts');

                            const htmlContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"><\/script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
</head>
<body style="margin:0; padding:20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto; background:#fff; color:#333;">
    <div id="root"></div>
    <div id="status" style="color:#666; font-size:0.85rem; margin-top:10px; padding:10px; background:#f5f5f5; border-radius:4px; display:none;">Initializing...</div>
    <div id="error" style="color:#d32f2f; padding:15px; display:none; background:#ffebee; border:1px solid #ffcdd2; border-radius:4px; white-space:pre-wrap; font-family:monospace; font-size:0.9rem;"></div>

    <script type="text/babel">
        function showError(msg) {
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerHTML = '<b>‚ùå React Error:</b><br/>' + msg;
            console.error('React Error:', msg);
        }

        // Wait for React to load
        if (!window.React || !window.ReactDOM) {
            showError('React libraries failed to load from CDN. Please check your internet connection.');
            console.error('React or ReactDOM not available');
        } else {
            console.log('React libraries loaded successfully');
            
            window.addEventListener('error', function(e) {
                showError(e.message);
            });

            try {
                // Make React hooks globally available
                const { useState, useEffect, useReducer, useContext, useCallback, useMemo } = window.React;
                
                ${detectedComponentName ? `const __DETECTED__ = "${detectedComponentName}";` : ''}

                // Execute user code
                (function() {
                    try {
                        ${safeCode}
                    } catch(e) {
                        console.error("User Code Error:", e);
                    }
                })();
                
                console.log('‚úì Code executed successfully');
                
                // Auto-detect what to render
                let Component = null;
                let elementToRender = null;
                
                // 1. Try parent-detected component name first
                if (typeof __DETECTED__ !== 'undefined') {
                    try {
                        const maybeDetected = eval(__DETECTED__);
                        if (typeof maybeDetected === 'function') {
                            Component = maybeDetected;
                            console.log('‚úì Using detected component:', __DETECTED__);
                        }
                    } catch (e) {
                        console.warn('Detected component lookup failed:', e && e.message);
                    }
                }

                // 2. Try component functions
                if (!Component && typeof Counter !== 'undefined') {
                    console.log('‚úì Found Counter component');
                    Component = Counter;
                }
                else if (!Component && typeof ServerComponent !== 'undefined') {
                    console.log('‚úì Found ServerComponent');
                    Component = ServerComponent;
                }
                else if (!Component && typeof App !== 'undefined') {
                    console.log('‚úì Found App');
                    Component = App;
                }
                else if (!Component && typeof Main !== 'undefined') {
                    console.log('‚úì Found Main');
                    Component = Main;
                }
                
                // 3. Try common JSX element variable names
                if (!Component) {
                    if (typeof element !== 'undefined') {
                        console.log('‚úì Found element variable');
                        elementToRender = element;
                    }
                    else if (typeof jsx !== 'undefined') {
                        console.log('‚úì Found jsx variable');
                        elementToRender = jsx;
                    }
                    else if (typeof result !== 'undefined') {
                        console.log('‚úì Found result variable');
                        elementToRender = result;
                    }
                }
                
                // 4. If nothing found yet, auto-scan window for capitalized functions
                if (!Component && !elementToRender) {
                    if (typeof __DETECTED__ !== 'undefined') {
                        try {
                            if (typeof window[__DETECTED__] !== 'undefined') {
                                Component = window[__DETECTED__];
                                console.log('‚úì Using parent-detected component:', __DETECTED__);
                            } else if (typeof eval(__DETECTED__) !== 'undefined') {
                                Component = eval(__DETECTED__);
                                console.log('‚úì Using parent-detected component via eval:', __DETECTED__);
                            }
                        } catch (e) {
                            console.warn('Parent-detected component not found in iframe scope:', e && e.message);
                        }
                    }

                    if (!Component && !elementToRender) {
                        for (let k in window) {
                            if (/^[A-Z]/.test(k) && typeof window[k] === 'function') {
                                Component = window[k];
                                console.log('‚úì Auto-detected component from window:', k);
                                break;
                            }
                        }
                    }

                    if (!Component && !elementToRender) {
                        console.warn('Available variables in scope:', Object.keys(window).filter(k => !k.startsWith('_')).slice(0, 20));
                        throw new Error('Could not find a React component or JSX element. Try defining: element, jsx, result, App, ServerComponent, or Main.');
                    }
                }
                
                console.log('‚úì Preparing to render...');
                
                const root = window.ReactDOM.createRoot(document.getElementById('root'));
                if (Component) {
                    console.log('‚Üí Rendering component');
                    root.render(<Component />);
                } else if (elementToRender) {
                    console.log('‚Üí Rendering element:', elementToRender);
                    root.render(elementToRender);
                }
                
                console.log('‚úì Render complete');
            } catch(error) {
                console.error('‚ùå Error:', error, error.stack);
                showError((error.message || error.toString()) + '\\n\\nCheck browser console for details.');
            }
        }
    <\/script>
</body>
</html>`;

                            iframe.srcdoc = htmlContent;
                            els.previewArea.innerHTML = "";
                            els.previewArea.appendChild(iframe);
                            toggleTerminal(true);
                            els.termBody.scrollTop = 0;
                            scrollToBottom();
                            addLog("[SUCCESS] React component rendered successfully!", "success");

                            await syncTaskProgress(task, true, "React preview rendered.");
                            handleSuccess(task);
                            return;
                        }

                        if (fileExt === ".html") {
                            addLog("[INFO] Rendering HTML Preview...", "log");
                            const iframe = document.createElement("iframe");
                            iframe.style.width = "100%";
                            iframe.style.height = "350px";
                            iframe.style.border = "1px solid #333";
                            iframe.style.background = "#fff";
                            iframe.srcdoc = code;
                            els.previewArea.innerHTML = "";
                            els.previewArea.appendChild(iframe);
                            toggleTerminal(true);
                            els.termBody.scrollTop = 0;
                            addLog("[SUCCESS] Preview rendered.", "success");
                            await syncTaskProgress(task, true, "HTML preview rendered.");
                            handleSuccess(task);
                            return;
                        }

                        // üî• DOM MANIPULATION TASK - Proper iframe execution
                        if (task.type === "dom") {
                            toggleTerminal(true);
                            els.previewArea.innerHTML = "";
                            els.termLog.innerHTML = "";
                            addLog("[INFO] Rendering DOM Preview...", "log");

                            const htmlBase = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto; margin: 20px; background: #fff; color: #333; }
h2, p, div, button { margin: 10px 0; }
button { padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
button:hover { background: #4f46e5; }
#error { color: #d32f2f; padding: 15px; background: #ffebee; border: 1px solid #ffcdd2; border-radius: 4px; margin-top: 10px; display: none; white-space: pre-wrap; font-family: monospace; font-size: 0.85rem; }
</style>
</head>
<body>
<h2 id="myElement">Original Text</h2>
<p id="message">Ready for DOM manipulation...</p>
<button id="myBtn">Click Me</button>
<div id="container"></div>
<div id="error"></div>
</body>
</html>`;

                            const iframe = document.createElement("iframe");
                            iframe.style.width = "100%";
                            iframe.style.height = "400px";
                            iframe.style.border = "1px solid var(--border)";
                            iframe.style.borderRadius = "6px";
                            iframe.srcdoc = htmlBase;

                            els.previewArea.appendChild(iframe);

                            // Wait for iframe to load, then execute user code
                            iframe.onload = async () => {
                                try {
                                    iframe.contentWindow.eval(code);
                                    addLog("[SUCCESS] DOM manipulation executed!", "success");
                                    await syncTaskProgress(task, true, "DOM execution successful.");
                                    handleSuccess(task);
                                } catch (error) {
                                    const errorDiv = iframe.contentDocument.getElementById('error');
                                    if (errorDiv) {
                                        errorDiv.style.display = 'block';
                                        errorDiv.innerHTML = `<b>‚ùå Error:</b><br/>${error.message}`;
                                    }
                                    addLog(`[ERROR] ${error.message}`, "error");
                                    await syncTaskProgress(task, false, error.message || "DOM execution failed");
                                    handleFailure(task);
                                }
                            };

                            scrollToBottom();
                            return;
                        }

                        if ((fileExt === ".js" || (!fileExt && lang === "javascript")) && !code.includes("require(") && !code.includes("app.listen") && !title.includes("server")) {
                            addLog("[JS] Running in browser context...", "success");
                            try {
                                const iframe = document.createElement("iframe");
                                iframe.style.display = "none";
                                document.body.appendChild(iframe);

                                let output = [];
                                iframe.contentWindow.console.log = (...args) => output.push(args.join(' '));

                                try {
                                    iframe.contentWindow.eval(code);
                                } catch (e) {
                                    output.push("Error: " + e.message);
                                }

                                if (output.length > 0) addLog(output.join('\n'), "log");
                                else addLog("(Code ran with no console output)", "warning");

                                document.body.removeChild(iframe);
                                await syncTaskProgress(task, true, "Browser JS execution completed.");
                                handleSuccess(task);
                            } catch (err) {
                                addLog(err.message, "error");
                            }
                            return;
                        }

                        if (!hasListen && (task.type === 'route' || title.includes("route") || title.includes("api"))) {
                            const match = code.match(/app\.(get|post)\(['"]([^'"]+)['"]/);
                            const method = match ? match[1].toUpperCase() : "GET";
                            const url = match ? match[2] : "/";

                            addLog(`[INFO] Route defined: ${method} ${url}`, "log");
                            addLog(`[ACTION REQUIRED] Click "Simulate Request" below to test this API.`, "warning");

                            const btnId = `simBtn_${Date.now()}`;
                            const html = `
                    <div style="margin-top:10px;">
                        <button id="${btnId}" class="action-btn" onclick="triggerRouteAction('${method}', '${url}')">
                            <i class="fas fa-play"></i> Simulate Request
                        </button>
                    </div>
                 `;
                            els.termLog.innerHTML += html;
                        }
                        // ‚úÖ FIX: Removed confusing "data structure detected" logic for JSON tasks
                        else if (task.language === 'java' || task.language === 'python') {
                            addLog(`[ACTION REQUIRED] Type 'run <input>' or 'python/java filename <input>' to execute.`, "warning");
                            els.termInput.focus();
                        }
                        else {
                            addLog(`[ACTION REQUIRED] Type 'node ${state.fileName}' below to run.`, "warning");
                            els.termInput.focus();
                        }
                    } else {
                        state.isLogicValid = false;
                        addLog(`[ERROR] Logic Check Failed:\n${analysis.message}`, "error");
                        handleFailure(task);
                    }
                }, 500);
            }

            // üî• MASTER VALIDATOR - Routes to Language-Specific Logic
            function validateTask(code, task) {
                const validationType = task.validation?.type;
                
                switch(validationType) {
                    case "html":
                        return validateHTML(code, task.validation.rules || {});
                    case "css":
                        return validateCSS(code, task.validation.rules || {});
                    case "react":
                    case "jsx":
                        return validateReact(code, task.validation.rules || {});
                    case "node":
                    case "javascript":
                        return validateNode(code, task.validation.rules || {});
                    case "json":
                    case "mongodb":
                        return validateJSON(code, task.validation.rules || {});
                    case "java":
                        return validateJava(code, task.validation.rules || {});
                    case "python":
                        return validatePython(code, task.validation.rules || {});
                    default:
                        // Fallback: regex pattern matching for legacy tasks
                        let missing = [];
                        const patterns = task.validation?.patterns || [];
                        patterns.forEach(p => {
                            if (!new RegExp(p, 'i').test(code)) missing.push(p);
                        });
                        if (missing.length > 0) return { passed: false, message: "Missing concepts: " + missing.join(", ") };
                        return { passed: true, message: "OK" };
                }
            }

            // üî• HTML VALIDATOR
            function validateHTML(code, rules) {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(code, "text/html");

                    // Check for parsing errors
                    if (doc.body.textContent.includes("OpenTag")) {
                        return { passed: false, message: "HTML parsing error. Check syntax." };
                    }

                    if (rules.requireBody && !doc.querySelector("body")) {
                        return { passed: false, message: "Missing <body> tag." };
                    }

                    if (rules.requiredTags && Array.isArray(rules.requiredTags)) {
                        for (let tag of rules.requiredTags) {
                            if (!doc.querySelector(tag)) {
                                return { passed: false, message: `Missing required <${tag}> tag.` };
                            }
                        }
                    }

                    if (rules.minListItems && code.match(/<li/gi)) {
                        const liCount = code.match(/<li/gi).length;
                        if (liCount < rules.minListItems) {
                            return { passed: false, message: `Need at least ${rules.minListItems} <li> items. Found: ${liCount}` };
                        }
                    }

                    if (rules.requireList && !code.match(/<ul|<ol/i)) {
                        return { passed: false, message: "Missing list structure (<ul> or <ol>)." };
                    }

                    return { passed: true, message: "Valid HTML structure." };

                } catch (e) {
                    return { passed: false, message: `HTML validation error: ${e.message}` };
                }
            }

            // üî• CSS VALIDATOR
            function validateCSS(code, rules) {
                if (rules.requireSelector && !code.match(/^[.\#]?[\w-]+\s*\{/m)) {
                    return { passed: false, message: "Missing CSS selector." };
                }

                if (rules.requiredProperties && Array.isArray(rules.requiredProperties)) {
                    for (let prop of rules.requiredProperties) {
                        const regex = new RegExp(`${prop}\\s*:`, 'i');
                        if (!regex.test(code)) {
                            return { passed: false, message: `Missing CSS property: ${prop}` };
                        }
                    }
                }

                if (rules.requireMedia && !code.match(/@media/i)) {
                    return { passed: false, message: "Missing @media query for responsive design." };
                }

                return { passed: true, message: "Valid CSS rules." };
            }

            // üî• REACT VALIDATOR
            function validateReact(code, rules) {
                if (rules.requireComponent && !code.match(/function\s+[A-Z]\w*|const\s+[A-Z]\w*\s*=/)) {
                    return { passed: false, message: "Missing React functional component." };
                }

                if (rules.requireReturn && !code.includes("return")) {
                    return { passed: false, message: "Component must have a return statement." };
                }

                if (rules.requireJSX && !code.match(/<[A-Za-z]/)) {
                    return { passed: false, message: "JSX markup not found." };
                }

                if (rules.requireHooks && Array.isArray(rules.requireHooks)) {
                    for (let hook of rules.requireHooks) {
                        const hookRegex = new RegExp(`${hook}\\s*\\(`, 'i');
                        if (!hookRegex.test(code)) {
                            return { passed: false, message: `Missing required Hook: ${hook}` };
                        }
                    }
                }

                if (rules.requireState && !code.match(/useState|useReducer/)) {
                    return { passed: false, message: "Component must manage state (useState or useReducer)." };
                }

                return { passed: true, message: "Valid React component." };
            }

            // üî• NODE.JS VALIDATOR
            function validateNode(code, rules) {
                if (rules.requireExpress && !code.match(/require.*express|import.*express/i)) {
                    return { passed: false, message: "Must use Express.js framework." };
                }

                if (rules.requireRoute && !code.match(/app\.(get|post|put|delete)\s*\(/i)) {
                    return { passed: false, message: "Missing route handler (app.get, app.post, etc)." };
                }

                if (rules.requireServer && !code.match(/app\.listen|server\.listen/i)) {
                    return { passed: false, message: "Missing server listener (app.listen)." };
                }

                if (rules.requirePort && !code.match(/\d{4}|process\.env\.PORT/)) {
                    return { passed: false, message: "Missing port number." };
                }

                if (rules.requireMiddleware && !code.match(/app\.use|middleware/i)) {
                    return { passed: false, message: "Missing middleware setup." };
                }

                return { passed: true, message: "Valid Node.js code." };
            }

            // üî• JSON VALIDATOR (MongoDB Documents)
            function validateJSON(code, rules) {
                try {
                    const obj = JSON.parse(code);

                    if (rules.mustBeObject && typeof obj !== "object") {
                        return { passed: false, message: "Must be a valid JSON object." };
                    }

                    if (rules.cannotBeArray && Array.isArray(obj)) {
                        return { passed: false, message: "Cannot be an array. Must be a single object." };
                    }

                    if (rules.requiredFields && Array.isArray(rules.requiredFields)) {
                        for (let field of rules.requiredFields) {
                            if (!(field in obj)) {
                                return { passed: false, message: `Missing required field: ${field}` };
                            }
                        }
                    }

                    if (rules.minFields && Object.keys(obj).length < rules.minFields) {
                        return { passed: false, message: `Object must have at least ${rules.minFields} fields.` };
                    }

                    return { passed: true, message: "Valid JSON document." };

                } catch (e) {
                    return { passed: false, message: `JSON parsing error: ${e.message}` };
                }
            }

            // üî• JAVA VALIDATOR
            function validateJava(code, rules) {
                if (rules.requireClass && !code.match(/public\s+class\s+\w+/i)) {
                    return { passed: false, message: "Missing public class declaration." };
                }

                if (rules.requireMain && !code.match(/public\s+static\s+void\s+main\s*\(/i)) {
                    return { passed: false, message: "Missing main method." };
                }

                if (rules.requirePackage && !code.match(/package\s+[\w.]+\s*;/)) {
                    return { passed: false, message: "Missing package declaration." };
                }

                if (rules.requiredMethods && Array.isArray(rules.requiredMethods)) {
                    for (let method of rules.requiredMethods) {
                        const methodRegex = new RegExp(`(public|private)\\s+(static\\s+)?\\w+\\s+${method}\\s*\\(`, 'i');
                        if (!methodRegex.test(code)) {
                            return { passed: false, message: `Missing required method: ${method}` };
                        }
                    }
                }

                return { passed: true, message: "Valid Java code." };
            }

            // üî• PYTHON VALIDATOR
            function validatePython(code, rules) {
                if (rules.requireFunction && !code.match(/def\s+\w+\s*\(/)) {
                    return { passed: false, message: "Missing function definition." };
                }

                if (rules.requireClass && !code.match(/class\s+\w+/)) {
                    return { passed: false, message: "Missing class definition." };
                }

                if (rules.requiredFunctions && Array.isArray(rules.requiredFunctions)) {
                    for (let func of rules.requiredFunctions) {
                        const funcRegex = new RegExp(`def\\s+${func}\\s*\\(`);
                        if (!funcRegex.test(code)) {
                            return { passed: false, message: `Missing required function: ${func}` };
                        }
                    }
                }

                if (rules.requireImport && !code.match(/import\s+\w+|from\s+\w+\s+import/)) {
                    return { passed: false, message: "Missing import statement." };
                }

                // Check indentation (basic)
                const lines = code.split('\n');
                for (let line of lines) {
                    if (line.match(/^\s+/) && !line.match(/^\s{4}|\s{8}/)) {
                        return { passed: false, message: "Incorrect indentation. Use 4-space indents." };
                    }
                }

                return { passed: true, message: "Valid Python code." };
            }

            // --- ACTION HANDLERS (Step 2) ---

            window.triggerRouteAction = (method, url) => {
                const btn = event.target.closest('button');
                if (btn) { btn.disabled = true; btn.innerHTML = `<i class="fas fa-check"></i> Request Sent`; }

                const task = state.steps[state.idx].data;
                const code = state.editorInstance.getValue();

                let json;
                let status = "200 OK";

                if (method === "POST") {
                    status = "201 Created";
                    json = JSON.stringify({
                        id: 1,
                        name: "New Product",
                        price: 500,
                        category: "Demo",
                        createdAt: new Date().toISOString()
                    }, null, 2);
                } else {
                    json = extractJsonFromCode(code);
                }

                addApiPreview(method, url, json, status);
                syncTaskProgress(task, true, "Route simulation completed.");
                handleSuccess(task);
            };

            window.triggerDataAction = async () => {
                const btn = event.target.closest('button');
                if (btn) { btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Saving...`; }

                const task = state.steps[state.idx].data;
                const code = state.editorInstance.getValue();

                if (!state.mockMode && (task.type === 'mongodb' || task.title.toLowerCase().includes('mongo'))) {
                    try {
                        const res = await fetch("/api/task/submit", {
                            method: "POST", headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ userId: state.userId, lessonId: state.lessonId, taskId: task._id, code: code })
                        });
                        const data = await res.json();

                        if (data.passed) {
                            addLog(data.output, "success");
                            handleSuccess(task);
                        } else {
                            addLog(data.output, "error");
                            handleFailure(task);
                        }
                    } catch (e) {
                        addLog("Network Error: " + e.message, "error");
                    }
                    return;
                }

                const start = code.indexOf('{');
                const content = extractBalancedBlock(code, start);
                const html = `
        <div class="api-preview">
            <div class="api-header">
                <div><span class="method-badge" style="background:var(--accent)">DATA</span> Object Preview</div>
                <div style="color:var(--success); font-weight:bold;">Valid</div>
            </div>
            <div class="api-body" style="white-space: pre-wrap;">${content || "{}"}</div>
        </div>
    `;
                els.termLog.innerHTML += html;
                scrollToBottom();
                await syncTaskProgress(task, true, "Data preview validated.");
                handleSuccess(task);
            };

            function setupTerminalInput() {
                els.termInput.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") {
                        const cmd = els.termInput.value.trim();
                        if (!cmd) return;
                        state.cmdHistory.push(cmd);
                        state.cmdHistoryIdx = state.cmdHistory.length;
                        els.termInput.value = "";
                        addLog(`user@mindstep:~$ ${cmd}`, "log");
                        processCommand(cmd);
                    } else if (e.key === "ArrowUp") {
                        e.preventDefault();
                        if (state.cmdHistoryIdx > 0) {
                            state.cmdHistoryIdx--;
                            els.termInput.value = state.cmdHistory[state.cmdHistoryIdx];
                        }
                    } else if (e.key === "ArrowDown") {
                        e.preventDefault();
                        if (state.cmdHistoryIdx < state.cmdHistory.length - 1) {
                            state.cmdHistoryIdx++;
                            els.termInput.value = state.cmdHistory[state.cmdHistoryIdx];
                        } else {
                            state.cmdHistoryIdx = state.cmdHistory.length;
                            els.termInput.value = "";
                        }
                    }
                });
            }


            function processCommand(cmd) {
                const parts = cmd.trim().split(/\s+/).filter(Boolean);
                const task = state.steps[state.idx].data;
                const code = state.editorInstance.getValue();
                const hasListen = code.includes("app.listen");
                const stdinText = parts.slice(1).join(" ");

                if (state.isReviewMode) {
                    addLog("[INFO] Practice mode is enabled. Runs are allowed; DB updates are skipped.", "warning");
                }

                // üî• FIX: Block Terminal for MongoDB JSON tasks
                if (task.type === "mongodb" && task.language === "json") {
                    addLog("[INFO] MongoDB JSON tasks do not support execution.", "warning");
                    addLog("Click 'Check Logic' to validate the document structure.", "log");
                    return;
                }

                if (!hasListen && task.type !== 'server' && task.language === 'javascript') {
                    addLog(`[TIP] This is a Route task. Please click the "Simulate Request" button instead of running the server manually.`, "warning");
                    return;
                }

                const validCmds = ["node", "python", "java", "javac", "run"];
                if (!validCmds.includes(parts[0])) {
                    addLog(`[ERROR] bash: ${parts[0]}: command not found`, "error");
                    addLog("Try: node <file>, python <file> <input>, java <file> <input>, or run <input>", "warning");
                    return;
                }

                if (!state.isLogicValid) {
                    addLog(`[ERROR] Logic errors detected. Click 'Check Logic' first.`, "error");
                    return;
                }

                const looksInteractive = /(?:\binput\s*\(|\bScanner\s*\(|System\.console\s*\(|BufferedReader\s*\()/i.test(code);
                const cmdUsesRuntime = ["run", "python", "java"].includes(parts[0]);
                if (looksInteractive && cmdUsesRuntime && !stdinText) {
                    addLog(`[WARNING] This program expects input. Use 'run <input>' (example: run 2).`, "warning");
                    return;
                }

                addLog(`[INFO] Executing ${state.fileName}...`, "log");

                if (parts[0] === 'node' && hasListen) {
                    setTimeout(() => {
                        const portMatch = code.match(/app\.listen\(\s*(\d+)/);
                        const port = portMatch ? portMatch[1] : "3000";
                        addLog(`[SUCCESS] Server running on port ${port}`, "success");
                        syncTaskProgress(task, true, "Server start simulated.");
                        handleSuccess(task);
                    }, 800);
                    return;
                }

                if (!state.mockMode) {
                    fetch("/api/task/submit", {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            userId: state.userId,
                            lessonId: state.lessonId,
                            taskId: task._id,
                            code: code,
                            input: stdinText
                        })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.passed) {
                                addLog(data.output, "success");
                                handleSuccess(task);
                            } else {
                                addLog(data.output, "error");
                                handleFailure(task);
                            }
                        })
                        .catch(e => addLog("Execution Error: " + e.message, "error"));
                } else {
                    addLog("[MOCK] Execution success.", "success");
                    handleSuccess(task);
                }
            }

            function extractJsonFromCode(code) {
                const cleanCode = code.replace(/\/\/.*$/gm, '').replace(/\/\*[\s\S]*?\*\//g, '');
                const textMatch = cleanCode.match(/res\.send\s*\(\s*(['"`])([\s\S]*?)\1\s*\)/);
                if (textMatch) return textMatch[2];
                const jsonStartIndex = cleanCode.search(/res(?:\.status\(\s*\d+\s*\))?\.json\s*\(\s*[\[\{]/);
                if (jsonStartIndex !== -1) {
                    const start = cleanCode.indexOf('(', jsonStartIndex) + 1;
                    const content = extractBalancedBlock(cleanCode, start);
                    if (content) return content;
                }
                const varMatch = cleanCode.match(/res(?:\.status\(\s*\d+\s*\))?\.json\s*\(\s*([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\)/);
                if (varMatch && varMatch[1]) {
                    const varName = varMatch[1];
                    const defRegex = new RegExp(`(?:const|let|var)\\s+${varName}\\s*=\\s*`, 'g');
                    const defMatch = defRegex.exec(cleanCode);
                    if (defMatch) {
                        const valueStartIndex = defMatch.index + defMatch[0].length;
                        const content = extractBalancedBlock(cleanCode, valueStartIndex);
                        if (content) return content;
                    }
                    return `[INFO] Response uses variable '${varName}'.\nSimulating resolved output:\n[ { "id": 1, "data": "Sample" } ]`;
                }
                return "{ \"status\": \"success\" }";
            }

            function extractBalancedBlock(code, startIndex) {
                let open = 0;
                let startFound = false;
                let blockStart = -1;
                for (let i = startIndex; i < code.length; i++) {
                    const char = code[i];
                    if (!startFound) {
                        if (/\s/.test(char)) continue;
                        if (char === '[' || char === '{') {
                            startFound = true;
                            blockStart = i;
                            open++;
                        } else {
                            return null;
                        }
                    } else {
                        if (char === '[' || char === '{') open++;
                        if (char === ']' || char === '}') open--;
                        if (open === 0) return code.substring(blockStart, i + 1);
                    }
                }
                return null;
            }

            function addApiPreview(method, url, body, status = "200 OK") {
                const html = `<div class="api-preview"><div class="api-header"><div><span class="method-badge">${method}</span> <span style="color:#a1a1aa">${url}</span></div><div style="color:var(--success); font-weight:bold;">${status}</div></div><div class="api-body" style="white-space: pre-wrap;">${body}</div></div>`;
                els.termLog.innerHTML += html;
                scrollToBottom();
            }

            function handleSuccess(task) {
                if (state.passed.has(task._id)) return;
                state.passed.add(task._id);
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                setSuccessBtn();
                updateXP(25, false); // ‚úÖ FIX: Visual only XP

                // ‚úÖ FIX: Removed duplicate fetch() here since it's handled in runCode/processCommand
            }

            function handleFailure(task) {
                els.runBtn.disabled = false;
                els.runBtn.innerHTML = `Check Logic <i class="fas fa-check-circle"></i>`;
                state.failCounts[task._id] = (state.failCounts[task._id] || 0) + 1;

                // ‚úÖ ADD: Retry Tracker
                if (state.failCounts[task._id] === 1) {
                    showToast("Try again. Hint unlocks after next fail.", "warning");
                }
                if (state.failCounts[task._id] >= 2) {
                    els.hintBox.style.display = 'block';
                    els.hintText.innerHTML = (task.validation && task.validation.hints && task.validation.hints[0]) || "Check the requirements.";
                }
            }

            function setSuccessBtn() {
                els.runBtn.disabled = false;
                els.runBtn.className = "btn btn-next";
                els.runBtn.innerHTML = `Next Task <i class="fas fa-arrow-right"></i>`;
                els.runBtn.onclick = () => renderStep(state.idx + 1);
            }

            function updateXP(amount = 0, persist = true) {
                if (amount > 0) {
                    state.xp += amount;
                    if (persist) localStorage.setItem("mindstep_xp", state.xp);
                }
                const lvl = Math.floor(state.xp / 100) + 1;
                els.xpBar.style.width = `${state.xp % 100}%`;
                els.xpText.innerText = `${state.xp} XP`;
                els.lvlDisplay.innerText = `LVL ${lvl}`;
            }

            function finishLesson() {
                document.querySelector(".footer").style.display = 'none';
                els.terminalArea.style.display = 'none';
                els.ws.style.gridTemplateColumns = "1fr";
                els.ws.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; text-align:center;"><i class="fas fa-trophy" style="font-size:5rem; color:var(--warning); margin-bottom:20px;"></i><h1 style="color:#fff;">Module Completed</h1><button class="btn btn-run" onclick="window.history.back()">Return</button></div>`;
                updateXP(50, false); // Visual only
                confetti({ particleCount: 300, spread: 100, origin: { y: 0.6 } });
                if (!state.mockMode && !state.isReviewMode) {
                    fetch("/api/complete", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ userId: state.userId, lessonId: state.lessonId })
                    });
                }

                // ‚úÖ POLISH 2: Reset Resume Point
                localStorage.removeItem(`lastStep_${state.lessonId}`);
            }

            // ADDED: Issue modal open/close handlers
            function openIssueModal() {
                if (!els.issueModal) return;
                if (!state.userId || state.userId === "guest") {
                    showToast("Please login to report an issue.", "warning");
                    return;
                }
                if (!state.courseId || !state.lessonId) {
                    showToast("Missing course or lesson context.", "warning");
                    return;
                }
                els.issueModal.classList.add("active");
            }

            function closeIssueModal() {
                if (!els.issueModal) return;
                els.issueModal.classList.remove("active");
                if (els.issueForm) els.issueForm.reset();
            }

            // ADDED: Submit bug report to backend
            async function submitIssueForm(event) {
                event.preventDefault();

                const errorMessage = (els.issueErrorMessage?.value || "").trim();
                const description = (els.issueDescription?.value || "").trim();
                const screenshot = els.issueScreenshot?.files?.[0] || null;

                if (!errorMessage || !description) {
                    showToast("Error message and description are required.", "warning");
                    return;
                }

                if (screenshot && screenshot.size > 5 * 1024 * 1024) {
                    showToast("Screenshot must be 5MB or less.", "warning");
                    return;
                }

                const formData = new FormData();
                formData.append("userId", state.userId);
                formData.append("courseId", state.courseId);
                formData.append("lessonId", state.lessonId);
                formData.append("errorMessage", errorMessage);
                formData.append("description", description);
                if (screenshot) formData.append("screenshot", screenshot);

                const originalBtnHtml = els.issueSubmitBtn.innerHTML;
                els.issueSubmitBtn.disabled = true;
                els.issueSubmitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Submitting`;

                try {
                    const response = await fetch("/api/issues", {
                        method: "POST",
                        body: formData
                    });
                    const data = await response.json();
                    if (!response.ok || !data.success) {
                        throw new Error(data.message || "Failed to submit issue");
                    }
                    showToast("Issue submitted successfully.", "success");
                    closeIssueModal();
                } catch (err) {
                    showToast(err.message || "Issue submission failed.", "warning");
                } finally {
                    els.issueSubmitBtn.disabled = false;
                    els.issueSubmitBtn.innerHTML = originalBtnHtml;
                }
            }

            if (els.issueForm) {
                els.issueForm.addEventListener("submit", submitIssueForm);
            }

            if (els.issueModal) {
                els.issueModal.addEventListener("click", (event) => {
                    if (event.target === els.issueModal) closeIssueModal();
                });
            }

            document.addEventListener("keydown", (event) => {
                if (event.key === "Escape" && els.issueModal?.classList.contains("active")) {
                    closeIssueModal();
                }
            });

            window.openIssueModal = openIssueModal;
            window.closeIssueModal = closeIssueModal;

            window.toggleTheme = () => { document.body.classList.toggle("theme-neon"); localStorage.setItem("theme", document.body.classList.contains("theme-neon") ? "neon" : "standard"); };
            window.copyCode = () => { navigator.clipboard.writeText(state.editorInstance.getValue()); showToast("Copied", "success"); };
            window.resetCode = () => { if (state.steps[state.idx].type === 'task') state.editorInstance.setValue(""); };
            function showToast(msg, type) { const t = document.getElementById("customToast"); t.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-triangle-exclamation'}" style="color:${type === 'success' ? 'var(--success)' : 'var(--error)'}"></i> ${msg}`; t.style.borderColor = type === 'success' ? 'var(--success)' : 'var(--error)'; t.style.transform = "translateX(0)"; setTimeout(() => t.style.transform = "translateX(150%)", 3000); }

            init();
        });
    </script>
</body>
</html>
