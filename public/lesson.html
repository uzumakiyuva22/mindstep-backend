<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MindStep â€” Lesson</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root { --primary-red:#ff2d55; --primary-blue:#0066ff; --cyan:#00e5ff; }
    body {
      font-family: Inter, sans-serif;
      background: linear-gradient(135deg,#030314,#06122a);
      color: #eaf6ff;
      min-height: 100vh;
      display:flex; flex-direction:column; align-items:center;
      padding:30px 20px;
    }
    h1 { font-family: Orbitron; text-shadow:0 0 12px var(--cyan); }

    button {
      padding:10px 24px; border:none; border-radius:10px;
      font-weight:700;
      background:linear-gradient(90deg,var(--primary-red),var(--primary-blue));
      color:#fff; cursor:pointer; transition:.3s; margin-top:10px;
    }
    button:hover { transform:scale(1.05); box-shadow:0 0 20px var(--cyan); }

    select,textarea {
      width:100%; margin-top:10px; padding:10px; border-radius:8px;
      border:none; background:#0e0f1a; color:#fff; font-family:monospace;
    }

    pre {
      background:#0c0d12; color:#00ffb7;
      padding:14px; border-radius:10px; white-space:pre-wrap;
      margin-top:10px; font-family:Consolas,monospace;
    }

    iframe {
      width:100%; height:300px; border:1px solid #333;
      border-radius:10px; background:#fff; margin-top:10px;
    }
    .container { max-width:800px; width:100%; }

    /* Popup box (Course Completed) */
    .popup {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.7);
      justify-content:center; align-items:center;
      z-index:1000;
    }
    .popup-content {
      background:#11182a; color:#eaf6ff; padding:30px 40px;
      border-radius:12px; text-align:center;
      box-shadow:0 0 25px var(--cyan);
    }
    .popup-content h2 {
      font-family: Orbitron; color:var(--cyan);
      text-shadow:0 0 10px var(--primary-blue);
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 id="lessonTitle">Lesson</h1>
    <p id="lessonDesc">Loading lesson...</p>

    <!-- Language selection -->
    <div id="langSelectArea">
      <label for="lang">Select Language:</label>
      <select id="lang">
        <option value="java">Java</option>
        <option value="python">Python</option>
        <option value="javascript">JavaScript</option>
        <option value="html">HTML</option>
        <option value="css">CSS</option>
      </select>
    </div>

    <!-- Code area -->
    <textarea id="code" rows="12"></textarea>

    <button id="runBtn">Run Code</button>
    <pre id="output">Ready.</pre>
    <iframe id="preview" style="display:none;"></iframe>

    <!-- Mark Complete -->
    <button id="completeBtn">âœ… Mark Complete</button>
  </div>

  <!-- Final Popup -->
  <div class="popup" id="popupBox">
    <div class="popup-content">
      <h2>ðŸŽ‰ Course Completed!</h2>
      <p>You have finished all lessons in this course.</p>
      <button id="closePopup">Close & Return to Main Page</button>
    </div>
  </div>

  <script>
// === MindStep Lesson.js â€” FINAL 100% WORKING VERSION ===
document.addEventListener("DOMContentLoaded", () => {

  // ---------------- URL PARAMS ----------------
  const params = new URLSearchParams(location.search);
  const lessonId = params.get("lessonId");
  const courseSlug = params.get("course");

  if (!lessonId || !courseSlug) {
    alert("Invalid lesson link!");
    return location.href = "MainPage.html";
  }

  // ---------------- USER CHECK ----------------
  const user = JSON.parse(localStorage.getItem("mindstep_user") || "null");
  if (!user) {
    alert("Please login!");
    return location.href = "LoginPage.html";
  }
  const userId = user._id;

  // ---------------- UI ELEMENTS ----------------
  const titleEl = document.getElementById("lessonTitle");
  const descEl  = document.getElementById("lessonDesc");
  const popup = document.getElementById("popupBox");
  const closePopup = document.getElementById("closePopup");

  let taskContainer = document.getElementById("tasks");
  if (!taskContainer) {
    taskContainer = document.createElement("div");
    taskContainer.id = "tasks";
    document.querySelector(".container").appendChild(taskContainer);
  }

  // ---------------- LOAD LESSON DETAILS ----------------
  async function loadLesson() {
    try {
      const res = await fetch(`/api/lesson/${lessonId}/details`);
      const data = await res.json();

      if (!data.success) {
        titleEl.textContent = "Failed to load lesson";
        return;
      }

      const lesson = data.lesson;
      const tasks = data.tasks;

      titleEl.textContent = lesson.title;
      descEl.textContent = lesson.content || "";

      renderTasks(tasks);
      updateProgress();

    } catch (err) {
      console.error("Lesson load error:", err);
    }
  }

  // ---------------- RENDER TASKS ----------------
  function renderTasks(tasks) {
    taskContainer.innerHTML = "";

    tasks.forEach((task, index) => {
      const block = document.createElement("div");
      block.style = `
        padding:16px;
        margin-top:20px;
        background:rgba(255,255,255,0.05);
        border-radius:12px;
      `;

      block.innerHTML = `
        <h3 style="font-family:Orbitron;">Task ${index + 1}: ${task.title}</h3>
        <p style="opacity:.85;">${task.description || ""}</p>

        <textarea id="code_${task._id}"
          style="width:100%;height:140px;padding:10px;margin-top:8px;
          background:#05070f;color:#eaf6ff;border-radius:10px;">
${task.starterCode || ""}
        </textarea>

        <button class="runTaskBtn" data-id="${task._id}"
          style="margin-top:12px;padding:10px 18px;border:none;border-radius:10px;
          background:linear-gradient(90deg,#ff2d55,#0066ff);color:white;cursor:pointer;">
          â–¶ Run Task
        </button>

        <pre id="out_${task._id}"
          style="margin-top:10px;background:#000;padding:12px;border-radius:10px;
          color:#00ffb7;">Output will appear here...</pre>
      `;

      taskContainer.appendChild(block);
    });

    attachTaskLogic(tasks);
  }

  // ---------------- ATTACH LOGIC ====================
  function attachTaskLogic(tasks) {
    taskContainer.addEventListener("click", async (e) => {
      const btn = e.target.closest(".runTaskBtn");
      if (!btn) return;

      const taskId = btn.dataset.id;
      const task = tasks.find(t => t._id === taskId);
      const code = document.getElementById(`code_${taskId}`).value;
      const outBox = document.getElementById(`out_${taskId}`);

      // ---------------- HTML / CSS preview ----------------
      if (task.language === "html" || task.language === "css") {
        const iframe = document.getElementById("preview");
        iframe.style.display = "block";
        iframe.srcdoc = code;
        outBox.textContent = "Preview updated âœ”";
        await submitCompletion(taskId, "preview");
        updateProgress();
        return;
      }

      // ---------------- RUN CODE BACKEND ----------------
      outBox.textContent = "Running...";

      let output = "";
      try {
        const res = await fetch("/api/task/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            language: task.language,
            code: code
          })
        });

        const json = await res.json();
        output = json.output || "";
        outBox.textContent = `Output:\n${output}`;
      } catch (err) {
        outBox.textContent = "Runner Error: " + err.message;
        return;
      }

      // ---------------- CHECK ANSWER ----------------
      const passed = await submitCompletion(taskId, output);

      outBox.textContent += `\n\nResult: ${passed ? "âœ” Correct" : "âŒ Incorrect"}`;

      if (passed) updateProgress();
    });
  }

  // ---------------- SUBMIT COMPLETION (RUN + CHECK) ----------------
  async function submitCompletion(taskId, output) {
    try {
      const res = await fetch("/api/task/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId,
          taskId,
          lessonId,
          courseSlug,
          output
        })
      });

      const data = await res.json();
      return data.passed || false;
    } catch (err) {
      console.error("Submit error:", err);
      return false;
    }
  }

  // ---------------- UPDATE PROGRESS ----------------
  async function updateProgress() {
    try {
      const res = await fetch(`/api/course/${courseSlug}/progress/${userId}`);
      const data = await res.json();

      if (data.percent === 100) {
        popup.style.display = "flex";
      }

    } catch (err) {
      console.warn("Progress error:", err);
    }
  }

  closePopup.onclick = () => {
    popup.style.display = "none";
    location.href = "MainPage.html";
  };

  // ---------------- INIT ----------------
  loadLesson();
});

  </script>
</body>
</html>
