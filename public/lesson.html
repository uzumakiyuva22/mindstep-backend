<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>MindStep â€” Quantum IDE</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

  <style>
    /* --- CORE THEME --- */
    :root {
      --bg-root: #09090b;
      --bg-sidebar: #121214;
      --bg-editor: #1e1e1e;
      --bg-terminal: #0c0c0c;
      --border: #27272a;
      
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --accent: #38bdf8;
      
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
      --text: #e4e4e7;
      --text-dim: #a1a1aa;
      
      --font-main: 'Plus Jakarta Sans', sans-serif;
      --font-code: 'JetBrains Mono', monospace;
    }

    body.theme-neon {
      --bg-root: #0b0014;
      --bg-sidebar: #130024;
      --bg-editor: #1a0b2e;
      --bg-terminal: #05010a;
      --border: #3c1f5e;
      --primary: #d946ef;
      --accent: #22d3ee;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

    body {
      background-color: var(--bg-root);
      color: var(--text);
      font-family: var(--font-main);
      height: 100vh;
      display: flex; flex-direction: column; overflow: hidden;
    }

    /* NAVBAR */
    .navbar {
      height: 60px; flex-shrink: 0;
      background: var(--bg-sidebar); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 25px; z-index: 50;
    }
    .brand {
      font-weight: 800; font-size: 1.2rem; color: var(--text);
      text-decoration: none; display: flex; align-items: center; gap: 12px;
    }
    .brand i { color: var(--primary); font-size: 1.4rem; filter: drop-shadow(0 0 10px rgba(99,102,241,0.5)); }

    /* XP System */
    .xp-container {
      display: flex; align-items: center; gap: 15px;
      background: rgba(255,255,255,0.03); padding: 5px 15px; border-radius: 20px;
      border: 1px solid var(--border);
    }
    .level-badge { font-size: 0.8rem; font-weight: 700; color: var(--accent); }
    .xp-bar-wrapper { width: 100px; height: 6px; background: #27272a; border-radius: 3px; overflow: hidden; }
    .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; transition: width 0.5s ease; }
    .xp-text { font-size: 0.75rem; color: var(--text-dim); font-family: var(--font-code); }

    /* WORKSPACE */
    .workspace {
      flex: 1; display: grid; overflow: hidden;
      transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
    }
    .workspace.mode-reading { grid-template-columns: 1fr 0px; }
    .workspace.mode-coding { grid-template-columns: 35% 65%; }

    /* Left Panel */
    .guide-panel {
      background: var(--bg-sidebar); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden; position: relative;
    }
    .guide-content { padding: 30px; overflow-y: auto; flex: 1; scroll-behavior: smooth; }
    .guide-content h1 { font-size: 1.8rem; margin-bottom: 20px; color: var(--text); }
    .guide-content p { line-height: 1.7; color: var(--text-dim); margin-bottom: 20px; }
    .guide-content code { background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; color: var(--accent); font-family: var(--font-code); }
    
    .badge { padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-bottom: 15px; display: inline-flex; align-items: center; gap: 6px; }
    .badge-theory { background: rgba(99, 102, 241, 0.1); color: var(--primary); border: 1px solid rgba(99,102,241,0.2); }
    .badge-task { background: rgba(56, 189, 248, 0.1); color: var(--accent); border: 1px solid rgba(56, 189, 248, 0.2); }

    .hint-box {
      margin-top: 20px; padding: 15px; border-radius: 8px; display: none;
      background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3);
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    /* Right Panel */
    .ide-panel {
      display: flex; flex-direction: column;
      background: var(--bg-editor); height: 100%; position: relative;
    }

    .toolbar {
      height: 40px; background: #27272a; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0;
    }
    .file-tab {
      background: var(--bg-editor); padding: 0 20px; height: 100%; border-top: 2px solid var(--primary);
      color: var(--text); font-family: var(--font-code); font-size: 0.85rem; display: flex; align-items: center; gap: 8px;
    }
    .icon-btn {
      background: transparent; border: none; color: var(--text-dim);
      cursor: pointer; width: 28px; height: 28px; border-radius: 6px; 
      display: grid; place-items: center; transition: 0.2s;
    }
    .icon-btn:hover { color: var(--text); background: rgba(255,255,255,0.1); }

    .editor-container { flex: 1; position: relative; overflow: hidden; min-height: 0; }
    #monaco-editor { width: 100%; height: 100%; }

    /* Terminal */
    .terminal {
      height: 40px; min-height: 40px; flex-shrink: 0; 
      background: var(--bg-terminal); border-top: 1px solid var(--border);
      display: flex; flex-direction: column; transition: height 0.3s cubic-bezier(0.25, 1, 0.5, 1);
      position: absolute; bottom: 0; width: 100%; z-index: 60;
    }
    .terminal.expanded { height: 85% !important; border-top: 2px solid var(--primary); box-shadow: 0 -10px 40px rgba(0,0,0,0.5); }

    .term-header {
      padding: 0 15px; height: 40px; background: #27272a;
      font-family: var(--font-main); font-size: 0.75rem; color: var(--text-dim);
      text-transform: uppercase; letter-spacing: 1px;
      display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; cursor: pointer;
    }
    .term-body {
      flex: 1; padding: 15px; 
      font-family: 'JetBrains Mono', monospace; font-size: 0.95rem; color: #fff;
      overflow-y: auto; white-space: pre-wrap; scroll-behavior: smooth;
    }
    .term-line { margin-bottom: 6px; display: flex; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
    .term-time { color: var(--text-dim); font-size: 0.8em; min-width: 60px; user-select: none; }
    .term-prompt { color: var(--success); font-weight: bold; }
    .web-preview { width: 100%; height: 100%; border:none; background:#fff; display:none; }

    /* Footer */
    .footer {
      height: 60px; flex-shrink: 0; background: var(--bg-sidebar); border-top: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; padding: 0 30px; z-index: 50;
    }
    .btn {
      padding: 10px 24px; border-radius: 8px; border: none; cursor: pointer;
      font-weight: 600; font-family: var(--font-main); display: flex; align-items: center; gap: 10px; transition: 0.2s;
    }
    .btn-secondary { background: transparent; color: var(--text-dim); border: 1px solid var(--border); }
    .btn-run { background: var(--primary); color: #fff; }
    .btn-next { background: var(--success); color: #000; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Progress & Lock */
    .progress-container { display: flex; gap: 6px; align-items: center; }
    .step-pill { width: 30px; height: 4px; background: #27272a; border-radius: 2px; cursor: pointer; transition: 0.3s; }
    .step-pill.active { background: var(--primary); width: 40px; box-shadow: 0 0 10px var(--primary); }
    .step-pill.completed { background: var(--success); }
    .step-pill.locked { opacity: 0.3; cursor: not-allowed; }

    #loadingOverlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: var(--bg-root); z-index: 100;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.5s;
    }
    #customToast {
      position: fixed; top: 80px; right: 30px; background: #27272a; 
      padding: 12px 20px; border-radius: 8px; display: flex; gap: 10px; 
      align-items: center; color: #fff; transform: translateX(150%); 
      transition: 0.3s; z-index: 200; box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
      border: 1px solid var(--border);
    }

    @media (max-width: 900px) {
      .workspace.mode-coding { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
      .guide-panel { max-height: 35vh; border-right: none; border-bottom: 1px solid var(--border); }
      .terminal { height: 220px; }
    }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <i class="fas fa-cube fa-spin fa-3x" style="color:var(--primary); margin-bottom:20px;"></i>
    <p style="color:var(--text-dim); font-family:var(--font-code);">INITIALIZING...</p>
  </div>

  <div id="customToast"></div>

  <nav class="navbar">
    <a href="#" class="brand" onclick="window.history.back()">
      <i class="fas fa-cube"></i> <span>MindStep</span>
    </a>
    <div style="display:flex; gap:20px; align-items:center;">
        <div class="xp-container">
            <span class="level-badge" id="levelDisplay">LVL 1</span>
            <div class="xp-bar-wrapper"><div class="xp-bar-fill" id="xpBar"></div></div>
            <span class="xp-text" id="xpText">0 XP</span>
        </div>
        <div class="progress-container" id="progressBar"></div>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="icon-btn" onclick="toggleTheme()" title="Switch Theme"><i class="fas fa-palette"></i></button>
        <div style="font-size:0.85rem; color:var(--text-dim); display:flex; gap:8px; align-items:center; background:#18181b; padding:6px 12px; border-radius:20px; border:1px solid var(--border);">
            <div style="width:6px; height:6px; background:var(--success); border-radius:50%;"></div> 
            <span id="saveStatus">Synced</span>
        </div>
    </div>
  </nav>

  <div class="workspace mode-reading" id="mainWorkspace" style="opacity:0;">
    
    <div class="guide-panel">
      <div class="guide-content" id="guideContent"></div>
      <div style="padding: 0 30px 30px 30px;">
          <div id="hintBox" class="hint-box">
              <div style="color:var(--warning); font-weight:700; margin-bottom:5px;"><i class="fas fa-lightbulb"></i> AI Hint</div>
              <div id="hintText" style="color:var(--text);"></div>
          </div>
      </div>
    </div>

    <div class="ide-panel">
      <div class="toolbar">
        <div class="file-tab">
          <i class="fas fa-code" id="langIcon" style="color:var(--primary);"></i> <span id="langName">SCRIPT</span>
        </div>
        <div class="toolbar-actions">
          <button class="icon-btn" onclick="copyCode()" title="Copy Code"><i class="far fa-copy"></i></button>
          <button class="icon-btn" onclick="resetCode()" title="Reset Code"><i class="fas fa-undo"></i></button>
        </div>
      </div>

      <div class="editor-container">
        <div id="monaco-editor"></div>
      </div>

      <div class="terminal" id="terminalArea">
        <div class="term-header" onclick="toggleTerminal()">
          <span><i class="fas fa-terminal" style="margin-right:8px; opacity:0.5;"></i> Console Output</span>
          <div style="display:flex; gap:10px;">
              <button class="icon-btn" style="width:auto; padding:0 10px; font-size:0.8rem;" onclick="event.stopPropagation(); toggleTerminal()">
                  <i class="fas fa-expand" id="termExpandIcon"></i> <span id="termExpandText">Expand</span>
              </button>
              <button class="icon-btn" onclick="event.stopPropagation(); clearTerminal()" title="Clear"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        <div class="term-body" id="termBody">
          <iframe id="webPreview" class="web-preview"></iframe>
          <div id="termOutput">
            <div style="color:var(--text-dim);">> Ready to code...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <button class="btn btn-secondary" id="prevBtn" disabled><i class="fas fa-arrow-left"></i> Previous</button>
    <div style="font-size:0.8rem; color:var(--text-dim); font-family:var(--font-code);">Ctrl + Enter to Run</div>
    <button class="btn btn-run" id="runBtn">Start Coding <i class="fas fa-arrow-right"></i></button>
  </div>

<script>
require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }});

document.addEventListener("DOMContentLoaded", () => {
  const state = {
    steps: [], idx: 0, userCode: {}, passed: new Set(),
    lessonId: new URLSearchParams(location.search).get("lesson"),
    userId: JSON.parse(localStorage.getItem("mindstep_user") || '{"_id":"guest"}')._id,
    defaults: {}, mockMode: false, failCounts: {},
    xp: parseInt(localStorage.getItem("mindstep_xp") || "0"),
    editorInstance: null
  };

  const els = {
    term: document.getElementById("termOutput"),
    termBody: document.getElementById("termBody"),
    terminalArea: document.getElementById("terminalArea"),
    termExpandIcon: document.getElementById("termExpandIcon"),
    termExpandText: document.getElementById("termExpandText"),
    runBtn: document.getElementById("runBtn"),
    prevBtn: document.getElementById("prevBtn"),
    guide: document.getElementById("guideContent"),
    ws: document.getElementById("mainWorkspace"),
    dots: document.getElementById("progressBar"),
    xpBar: document.getElementById("xpBar"),
    xpText: document.getElementById("xpText"),
    lvlDisplay: document.getElementById("levelDisplay"),
    hintBox: document.getElementById("hintBox"),
    hintText: document.getElementById("hintText"),
    webPreview: document.getElementById("webPreview")
  };

  // --- LISTEN FOR LOGS ---
  window.addEventListener('message', (e) => {
      if(e.data && e.data.t === 'log') {
          const time = new Date().toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
          els.term.innerHTML += `<div class="term-line"><span class="term-time">[${time}]</span> <span>${e.data.m}</span></div>`;
          scrollToBottom();
      }
  });

  window.toggleTerminal = (forceState) => {
      const isCurrentlyExpanded = els.terminalArea.classList.contains('expanded');
      const shouldExpand = forceState !== undefined ? forceState : !isCurrentlyExpanded;
      if(shouldExpand) {
          els.terminalArea.classList.add('expanded');
          els.termExpandIcon.className = "fas fa-compress";
          els.termExpandText.innerText = "Minimize";
          scrollToBottom();
      } else {
          els.terminalArea.classList.remove('expanded');
          els.termExpandIcon.className = "fas fa-expand";
          els.termExpandText.innerText = "Expand";
      }
  };

  window.clearTerminal = () => {
      els.term.innerHTML = `<div style="color:var(--text-dim);">> Console cleared.</div>`;
  };

  function scrollToBottom() {
      els.termBody.scrollTop = els.termBody.scrollHeight;
      requestAnimationFrame(() => els.termBody.scrollTop = els.termBody.scrollHeight);
  }

  function initMonaco() {
    return new Promise((resolve) => {
        require(['vs/editor/editor.main'], function () {
            state.editorInstance = monaco.editor.create(document.getElementById('monaco-editor'), {
                value: "", language: 'javascript', theme: 'vs-dark',
                fontSize: 15, fontFamily: "'JetBrains Mono', monospace",
                automaticLayout: true, minimap: { enabled: false },
                scrollBeyondLastLine: false, padding: { top: 16, bottom: 16 }
            });
            state.editorInstance.onDidChangeModelContent(() => {
                const code = state.editorInstance.getValue();
                const step = state.steps[state.idx];
                if(step && step.type === 'task') {
                    state.userCode[step.data._id] = code;
                    localStorage.setItem(`draft_${state.userId}_${step.data._id}`, code);
                }
                monaco.editor.setModelMarkers(state.editorInstance.getModel(), "owner", []);
            });
            state.editorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => els.runBtn.click());
            resolve();
        });
    });
  }

  async function init() {
    if(localStorage.getItem("theme") === "neon") document.body.classList.add("theme-neon");
    updateXP();
    await initMonaco();
    try {
      if(!state.lessonId) throw new Error("No ID");
      const res = await fetch(`/api/lesson/${state.lessonId}/details`);
      const data = await res.json();
      if(!data.success) throw new Error("API Fail");
      loadData(data);
    } catch(e) {
      state.mockMode = true; loadMockData();
    }
  }

  function loadMockData() {
    loadData({ lesson: { title: "Error", description: "Offline" }, tasks: [] });
  }

  function loadData(data) {
    state.steps = [];
    let theory = data.lesson.lesson || data.lesson || {};
    if(Array.isArray(theory)) theory = theory[0];
    state.steps.push({ 
        type: 'theory', 
        data: { title: theory.title || "Module", html: `<p>${theory.description || ""}</p>${(theory.deepExplanation||[]).map(p=>`<p>${p}</p>`).join("")}` } 
    });
    (data.tasks || []).forEach(t => {
        state.steps.push({ type: 'task', data: t });
        state.defaults[t._id] = t.starterCode || "";
        state.failCounts[t._id] = 0;
        const draft = localStorage.getItem(`draft_${state.userId}_${t._id}`);
        if (draft) state.userCode[t._id] = draft;
    });
    state.steps.push({ type: 'finish' });
    renderStep(0);
    document.getElementById("loadingOverlay").style.opacity = '0';
    setTimeout(()=>document.getElementById("loadingOverlay").style.display='none', 500);
    els.ws.style.opacity = '1';
  }

  window.renderStep = (i) => {
    if (i > 0 && state.steps[i-1].type === 'task' && !state.passed.has(state.steps[i-1].data._id)) {
        showToast("Complete previous task first!", "error"); return;
    }
    toggleTerminal(false);
    state.idx = i;
    const step = state.steps[i];
    
    els.dots.innerHTML = state.steps.map((s,idx) => {
        let status = idx===i?'active':(idx<i?'completed':'');
        let locked = (idx>0 && state.steps[idx-1].type==='task' && !state.passed.has(state.steps[idx-1].data._id));
        return `<div class="step-pill ${status} ${locked?'locked':''}" onclick="${!locked ? `renderStep(${idx})` : ''}"></div>`;
    }).join("");

    els.prevBtn.disabled = i === 0;
    els.prevBtn.onclick = () => renderStep(i-1);
    els.hintBox.style.display = 'none';

    if(step.type === 'theory') {
        els.ws.className = "workspace mode-reading";
        els.guide.innerHTML = `<div class="badge badge-theory"><i class="fas fa-book-open"></i> Theory</div><h1>${step.data.title}</h1><hr>${step.data.html}`;
        els.runBtn.innerHTML = `Start Coding <i class="fas fa-arrow-right"></i>`;
        els.runBtn.className = "btn btn-run";
        els.runBtn.onclick = () => renderStep(i+1);
        els.terminalArea.style.display = 'none';
    } 
    else if(step.type === 'task') {
        els.ws.className = "workspace mode-coding";
        els.terminalArea.style.display = 'flex';
        els.guide.innerHTML = `<div class="badge badge-task"><i class="fas fa-code"></i> Task ${i}</div><h1>${step.data.title}</h1><hr><p>${step.data.description}</p>`;
        
        const lang = (step.data.language || "javascript").toLowerCase();
        document.getElementById("langName").innerText = lang.toUpperCase();
        
        const isDomTask = /dom|select|html|element|event|listener|click/i.test(step.data.title);
        
        if(isDomTask) {
             monaco.editor.setModelLanguage(state.editorInstance.getModel(), "html");
             if(!state.userCode[step.data._id]) state.userCode[step.data._id] = state.defaults[step.data._id] || `\n<button id="btn">Click Me</button>\n\n<script>\n  // Script here\n<\/script>`;
        } else {
             monaco.editor.setModelLanguage(state.editorInstance.getModel(), lang==='text'?'plaintext':lang);
        }
        state.editorInstance.setValue(state.userCode[step.data._id] || state.defaults[step.data._id]);
        
        const isWeb = lang === 'html' || lang === 'css' || isDomTask;
        els.webPreview.style.display = isWeb ? 'block' : 'none';
        els.term.style.display = isWeb ? 'none' : 'block';

        if(state.passed.has(step.data._id)) setSuccessBtn();
        else {
            els.runBtn.innerHTML = `Run Code <i class="fas fa-play"></i>`;
            els.runBtn.className = "btn btn-run";
            els.runBtn.onclick = () => runCode(step.data);
        }
    }
    else if(step.type === 'finish') finishLesson();
  };

  async function runCode(task) {
    const code = state.editorInstance.getValue();
    if(!code.trim()) return showToast("Code is empty!", "error");

    toggleTerminal(true);
    els.term.innerHTML = ''; 

    // --- ðŸš€ FAKE CMD SIMULATION (AUTO-DETECTS SERVER TASK) ---
    const isServerTask = /server|express|port|listen/i.test(task.title + task.description);
    if (isServerTask) {
        await typeWriter("> npm init -y", 300);
        await typeWriter("> npm install express", 800);
        await typeWriter("> node server.js", 600);
    }

    const addLog = (msg, type='log') => {
        const time = new Date().toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
        els.term.innerHTML += `<div class="term-line"><span class="term-time">[${time}]</span> <span>${msg}</span></div>`;
        scrollToBottom();
    };

    let patternsPassed = true;
    if (task.validation && task.validation.patterns) {
        for (const pattern of task.validation.patterns) {
            if (!new RegExp(pattern, 'm').test(code)) {
                patternsPassed = false;
                addLog(`Error: Missing pattern '${pattern}'`, "error");
                handleFailure(task, "Logic Incorrect");
                return;
            }
        }
    }

    els.runBtn.disabled = true;
    els.runBtn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Processing...`;

    // DOM/HTML Task
    const isDomTask = /dom|select|html|element|event|listener|click/i.test(task.title);
    if (isDomTask) {
        const doc = els.webPreview.contentDocument || els.webPreview.contentWindow.document;
        doc.open();
        doc.write(`<script>const o=console.log;console.log=function(...a){window.parent.postMessage({t:'log',m:a.join(' ')},'*');o.apply(console,a)};<\/script>${code}`);
        doc.close();
        if (patternsPassed) {
            setTimeout(() => {
                handleResult({ passed: true, output: "Browser Event Verified." }, task);
                fetch("/api/task/submit", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({userId:state.userId, lessonId:state.lessonId, taskId:task._id, code:code}) });
            }, 800);
            return;
        }
    }

    // Server/Logic Task
    try {
        const res = await fetch("/api/task/submit", {
            method:"POST", headers:{"Content-Type":"application/json"},
            body:JSON.stringify({userId:state.userId, lessonId:state.lessonId, taskId:task._id, code:code})
        });
        const data = await res.json();
        
        // ðŸ”¥ SIMULATE SERVER START SUCCESS
        if (isServerTask && patternsPassed) {
             const link = `http://localhost:${Math.floor(Math.random() * 1000) + 3000}`;
             setTimeout(() => {
                 els.term.innerHTML += `<div class="term-line" style="color:var(--success); font-weight:bold; margin-top:10px;">> Server Started! <a href="#" style="color:var(--accent); text-decoration:underline;">${link}</a></div>`;
                 handleResult({ passed: true, output: "" }, task);
             }, 500);
             return; 
        }

        handleResult(data, task);
    } catch(e) {
        if(isServerTask && patternsPassed) {
             addLog("Server verified (Mock)", "system");
             handleResult({ passed: true, output: "Server Configured" }, task);
        } else {
             els.runBtn.disabled = false;
             els.runBtn.innerHTML = `Run Code <i class="fas fa-play"></i>`;
             addLog("Connection Failed: Backend unreachable", "error");
        }
    }
  }

  function typeWriter(text, delay) {
      return new Promise(resolve => {
          setTimeout(() => {
              els.term.innerHTML += `<div class="term-line"><span class="term-prompt">user@mindstep:~$</span> ${text}</div>`;
              scrollToBottom();
              resolve();
          }, delay);
      });
  }

  function handleResult(data, task) {
    if (data.output && !data.preview) {
        const style = data.passed ? 'color:#fff' : 'color:var(--error)';
        if(data.output.trim()) els.term.innerHTML += `<div style="${style}; margin-top:5px; white-space:pre-wrap;">${data.output}</div>`;
    }

    if(data.passed === true) {
        state.passed.add(task._id);
        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        setSuccessBtn();
        updateXP(25);
        showToast("Task Passed!", "success");
    } else {
        handleFailure(task, "Check output.");
    }
    scrollToBottom();
  }

  function handleFailure(task, msg) {
      els.runBtn.disabled = false;
      els.runBtn.innerHTML = `Run Code <i class="fas fa-play"></i>`;
      showToast(msg, "error");
      state.failCounts[task._id] = (state.failCounts[task._id] || 0) + 1;
      if(state.failCounts[task._id] >= 2) {
          els.hintBox.style.display = 'block';
          els.hintText.innerHTML = (task.validation && task.validation.hints && task.validation.hints[0]) || "Check syntax.";
      }
  }

  function setSuccessBtn() {
    els.runBtn.disabled = false;
    els.runBtn.className = "btn btn-next";
    els.runBtn.innerHTML = `Next Task <i class="fas fa-arrow-right"></i>`;
    els.runBtn.onclick = () => renderStep(state.idx+1);
  }

  function updateXP(amount=0) {
      if(amount > 0) { state.xp += amount; localStorage.setItem("mindstep_xp", state.xp); }
      const lvl = Math.floor(state.xp / 100) + 1;
      els.xpBar.style.width = `${state.xp % 100}%`;
      els.xpText.innerText = `${state.xp} XP`;
      els.lvlDisplay.innerText = `LVL ${lvl}`;
  }

  function finishLesson() {
    document.querySelector(".footer").style.display = 'none';
    els.terminalArea.style.display = 'none';
    els.ws.style.gridTemplateColumns = "1fr";
    els.ws.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; text-align:center;"><i class="fas fa-trophy" style="font-size:5rem; color:var(--warning); margin-bottom:20px;"></i><h1 style="color:#fff;">Module Completed</h1><button class="btn btn-run" onclick="window.history.back()">Return</button></div>`;
    updateXP(50);
    confetti({ particleCount: 300, spread: 100, origin: { y: 0.6 } });
    if(state.userId!=="guest" && !state.mockMode) fetch("/api/complete", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({userId:state.userId, lessonId:state.lessonId})});
  }

  window.toggleTheme = () => { document.body.classList.toggle("theme-neon"); localStorage.setItem("theme", document.body.classList.contains("theme-neon") ? "neon" : "standard"); };
  window.copyCode = () => { navigator.clipboard.writeText(state.editorInstance.getValue()); showToast("Copied", "success"); };
  window.resetCode = () => { if(state.steps[state.idx].type==='task') state.editorInstance.setValue(state.defaults[state.steps[state.idx].data._id] || ""); };
  
  function showToast(msg, type) { const t = document.getElementById("customToast"); t.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':'fa-triangle-exclamation'}" style="color:${type==='success'?'var(--success)':'var(--error)'}"></i> ${msg}`; t.style.borderColor = type==='success'?'var(--success)':'var(--error)'; t.style.transform = "translateX(0)"; setTimeout(()=>t.style.transform="translateX(150%)", 3000); }

  init();
});
</script>
</body>
</html>