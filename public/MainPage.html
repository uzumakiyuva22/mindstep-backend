<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
  <title>MindStep â€” Dashboard</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #33A1FD;
      --primary-glow: rgba(51, 161, 253, 0.4);
      --accent: #8A2BE2;
      --bg-dark: #030305;
      --glass-surface: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff;
      --text-muted: #94a3b8;
      
      --card-bg: rgba(20, 20, 25, 0.6);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

    body {
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-dark);
      /* Matching Login Page Background */
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(51, 161, 253, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 90% 80%, rgba(138, 43, 226, 0.08) 0%, transparent 50%);
      background-attachment: fixed;
      color: var(--text-main);
      overflow-x: hidden;
    }

    /* Noise Texture Overlay */
    .noise {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 0;
    }

    /* --- Navigation --- */
    nav {
      position: sticky; top: 0; z-index: 100;
      padding: 15px 40px;
      background: rgba(10, 10, 15, 0.85);
      backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border);
      display: flex; justify-content: space-between; align-items: center;
    }

    .brand {
      display: flex; align-items: center; gap: 10px;
    }
    .brand i { font-size: 1.5rem; color: var(--primary); filter: drop-shadow(0 0 10px var(--primary-glow)); }
    .brand span { font-family: 'Orbitron'; font-size: 1.2rem; font-weight: 800; letter-spacing: 1px; }

    .nav-items { display: flex; gap: 25px; }
    .nav-link { 
      color: var(--text-muted); text-decoration: none; font-size: 0.9rem; font-weight: 500; 
      transition: 0.3s; position: relative;
    }
    .nav-link:hover, .nav-link.active { color: #fff; text-shadow: 0 0 10px var(--primary-glow); }
    
    /* User Profile Chip */
    .user-chip {
      display: flex; align-items: center; gap: 12px;
      padding: 6px 12px 6px 6px;
      background: var(--glass-surface); border: 1px solid var(--glass-border);
      border-radius: 50px; transition: 0.3s; cursor: pointer;
    }
    .user-chip:hover { border-color: var(--primary); background: rgba(51, 161, 253, 0.1); }
    .user-chip img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid var(--primary); }
    .user-chip span { font-size: 0.9rem; font-weight: 600; padding-right: 5px; }

    /* --- Hero Section --- */
    .hero {
      text-align: center; padding: 80px 20px 60px;
      position: relative; z-index: 1;
    }
    .hero h1 {
      font-family: 'Orbitron'; font-size: 3rem; margin-bottom: 15px;
      background: linear-gradient(135deg, #fff 0%, var(--primary) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 0 20px rgba(51, 161, 253, 0.2));
    }
    .hero p { font-size: 1.1rem; color: var(--text-muted); margin-bottom: 30px; }

    /* Progress Overview */
    .main-progress {
      max-width: 800px; margin: 0 auto;
      background: var(--card-bg); border: 1px solid var(--glass-border);
      border-radius: 20px; padding: 30px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    .progress-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 0.9rem; color: var(--text-muted); }
    
    .bar-track {
      width: 100%; height: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden;
    }
    .bar-fill {
      height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 10px; box-shadow: 0 0 15px var(--primary);
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* --- Course Grid --- */
    .grid-container {
      max-width: 1200px; margin: 50px auto; padding: 0 20px;
      display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 25px; z-index: 1; position: relative;
    }

    .course-card {
      background: var(--card-bg); border: 1px solid var(--glass-border);
      border-radius: 20px; padding: 25px;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative; overflow: hidden;
      display: flex; flex-direction: column; justify-content: space-between;
      min-height: 280px;
    }
    
    /* Hover Glow Effect */
    .course-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, var(--primary), transparent);
      opacity: 0; transition: 0.3s;
    }
    .course-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.4);
      border-color: rgba(51, 161, 253, 0.3);
    }
    .course-card:hover::before { opacity: 1; }

    .course-card h3 { font-size: 1.4rem; font-weight: 700; margin-bottom: 10px; }
    .course-card p { font-size: 0.95rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 20px; flex-grow: 1; }

    .card-meta {
      display: flex; justify-content: space-between; align-items: center; margin-top: auto;
    }
    .badge {
      font-size: 0.75rem; padding: 4px 10px; border-radius: 20px;
      background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--glass-border);
    }

    /* Start Button */
    .btn-start {
      padding: 10px 24px; border-radius: 50px; border: none;
      background: var(--primary); color: #fff; font-weight: 600; cursor: pointer;
      box-shadow: 0 5px 15px rgba(51, 161, 253, 0.25); transition: 0.2s;
    }
    .btn-start:hover { transform: scale(1.05); box-shadow: 0 10px 25px rgba(51, 161, 253, 0.4); }

    /* --- Exit Modal --- */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
      display: flex; justify-content: center; align-items: center;
      opacity: 0; pointer-events: none; transition: 0.3s; z-index: 1000;
    }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }

    .modal-box {
      background: var(--card-bg); border: 1px solid var(--glass-border);
      padding: 40px; border-radius: 24px; text-align: center;
      box-shadow: 0 20px 50px rgba(0,0,0,0.6); max-width: 400px; width: 90%;
      transform: scale(0.9); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .modal-overlay.active .modal-box { transform: scale(1); }

    .modal-box h3 { font-family: 'Orbitron'; font-size: 1.5rem; margin-bottom: 10px; }
    .modal-box p { color: var(--text-muted); margin-bottom: 25px; }

    .modal-actions { display: flex; gap: 15px; justify-content: center; }
    .btn-cancel {
      padding: 10px 20px; background: transparent; border: 1px solid var(--glass-border);
      color: #fff; border-radius: 12px; cursor: pointer; transition: 0.2s;
    }
    .btn-confirm {
      padding: 10px 25px; background: #FF453A; border: none;
      color: #fff; border-radius: 12px; font-weight: 600; cursor: pointer;
      box-shadow: 0 5px 15px rgba(255, 69, 58, 0.3); transition: 0.2s;
    }
    .btn-confirm:hover { transform: scale(1.05); }

    /* Footer */
    footer {
      text-align: center; padding: 40px; border-top: 1px solid var(--glass-border);
      color: var(--text-muted); font-size: 0.9rem; margin-top: 50px;
    }

    @media (max-width: 768px) {
      nav { padding: 15px 20px; }
      .nav-link { display: none; } /* Hide links on mobile, keep profile/exit */
      .hero h1 { font-size: 2.2rem; }
    }
  </style>
</head>

<body>

  <div class="noise"></div>

  <nav>
    <div class="brand">
      <i class="fas fa-brain"></i>
      <span>MindStep</span>
    </div>
    
    <div class="nav-items">
      <a href="#" class="nav-link active">Dashboard</a>
      <a href="#" class="nav-link">Guides</a>
      <a href="#" class="nav-link">Community</a>
    </div>

    <div style="display:flex; gap:15px; align-items:center;">
      <div class="user-chip" id="userProfile">
        <img id="userImg" src="" alt="U">
        <span id="userName">User</span>
      </div>
      <button class="btn-cancel" style="padding:6px 12px; font-size:0.85rem;" onclick="openExit()">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </nav>

  <section class="hero">
    <h1>Welcome Back, <span id="heroName" style="color:var(--primary)">Learner</span></h1>
    <p>Consistency is the key to mastery. Continue where you left off.</p>

    <div class="main-progress">
      <div class="progress-header">
        <span>Total Progress</span>
        <span id="totalPercent">0%</span>
      </div>
      <div class="bar-track">
        <div class="bar-fill" id="totalBar"></div>
      </div>
    </div>
  </section>

  <div class="grid-container" id="coursesGrid">
    <div style="text-align:center; width:100%; color:#666;">Loading courses...</div>
  </div>

  <footer>
    <p>&copy; 2025 MindStep Inc. All rights reserved.</p>
  </footer>

  <div class="modal-overlay" id="exitModal">
    <div class="modal-box">
      <h3>Signing Out?</h3>
      <p>Your progress is saved. See you next time!</p>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeExit()">Cancel</button>
        <button class="btn-confirm" onclick="logout()">Log Out</button>
      </div>
    </div>
  </div>

<script>
// --- CORE LOGIC ---
const API_BASE = window.location.origin;

document.addEventListener("DOMContentLoaded", () => {
  
  // 1. Auth Check
  const saved = localStorage.getItem("mindstep_user");
  if (!saved) {
    window.location.href = "LoginPage.html";
    return;
  }
  const user = JSON.parse(saved);
  
  // 2. Populate UI
  document.getElementById("userName").textContent = user.username;
  document.getElementById("heroName").textContent = user.username;
  document.getElementById("userImg").src = user.image || "https://ui-avatars.com/api/?name=" + user.username + "&background=33A1FD&color=fff";

  // 3. Load Data
  loadCourses(user._id);
});

async function loadCourses(userId) {
  try {
    const res = await fetch(`${API_BASE}/api/public/courses`);
    const data = await res.json();
    const grid = document.getElementById("coursesGrid");
    
    if (!data.success || !data.results.length) {
      grid.innerHTML = `<h3 style="text-align:center; width:100%; opacity:0.5;">No courses available right now.</h3>`;
      return;
    }

    grid.innerHTML = ""; // Clear loader
    let totalProg = 0;
    let count = 0;

    for (const entry of data.results) {
      const { course, lessonCount } = entry;
      
      // Fetch Progress
      let progress = 0;
      try {
        const pRes = await fetch(`${API_BASE}/api/course/${course.slug}/progress/${userId}`);
        const pData = await pRes.json();
        progress = pData.percent || 0;
      } catch(e) {}

      totalProg += progress;
      count++;

      // Create Card
      const card = document.createElement("div");
      card.className = "course-card";
      card.innerHTML = `
        <div>
          <div class="card-meta" style="margin-bottom:15px;">
            <span class="badge" style="background:rgba(51,161,253,0.1); color:#33A1FD;">${course.category || 'Development'}</span>
            <span class="badge"><i class="fas fa-book-open"></i> ${lessonCount} Lessons</span>
          </div>
          <h3>${course.title}</h3>
          <p>${course.description.substring(0, 80)}...</p>
        </div>
        
        <div>
          <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:8px; opacity:0.7;">
            <span>Progress</span>
            <span>${progress}%</span>
          </div>
          <div class="bar-track" style="height:6px; margin-bottom:20px;">
            <div class="bar-fill" style="width:${progress}%"></div>
          </div>
          
          <button class="btn-start" onclick="openCourse('${course.slug}')">
            ${progress > 0 ? 'Continue' : 'Start Course'} <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      `;
      grid.appendChild(card);
    }

    // Update Global Progress
    const avg = count ? Math.round(totalProg / count) : 0;
    document.getElementById("totalPercent").textContent = avg + "%";
    document.getElementById("totalBar").style.width = avg + "%";

  } catch (err) {
    console.error(err);
  }
}

function openCourse(slug) {
  window.location.href = `course.html?course=${slug}`;
}

// --- MODAL LOGIC ---
const modal = document.getElementById("exitModal");

function openExit() { modal.classList.add("active"); }
function closeExit() { modal.classList.remove("active"); }

function logout() {
  localStorage.removeItem("mindstep_user");
  window.location.href = "LoginPage.html";
}
</script>

</body>
</html>