<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MindStep // Command Center</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* --- APPLE MACOS DARK THEME --- */
    :root {
      --bg-wallpaper: #000000;
      --bg-wallpaper-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                            radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                            radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      
      --glass-panel: rgba(30, 30, 35, 0.70);
      --glass-sidebar: rgba(20, 20, 25, 0.65);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-highlight: rgba(255, 255, 255, 0.05);
      
      --text-main: #f5f5f7;
      --text-muted: #86868b;
      
      --accent-blue: #0a84ff;
      --accent-green: #30d158;
      --accent-red: #ff453a;
      --accent-orange: #ff9f0a;
      
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      --radius-l: 18px;
      --radius-m: 12px;
      --radius-s: 8px;
    }

    * { margin:0; padding:0; box-sizing:border-box; outline:none; -webkit-font-smoothing: antialiased; }
    
    body { 
      background-color: var(--bg-wallpaper);
      background-image: var(--bg-wallpaper-image);
      background-size: cover;
      color: var(--text-main); 
      font-family: var(--font-stack);
      display: flex; 
      height: 100vh; 
      overflow: hidden; 
    }

    /* --- SIDEBAR (Frosted Glass) --- */
    .sidebar { 
      width: 260px; 
      background: var(--glass-sidebar); 
      backdrop-filter: blur(25px) saturate(180%);
      -webkit-backdrop-filter: blur(25px) saturate(180%);
      border-right: 1px solid var(--glass-border); 
      display: flex; flex-direction: column; 
      padding: 20px; 
      z-index: 20;
    }
    
    .traffic-lights { display: flex; gap: 8px; margin-bottom: 30px; padding-left: 5px; }
    .traffic-dot { width: 12px; height: 12px; border-radius: 50%; }
    .dot-red { background: #ff5f56; border: 1px solid #e0443e; }
    .dot-yellow { background: #ffbd2e; border: 1px solid #dea123; }
    .dot-green { background: #27c93f; border: 1px solid #1aab29; }

    .brand { 
      font-size: 0.8rem; font-weight: 600; color: var(--text-muted); 
      text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; padding-left: 10px;
    }

    .menu-item { 
      padding: 10px 12px; border-radius: var(--radius-s); color: var(--text-main); 
      cursor: pointer; display: flex; align-items: center; gap: 12px; 
      transition: 0.2s; margin-bottom: 4px; font-size: 0.9rem; font-weight: 500;
    }
    .menu-item i { width: 20px; text-align: center; color: var(--text-muted); transition: 0.2s; }
    
    .menu-item:hover { background: var(--glass-highlight); }
    .menu-item.active { background: rgba(10, 132, 255, 0.2); color: var(--accent-blue); }
    .menu-item.active i { color: var(--accent-blue); }
    
    .logout { margin-top: auto; color: var(--accent-red); }
    .logout i { color: var(--accent-red); }
    .logout:hover { background: rgba(255, 69, 58, 0.1); }

    /* --- CONTENT AREA --- */
    .content { flex: 1; padding: 30px 40px; overflow-y: auto; position: relative; }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .header h1 { font-size: 2rem; font-weight: 700; letter-spacing: -0.5px; }
    
    .action-bar { display: flex; gap: 10px; }
    
    /* BUTTONS */
    .btn { 
      padding: 8px 16px; border-radius: var(--radius-s); font-size: 0.85rem; font-weight: 500; 
      cursor: pointer; display: inline-flex; align-items: center; gap: 8px; border: none; 
      transition: all 0.2s ease; 
    }
    .btn-glass { 
      background: rgba(255,255,255,0.1); color: #fff; border: 1px solid var(--glass-border); 
      backdrop-filter: blur(10px);
    }
    .btn-glass:hover { background: rgba(255,255,255,0.2); }
    
    .btn-primary { 
      background: var(--accent-blue); color: white; 
      box-shadow: 0 2px 10px rgba(10, 132, 255, 0.3);
    }
    .btn-primary:hover { background: #007aff; transform: scale(1.02); }
    
    .btn-danger { background: rgba(255, 69, 58, 0.15); color: var(--accent-red); border: 1px solid rgba(255, 69, 58, 0.3); }
    .btn-danger:hover { background: rgba(255, 69, 58, 0.25); }

    /* WIDGETS */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .widget { 
      background: var(--glass-panel); border: 1px solid var(--glass-border); 
      padding: 20px; border-radius: var(--radius-l); 
      backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s;
    }
    .widget-title { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
    .widget-val { font-size: 2.2rem; font-weight: 700; color: #fff; letter-spacing: -1px; }

    /* TABLES & FORMS */
    .table-wrapper { 
      background: var(--glass-panel); border: 1px solid var(--glass-border); 
      border-radius: var(--radius-l); overflow: hidden; margin-bottom: 30px; 
      backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    
    .toolbar { 
      padding: 15px 20px; border-bottom: 1px solid var(--glass-border); 
      display: flex; justify-content: space-between; align-items: center; 
      background: rgba(255,255,255,0.02);
    }

    .search-spotlight, .input-glass, textarea {
        background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); color: #fff;
        padding: 10px 12px; border-radius: 8px; font-size: 0.9rem; width: 100%;
        transition: 0.2s; font-family: var(--font-stack);
    }
    .search-spotlight:focus, .input-glass:focus, textarea:focus { border-color: var(--accent-blue); background-color: rgba(0,0,0,0.4); }

    .filter-select {
        background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-main);
        padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; width: 100%;
    }
    .filter-select option { background: #1c1c1e; color: #fff; }

    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 15px 20px; color: var(--text-muted); font-weight: 500; font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid var(--glass-border); }
    td { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.9rem; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255,255,255,0.03); }

    .checkbox-ios {
        appearance: none; width: 18px; height: 18px; border: 1px solid var(--text-muted); border-radius: 4px;
        display: grid; place-content: center; cursor: pointer;
    }
    .checkbox-ios::before { content: ""; width: 10px; height: 10px; transform: scale(0); transition: 0.1s; box-shadow: inset 1em 1em var(--accent-blue); transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
    .checkbox-ios:checked { border-color: var(--accent-blue); background: var(--accent-blue); border: none; }
    .checkbox-ios:checked::before { transform: scale(1); background: #fff; box-shadow: none; }

    #bulkActionBar {
        position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
        background: rgba(30, 30, 35, 0.9); backdrop-filter: blur(20px);
        padding: 12px 24px; border-radius: 50px; border: 1px solid var(--glass-border);
        display: flex; align-items: center; gap: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100;
    }
    #bulkActionBar.visible { transform: translateX(-50%) translateY(0); }

    .avatar-stack { display: flex; align-items: center; gap: 12px; }
    .avatar { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%); display: grid; place-items: center; font-weight: 700; color: #333; font-size: 0.85rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .badge-pending { background: rgba(255, 159, 10, 0.15); color: var(--accent-orange); }
    .badge-approved { background: rgba(48, 209, 88, 0.15); color: var(--accent-green); }
    .badge-rejected { background: rgba(255, 69, 58, 0.15); color: var(--accent-red); }

    #toastContainer { position: fixed; top: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 999; }
    .toast {
        background: rgba(40, 40, 45, 0.8); backdrop-filter: blur(20px);
        color: #fff; padding: 14px 20px; border-radius: 12px; border: 1px solid var(--glass-border);
        display: flex; align-items: center; gap: 12px; min-width: 280px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideIn 0.3s;
    }
    .toast i.success { color: var(--accent-green); }
    .toast i.error { color: var(--accent-red); }
    
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }

    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }

    @media (max-width: 900px) {
        .sidebar { display: none; }
        .content { padding: 15px; }
        .stats-grid { grid-template-columns: 1fr; }
        table { font-size: 0.75rem; }
        .table-wrapper { overflow-x: scroll; }
        th, td { padding: 10px; }
        .header h1 { font-size: 1.5rem; }
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="traffic-lights">
        <div class="traffic-dot dot-red"></div>
        <div class="traffic-dot dot-yellow"></div>
        <div class="traffic-dot dot-green"></div>
    </div>
    
    <div class="brand">Control Center</div>
    
    <div class="menu-item active" id="menu-users" onclick="switchTab('users')">
        <i class="fas fa-user-friends"></i> Users
    </div>
    <div class="menu-item" id="menu-projects" onclick="switchTab('projects')">
        <i class="fas fa-layer-group"></i> Projects
    </div>
    <div class="menu-item" id="menu-lessons" onclick="switchTab('lessons')">
        <i class="fas fa-book-open"></i> Lessons
    </div>
    
    <div class="menu-item" style="margin-top: 20px;"><i class="fas fa-chart-pie"></i> Analytics</div>
    <div class="menu-item"><i class="fas fa-sliders-h"></i> Settings</div>
    
    <div class="menu-item logout" onclick="logout()"><i class="fas fa-power-off"></i> Log Out</div>
  </div>

  <div class="content">
    <div class="header">
      <div>
          <h1 id="pageTitle">Overview</h1>
          <div style="font-size:0.9rem; color:var(--text-muted); margin-top:5px;">System Status: <span style="color:var(--accent-green)">Operational</span></div>
      </div>
      <div class="action-bar">
          <button class="btn btn-glass" onclick="exportData()"><i class="fas fa-file-export"></i> Export CSV</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="widget">
        <div class="widget-title">Total Users</div>
        <div class="widget-val" id="totalUsers">-</div>
      </div>
      <div class="widget">
        <div class="widget-title">Active Courses</div>
        <div class="widget-val" id="activeCourses">-</div>
      </div>
      <div class="widget">
        <div class="widget-title">Pending Review</div>
        <div class="widget-val" style="color:var(--accent-orange)" id="pendingCount">0</div>
      </div>
    </div>

    <div id="usersSection" class="table-wrapper">
      <div class="toolbar">
        <h3 style="font-size:1rem; font-weight:600;">User Registry</h3>
        <button class="btn btn-glass" onclick="loadUsers()"><i class="fas fa-sync-alt"></i></button>
      </div>
      <div id="loadingUsers" style="text-align:center; padding:30px; display:none;"><i class="fas fa-spinner fa-spin"></i></div>
      <table>
        <thead>
          <tr>
            <th>Identity</th>
            <th>Email</th>
            <th>Progress</th>
            <th>Joined</th>
            <th style="text-align:right;">Actions</th>
          </tr>
        </thead>
        <tbody id="userTable"></tbody>
      </table>
    </div>

    <div id="projectsSection" class="table-wrapper" style="display:none;">
        <div class="toolbar">
          <div style="display:flex; gap:15px; align-items:center;">
              <input type="text" id="projectSearch" class="search-spotlight" placeholder="Search (Cmd+K)" onkeyup="searchProjects(this.value)" style="width:220px;">
              <select class="filter-select" onchange="filterProjects(this.value)" style="width:auto;">
                  <option value="all">All Status</option>
                  <option value="pending">Pending</option>
                  <option value="approved">Approved</option>
                  <option value="rejected">Rejected</option>
              </select>
          </div>
          <button class="btn btn-glass" onclick="loadProjectSubmissions()"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div id="projectList">
            <table style="width:100%;">
                <thead>
                    <tr>
                        <th style="width:40px;"><input type="checkbox" class="checkbox-ios" onclick="toggleSelectAll(this)"></th>
                        <th>Student</th>
                        <th>File Info</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th style="text-align:right;">Quick Actions</th>
                    </tr>
                </thead>
                <tbody id="projectTableBody">
                    <tr><td colspan="6" style="text-align:center; padding:40px; color:var(--text-muted);">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="lessonsSection" class="table-wrapper" style="display:none;">
        <div class="toolbar">
            <h3 style="font-size:1rem; font-weight:600;"><i class="fas fa-edit"></i> Lesson Editor</h3>
        </div>
        <div style="padding: 30px; max-width: 800px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label class="form-label">Course</label>
                    <select id="courseSelect" class="filter-select" onchange="loadLessonsForCourse()">
                        <option>Loading courses...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Lesson</label>
                    <select id="lessonSelect" class="filter-select">
                        <option>Select a course first</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Video URL (YouTube/Embed)</label>
                <input id="videoInput" class="input-glass" placeholder="https://www.youtube.com/watch?v=..." />
            </div>

            <div class="form-group">
                <label class="form-label">Lesson Notes</label>
                <textarea id="notesInput" rows="6" placeholder="Enter detailed study notes here..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Study Material (PDF)</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="file" id="pdfInput" accept="application/pdf" style="display:none;" onchange="document.getElementById('fileNameDisplay').innerText = this.files[0].name">
                    <button class="btn btn-glass" onclick="document.getElementById('pdfInput').click()">
                        <i class="fas fa-paperclip"></i> Choose PDF
                    </button>
                    <span id="fileNameDisplay" style="color:var(--text-muted); font-size:0.9rem;">No file selected</span>
                </div>
            </div>

            <hr style="border:none; border-top:1px solid var(--glass-border); margin: 30px 0;">

            <button class="btn btn-primary" onclick="saveLessonContent()">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </div>

  </div>

  <div id="bulkActionBar">
      <span style="font-weight:600; font-size:0.9rem; color:#fff;"><span id="selectedCount">0</span> Selected</span>
      <div style="height:20px; width:1px; background:rgba(255,255,255,0.2);"></div>
      <button class="btn btn-primary" style="background:var(--accent-green); padding:6px 12px;" onclick="bulkAction('approved')">Approve</button>
      <button class="btn btn-danger" style="padding:6px 12px;" onclick="bulkAction('rejected')">Reject</button>
  </div>

  <div id="toastContainer"></div>

<script>
const ADMIN_TOKEN = localStorage.getItem("mindstep_admin_token");
if (!ADMIN_TOKEN) window.location.href = "AdminLogin.html";

let allProjects = [];
let projectsLoaded = false;
let currentFilter = 'all';
let selectedProjects = new Set();

document.addEventListener("DOMContentLoaded", () => {
  init();
  
  document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          if(document.getElementById('projectsSection').style.display !== 'none') {
              document.getElementById('projectSearch').focus();
          }
      }
  });

  setInterval(() => {
      if (projectsLoaded) loadProjectSubmissions();
  }, 30000);
});

// âœ… REUSABLE STATS LOADER (Fixes dash issue)
async function loadOverviewStats() {
  try {
    const res = await fetch("/api/admin/overview", { headers: { "Authorization": "Bearer " + ADMIN_TOKEN } });
    if(res.status === 401) logout();
    const data = await res.json();
    
    document.getElementById("totalUsers").innerText = data.totalUsers ?? 0;
    document.getElementById("activeCourses").innerText = data.activeCourses ?? 0;
    document.getElementById("pendingCount").innerText = data.pendingCount ?? 0;
  } catch(e) { console.error("Stats load failed", e); }
}

function switchTab(tab) {
    document.getElementById('usersSection').style.display = 'none';
    document.getElementById('projectsSection').style.display = 'none';
    document.getElementById('lessonsSection').style.display = 'none'; 
    
    document.getElementById('menu-users').classList.remove('active');
    document.getElementById('menu-projects').classList.remove('active');
    document.getElementById('menu-lessons').classList.remove('active'); 

    if(tab === 'users') {
        document.getElementById('usersSection').style.display = 'block';
        document.getElementById('menu-users').classList.add('active');
        document.getElementById('pageTitle').innerText = "User Management";
    } else if(tab === 'projects') {
        document.getElementById('projectsSection').style.display = 'block';
        document.getElementById('menu-projects').classList.add('active');
        document.getElementById('pageTitle').innerText = "Project Submissions";
        
        // âœ… CALL STATS REFRESH HERE
        loadOverviewStats(); 

        if(!projectsLoaded) {
            loadProjectSubmissions();
            projectsLoaded = true;
        }
    } else if(tab === 'lessons') {
        document.getElementById('lessonsSection').style.display = 'block';
        document.getElementById('menu-lessons').classList.add('active');
        document.getElementById('pageTitle').innerText = "Lesson Content Editor";
        loadCoursesForLessons(); // Trigger data fetch
    }
}

async function init() {
  await loadOverviewStats();
  loadUsers();
}

async function loadUsers() {
  const tbody = document.getElementById("userTable");
  document.getElementById("loadingUsers").style.display = 'block';
  tbody.innerHTML = '';
  
  const res = await fetch("/api/admin/users", { headers: { "Authorization": "Bearer " + ADMIN_TOKEN } });
  const data = await res.json();
  document.getElementById("loadingUsers").style.display = 'none';

  if(!data.users || data.users.length === 0){
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--text-muted); padding:30px;">No users found.</td></tr>`;
      return;
  }

  tbody.innerHTML = data.users.map(u => `
    <tr>
      <td>
        <div class="avatar-stack">
          <div class="avatar">${u.username[0].toUpperCase()}</div>
          <b>${u.username}</b>
        </div>
      </td>
      <td><span style="color:var(--text-muted)">${u.email}</span></td>
      <td>
        <div style="display:flex; align-items:center; gap:10px;">
          <div style="flex:1; height:4px; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden; width:80px;">
            <div style="width:${u.percentage}%; height:100%; background:var(--accent-blue);"></div>
          </div>
          <span style="font-size:0.75rem; font-weight:600;">${u.percentage}%</span>
        </div>
      </td>
      <td style="font-size:0.85rem; color:var(--text-muted);">${new Date(u.created_at).toLocaleDateString()}</td>
      <td style="text-align:right;">
        <button class="btn-glass" style="padding:6px 10px; margin-right:5px;" onclick="openUserProjects('${u._id}')" title="View Projects"><i class="fas fa-folder-open"></i></button>
        <button class="btn-glass" style="padding:6px 10px; color:var(--accent-red);" onclick="purgeUser('${u._id}')" title="Delete User"><i class="fas fa-trash"></i></button>
      </td>
    </tr>
  `).join("");
}

async function openUserProjects(userId) {
  switchTab('projects');
  document.getElementById("projectTableBody").innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--text-muted);">Loading user projects...</td></tr>';

  try {
    const res = await fetch("/api/admin/projects", {
      headers: { "Authorization": "Bearer " + ADMIN_TOKEN }
    });
    const data = await res.json();
    const projects = data.projects || []; // Safe access

    const userProjects = projects.filter(p => {
        if(!p.userId) return false;
        if(p.userId._id && p.userId._id === userId) return true;
        if(typeof p.userId === 'string' && p.userId === userId) return true;
        return false;
    });

    if (userProjects.length > 0) {
         const username = (userProjects[0].userId && userProjects[0].userId.username) ? userProjects[0].userId.username : "User";
         document.getElementById("pageTitle").innerText = `Projects â€¢ ${username}`;
    } else {
         document.getElementById("pageTitle").innerText = `Projects â€¢ (No Data)`;
         document.getElementById("projectTableBody").innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--text-muted);">No projects found for this user.</td></tr>';
    }

    allProjects = userProjects;
    updatePendingCount();
    renderProjects(allProjects);

  } catch (e) {
    showToast("Error loading user projects", "error");
  }
}

async function loadProjectSubmissions() {
  try {
    const res = await fetch("/api/admin/projects", { headers: { "Authorization": "Bearer " + ADMIN_TOKEN } });
    const data = await res.json();
    allProjects = data.projects || []; // Safe access
    updatePendingCount(); 
    renderProjects(allProjects);
  } catch (err) {
    document.getElementById("projectTableBody").innerHTML = `<tr><td colspan="6" style="color:var(--accent-red); text-align:center; padding:30px;">Connection Failed.</td></tr>`;
  }
}

function updatePendingCount() {
    const pending = allProjects.filter(p => p.status === 'pending').length;
    document.getElementById("pendingCount").innerText = pending;
}

function renderProjects(projects) {
    const tbody = document.getElementById("projectTableBody");
    if (projects.length === 0) {
        if(tbody.innerHTML.includes("Loading")) return;
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--text-muted);">No projects found.</td></tr>`;
        return;
    }

    tbody.innerHTML = projects.map(p => {
        const status = p.status || 'pending';
        let badgeClass = 'badge-pending';
        if(status === 'approved') badgeClass = 'badge-approved';
        if(status === 'rejected') badgeClass = 'badge-rejected';

        const lessonDisplay = p.lessonId?.title || p.courseId || "Unknown Task";
        const usernameDisplay = p.userId?.username || "Unknown";

        return `
      <tr id="row-${p._id}" ondblclick="showProjectInfo('${p._id}')" style="cursor:pointer;" title="Double click for details">
        <td><input type="checkbox" class="checkbox-ios" value="${p._id}" onclick="toggleSelect('${p._id}')"></td>
        <td>
            <div class="avatar-stack">
                <div class="avatar">${usernameDisplay[0].toUpperCase()}</div>
                <div>
                    <b style="font-weight:600;">${usernameDisplay}</b><br>
                    <span style="font-size:0.75rem; color:var(--text-muted);">
                        ${lessonDisplay}
                    </span>
                </div>
            </div>
        </td>
        <td>
            <div>
                <div style="font-size:0.9rem;">${p.originalName}</div>
                <div style="font-size:0.75rem; color:var(--text-muted);">${(p.fileSize / 1024 / 1024).toFixed(2)} MB</div>
            </div>
        </td>
        <td><span id="badge-${p._id}" class="badge ${badgeClass}">${status}</span></td>
        <td><span style="color:var(--text-muted); font-size:0.8rem;">${new Date(p.createdAt).toLocaleDateString()}</span></td>
        <td style="text-align:right;">
            <button class="btn-glass" onclick="downloadProject('${p._id}')" style="padding:6px 10px; margin-right:5px;"><i class="fas fa-download"></i></button>
            <button class="btn-glass" style="padding:6px 10px; color:var(--accent-red);" onclick="deleteProject('${p._id}')"><i class="fas fa-trash"></i></button>
        </td>
      </tr>
    `}).join("");
}

function downloadProject(id) {
    const btn = event.currentTarget;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 

    fetch(`/api/admin/projects/${id}/download`, {
        headers: { "Authorization": "Bearer " + ADMIN_TOKEN }
    })
    .then(res => {
        if(res.status !== 200) throw new Error("Download failed");
        return res.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "project-submission.zip"; 
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        btn.innerHTML = originalHTML; 
    })
    .catch(err => {
        showToast("Download Failed: " + err.message, "error");
        btn.innerHTML = originalHTML;
    });
}

function showProjectInfo(id) {
  const p = allProjects.find(x => x._id === id);
  if(!p) return;
  alert(
    `ðŸ“‹ PROJECT DETAILS\n\n` +
    `Student: ${p.userId?.username || "N/A"}\n` +
    `Email: ${p.userId?.email || "N/A"}\n` +
    `File: ${p.originalName}\n` +
    `Size: ${(p.fileSize/1024/1024).toFixed(2)} MB\n` +
    `Status: ${p.status}\n` +
    `Submitted: ${new Date(p.createdAt).toLocaleString()}`
  );
}

function toggleSelect(id) {
    if(selectedProjects.has(id)) selectedProjects.delete(id);
    else selectedProjects.add(id);
    updateBulkBar();
}

function toggleSelectAll(source) {
    const checkboxes = document.querySelectorAll('#projectTableBody .checkbox-ios');
    checkboxes.forEach(cb => {
        cb.checked = source.checked;
        if(source.checked) selectedProjects.add(cb.value);
        else selectedProjects.delete(cb.value);
    });
    updateBulkBar();
}

function updateBulkBar() {
    const bar = document.getElementById('bulkActionBar');
    document.getElementById('selectedCount').innerText = selectedProjects.size;
    if(selectedProjects.size > 0) bar.classList.add('visible');
    else bar.classList.remove('visible');
}

async function bulkAction(status) {
    const ids = Array.from(selectedProjects);
    if(!confirm(`Apply '${status.toUpperCase()}' to ${ids.length} items?`)) return;

    for (const id of ids) {
        await updateStatus(id, status, false);
    }
    
    selectedProjects.clear();
    updateBulkBar();
    showToast(`Batch processing complete`, 'success');
}

async function updateStatus(id, status, showNotif = true) {
    try {
        const res = await fetch(`/api/admin/projects/${id}/status`, {
            method: 'PUT',
            headers: { "Authorization": "Bearer " + ADMIN_TOKEN, "Content-Type": "application/json" },
            body: JSON.stringify({ status })
        });

        if(res.ok) {
            const idx = allProjects.findIndex(p => p._id === id);
            if(idx !== -1) allProjects[idx].status = status;
            
            const badge = document.getElementById(`badge-${id}`);
            if(badge) {
                badge.className = `badge badge-${status}`;
                badge.innerText = status;
            }
            updatePendingCount();
            if(showNotif) showToast(`Marked as ${status}`, 'success');
        }
    } catch(e) { if(showNotif) showToast("Update Failed", "error"); }
}

async function deleteProject(id) {
    if(!confirm("Permanently delete?")) return;
    try {
        await fetch(`/api/admin/projects/${id}`, { method: 'DELETE', headers: { "Authorization": "Bearer " + ADMIN_TOKEN } });
        allProjects = allProjects.filter(p => p._id !== id);
        renderProjects(allProjects);
        updatePendingCount();
        showToast("Deleted successfully", 'success');
    } catch(e) { showToast("Delete failed", "error"); }
}

function exportData() {
    alert("Export feature placeholder");
}

function showToast(msg, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle success':'fa-exclamation-circle error'}"></i> ${msg}`;
    container.appendChild(toast);
    setTimeout(() => { toast.style.opacity='0'; setTimeout(() => toast.remove(), 300) }, 3000);
}

function searchProjects(val) {
    const lower = val.toLowerCase();
    const filtered = allProjects.filter(p => (p.userId?.username?.toLowerCase() || "").includes(lower) || p.originalName.toLowerCase().includes(lower));
    renderProjects(filtered);
}

function filterProjects(status) {
    if(status === 'all') renderProjects(allProjects);
    else renderProjects(allProjects.filter(p => (p.status || 'pending') === status));
}

async function purgeUser(id) {
  if(!confirm("WARNING: Wipe user data?")) return;
  await fetch(`/api/admin/user/${id}/purge`, { method: "POST", headers: { "Authorization": "Bearer " + ADMIN_TOKEN } });
  loadUsers();
  showToast("User Purged", "success");
}

function logout() {
  localStorage.removeItem("mindstep_admin_token");
  window.location.href = "AdminLogin.html";
}

// âœ… NEW: LESSON MANAGEMENT FUNCTIONS
async function loadCoursesForLessons() {
  const res = await fetch("/api/public/courses");
  const data = await res.json();
  const select = document.getElementById("courseSelect");
  
  if (data.results && data.results.length > 0) {
      select.innerHTML = data.results.map(c => 
          `<option value="${c.course.slug}">${c.course.title}</option>`
      ).join("");
      loadLessonsForCourse(); // Load lessons for the first course
  } else {
      select.innerHTML = "<option>No courses found</option>";
  }
}

async function loadLessonsForCourse() {
  const courseSlug = document.getElementById("courseSelect").value;
  const res = await fetch(`/api/course/${courseSlug}/lessons`);
  const data = await res.json();
  const select = document.getElementById("lessonSelect");
  
  if (data.lessons && data.lessons.length > 0) {
      select.innerHTML = data.lessons.map(l => 
          `<option value="${l._id}">${l.title}</option>`
      ).join("");
  } else {
      select.innerHTML = "<option>No lessons found</option>";
  }
}

async function saveLessonContent() {
  const lessonId = document.getElementById("lessonSelect").value;
  if (!lessonId) return showToast("Select a lesson first", "error");

  // Save Video & Notes
  await fetch(`/api/admin/lesson/${lessonId}/content`, {
    method: "PUT",
    headers: {
      "Authorization": "Bearer " + ADMIN_TOKEN,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      video: document.getElementById("videoInput").value,
      notes: document.getElementById("notesInput").value
    })
  });

  // Save PDF (if selected)
  const pdfFile = document.getElementById("pdfInput").files[0];
  if (pdfFile) {
    const fd = new FormData();
    fd.append("pdf", pdfFile);
    await fetch(`/api/admin/lesson/${lessonId}/pdf`, {
      method: "POST",
      headers: { "Authorization": "Bearer " + ADMIN_TOKEN },
      body: fd
    });
  }

  showToast("Lesson updated successfully", "success");
}
</script>
</body>
</html>