<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MindStep â€” Master Control</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Outfit:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Modern Dark Palette */
      --bg-root: #0b0f19;
      --bg-sidebar: #111827;
      --bg-card: #1f2937;
      --bg-hover: #374151;
      
      --primary: #8b5cf6; /* Violet */
      --primary-hover: #7c3aed;
      --secondary: #ec4899; /* Pink */
      
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;

      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      
      --border: rgba(255,255,255,0.08);
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; outline: none; font-family: 'Plus Jakarta Sans', sans-serif; }

    body {
      background-color: var(--bg-root);
      color: var(--text-main);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* --- SIDEBAR --- */
    .sidebar {
      width: 260px;
      background-color: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      flex-shrink: 0;
      transition: 0.3s;
    }

    .brand {
      height: 70px;
      display: flex; align-items: center; padding: 0 24px;
      font-family: 'Outfit', sans-serif; font-size: 1.4rem; font-weight: 700;
      color: #fff; letter-spacing: -0.5px;
      border-bottom: 1px solid var(--border);
    }
    .brand i { color: var(--primary); margin-right: 10px; font-size: 1.2rem; }

    .nav-group { padding: 20px 15px; flex: 1; overflow-y: auto; }
    .nav-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-bottom: 10px; padding-left: 10px; letter-spacing: 0.5px; }
    
    .nav-link {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px; border-radius: 10px;
      color: var(--text-muted); text-decoration: none;
      font-weight: 500; font-size: 0.95rem;
      transition: all 0.2s; margin-bottom: 4px;
    }
    .nav-link:hover { background-color: rgba(255,255,255,0.05); color: #fff; }
    .nav-link.active { background-color: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
    .nav-link i { font-size: 1.1rem; width: 20px; text-align: center; }

    .user-profile {
      padding: 20px; border-top: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
    }
    .admin-avatar {
      width: 40px; height: 40px; border-radius: 10px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: grid; place-items: center; font-weight: 700; color: #fff;
    }
    .admin-info h4 { font-size: 0.9rem; margin-bottom: 2px; }
    .admin-info span { font-size: 0.75rem; color: var(--text-muted); }

    /* --- MAIN CONTENT --- */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    /* Top Header */
    .header {
      height: 70px; background-color: var(--bg-sidebar);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 30px;
    }
    .search-bar {
      position: relative; width: 300px;
    }
    .search-bar input {
      width: 100%; background: var(--bg-root); border: 1px solid var(--border);
      padding: 10px 15px 10px 40px; border-radius: 8px;
      color: #fff; font-size: 0.9rem; transition: 0.2s;
    }
    .search-bar input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }
    .search-bar i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

    .header-actions { display: flex; align-items: center; gap: 15px; }
    .icon-btn {
      width: 40px; height: 40px; border-radius: 8px;
      background: var(--bg-root); border: 1px solid var(--border);
      color: var(--text-muted); display: grid; place-items: center;
      cursor: pointer; transition: 0.2s; position: relative;
    }
    .icon-btn:hover { color: #fff; border-color: var(--text-muted); }
    .badge {
      position: absolute; top: -2px; right: -2px;
      width: 10px; height: 10px; background: var(--danger);
      border-radius: 50%; border: 2px solid var(--bg-sidebar);
    }

    /* Dashboard Content */
    .content { flex: 1; overflow-y: auto; padding: 30px; }

    .page-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 30px;
    }
    .page-title h2 { font-size: 1.8rem; font-weight: 700; letter-spacing: -0.5px; }
    .page-title p { color: var(--text-muted); font-size: 0.95rem; margin-top: 5px; }

    .btn-primary {
      background: var(--primary); color: #fff; border: none;
      padding: 10px 20px; border-radius: 8px; font-weight: 600;
      cursor: pointer; display: flex; align-items: center; gap: 8px;
      transition: 0.2s; box-shadow: 0 4px 6px rgba(139, 92, 246, 0.25);
    }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }

    /* Stats Cards */
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px; margin-bottom: 30px;
    }
    .stat-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 16px; padding: 24px; position: relative;
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-3px); border-color: rgba(255,255,255,0.1); }
    
    .stat-icon {
      width: 48px; height: 48px; border-radius: 12px;
      display: grid; place-items: center; font-size: 1.2rem;
      margin-bottom: 15px;
    }
    .icon-users { background: rgba(59, 130, 246, 0.1); color: var(--info); }
    .icon-courses { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .icon-activity { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .icon-server { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

    .stat-value { font-size: 2rem; font-weight: 700; color: #fff; margin-bottom: 5px; }
    .stat-label { color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
    .stat-trend { position: absolute; top: 24px; right: 24px; font-size: 0.85rem; font-weight: 600; }
    .trend-up { color: var(--success); } .trend-down { color: var(--danger); }

    /* Advanced Table */
    .table-container {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 16px; overflow: hidden;
    }
    .table-header {
      padding: 20px 24px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .table-actions { display: flex; gap: 10px; }
    .filter-btn {
      padding: 6px 12px; border: 1px solid var(--border);
      background: transparent; color: var(--text-muted);
      border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: 0.2s;
    }
    .filter-btn:hover, .filter-btn.active { background: rgba(255,255,255,0.05); color: #fff; border-color: var(--text-muted); }

    table { width: 100%; border-collapse: collapse; }
    th {
      text-align: left; padding: 16px 24px;
      color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase;
      font-weight: 600; letter-spacing: 0.5px; border-bottom: 1px solid var(--border);
    }
    td { padding: 16px 24px; border-bottom: 1px solid var(--border); color: #fff; font-size: 0.9rem; }
    tr:last-child td { border-bottom: none; }
    tr:hover { background-color: rgba(255,255,255,0.02); }

    /* User Cell */
    .user-cell { display: flex; align-items: center; gap: 12px; }
    .user-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--bg-card); }
    .user-details h5 { font-size: 0.95rem; font-weight: 600; margin-bottom: 2px; }
    .user-details span { font-size: 0.8rem; color: var(--text-muted); }

    /* Progress Bar */
    .progress-wrapper { width: 120px; }
    .progress-info { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 4px; }
    .progress-bg { height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
    .progress-bar { height: 100%; border-radius: 10px; background: linear-gradient(90deg, var(--primary), var(--secondary)); }

    /* Status Badge */
    .status-badge {
      padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
      display: inline-flex; align-items: center; gap: 6px;
    }
    .status-active { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .status-active::before { content: ''; width: 6px; height: 6px; background: var(--success); border-radius: 50%; }
    
    .status-offline { background: rgba(107, 114, 128, 0.15); color: var(--text-muted); }
    .status-offline::before { content: ''; width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; }

    /* Action Buttons */
    .action-group { display: flex; gap: 8px; }
    .btn-icon {
      width: 32px; height: 32px; border-radius: 6px;
      display: grid; place-items: center; border: none; cursor: pointer;
      transition: 0.2s;
    }
    .btn-edit { background: rgba(59, 130, 246, 0.15); color: var(--info); }
    .btn-edit:hover { background: var(--info); color: #fff; }
    
    .btn-trash { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
    .btn-trash:hover { background: var(--danger); color: #fff; }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar { width: 80px; }
      .brand span, .nav-label, .nav-link span, .admin-info { display: none; }
      .nav-link { justify-content: center; padding: 15px; }
      .brand { justify-content: center; padding: 0; }
      .user-profile { justify-content: center; padding: 20px 0; }
    }
  </style>
</head>
<body>

  <aside class="sidebar">
    <div class="brand">
      <i class="fas fa-cube"></i> <span>MindStep</span>
    </div>

    <div class="nav-group">
      <div class="nav-label">Main Menu</div>
      <a href="#" class="nav-link active"><i class="fas fa-home"></i> <span>Dashboard</span></a>
      <a href="#users" class="nav-link"><i class="fas fa-users"></i> <span>User Management</span></a>
      <a href="#courses" class="nav-link"><i class="fas fa-book-open"></i> <span>Courses</span></a>
      <a href="#analytics" class="nav-link"><i class="fas fa-chart-line"></i> <span>Analytics</span></a>
      
      <div class="nav-label" style="margin-top: 20px;">System</div>
      <a href="#settings" class="nav-link"><i class="fas fa-cog"></i> <span>Settings</span></a>
      <a href="#" class="nav-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a>
    </div>

    <div class="user-profile">
      <div class="admin-avatar" id="adminInitials">AD</div>
      <div class="admin-info">
        <h4 id="adminName">Administrator</h4>
        <span>Super Admin</span>
      </div>
    </div>
  </aside>

  <main class="main">
    
    <header class="header">
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Search for anything..." onkeyup="filterUsers(this.value)">
      </div>
      <div class="header-actions">
        <div class="icon-btn">
          <i class="far fa-bell"></i>
          <span class="badge"></span>
        </div>
        <div class="icon-btn">
          <i class="far fa-envelope"></i>
        </div>
        <button class="btn-primary" onclick="exportData()"><i class="fas fa-download"></i> Export Report</button>
      </div>
    </header>

    <div class="content">
      
      <div class="page-header">
        <div class="page-title">
          <h2>Overview</h2>
          <p>Here's what's happening in your academy today.</p>
        </div>
        <div class="date-display" style="color:var(--text-muted); font-weight:500;">
          <script>document.write(new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }))</script>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon icon-users"><i class="fas fa-users"></i></div>
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">Total Students</div>
          <span class="stat-trend trend-up"><i class="fas fa-arrow-up"></i> 12%</span>
        </div>
        <div class="stat-card">
          <div class="stat-icon icon-courses"><i class="fas fa-graduation-cap"></i></div>
          <div class="stat-value" id="totalCourses">0</div>
          <div class="stat-label">Active Courses</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon icon-activity"><i class="fas fa-clock"></i></div>
          <div class="stat-value">24m</div>
          <div class="stat-label">Avg. Session Time</div>
          <span class="stat-trend trend-up"><i class="fas fa-arrow-up"></i> 5%</span>
        </div>
        <div class="stat-card">
          <div class="stat-icon icon-server"><i class="fas fa-server"></i></div>
          <div class="stat-value">99.9%</div>
          <div class="stat-label">System Uptime</div>
        </div>
      </div>

      <div class="table-container" id="users">
        <div class="table-header">
          <h3 style="font-size:1.1rem; font-weight:700;">Recent Users</h3>
          <div class="table-actions">
            <button class="filter-btn active">All</button>
            <button class="filter-btn">Active</button>
            <button class="filter-btn">Inactive</button>
          </div>
        </div>
        
        <table>
          <thead>
            <tr>
              <th width="30%">Student</th>
              <th>Status</th>
              <th>Progress</th>
              <th>Joined Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="userTable">
            <tr><td colspan="5" style="text-align:center; padding:40px; color:var(--text-muted);">Loading user data...</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </main>

<script>
  const API_BASE = window.location.origin;
  const ADMIN_TOKEN = localStorage.getItem("mindstep_admin_token");
  
  if(!ADMIN_TOKEN) window.location.href = "AdminLogin.html";

  // Setup Admin Info
  const adminData = JSON.parse(localStorage.getItem("mindstep_admin") || "{}");
  document.getElementById("adminName").innerText = adminData.username || "Admin";
  document.getElementById("adminInitials").innerText = (adminData.username || "A").charAt(0).toUpperCase();

  // --- DATA LOADING ---
  async function loadDashboard() {
    try {
      // 1. Stats
      const statsRes = await fetch(`${API_BASE}/api/admin/overview`, {
        headers: { "Authorization": "Bearer " + ADMIN_TOKEN }
      });
      const stats = await statsRes.json();
      if(stats.success) {
        animateValue("totalUsers", stats.totalUsers);
        animateValue("totalCourses", stats.activeCourses);
      }

      // 2. Users List
      const usersRes = await fetch(`${API_BASE}/api/admin/users`, {
        headers: { "Authorization": "Bearer " + ADMIN_TOKEN }
      });
      const usersData = await usersRes.json();
      
      const tbody = document.getElementById("userTable");
      tbody.innerHTML = "";

      if(usersData.users && usersData.users.length > 0) {
        usersData.users.forEach(u => {
          // Generate Initials Avatar if no image
          const avatarUrl = u.image || `https://ui-avatars.com/api/?name=${u.username}&background=random&color=fff&bold=true`;
          
          // Determine Status based on progress
          const isActive = u.percentage > 0;
          const statusClass = isActive ? "status-active" : "status-offline";
          const statusText = isActive ? "Active" : "Inactive";
          
          // Date formatting
          const joinDate = new Date(u.created_at).toLocaleDateString();

          const row = `
            <tr>
              <td>
                <div class="user-cell">
                  <img src="${avatarUrl}" class="user-img" alt="${u.username}">
                  <div class="user-details">
                    <h5>${u.username}</h5>
                    <span>${u.email}</span>
                  </div>
                </div>
              </td>
              <td>
                <span class="status-badge ${statusClass}">${statusText}</span>
              </td>
              <td>
                <div class="progress-wrapper">
                  <div class="progress-info">
                    <span>${u.percentage}%</span>
                  </div>
                  <div class="progress-bg">
                    <div class="progress-bar" style="width: ${u.percentage}%"></div>
                  </div>
                </div>
              </td>
              <td style="color:var(--text-muted); font-size:0.85rem;">${joinDate}</td>
              <td>
                <div class="action-group">
                  <button class="btn-icon btn-edit" onclick="resetUser('${u._id}')" title="Reset Progress"><i class="fas fa-undo"></i></button>
                  <button class="btn-icon btn-trash" onclick="deleteUser('${u._id}')" title="Delete User"><i class="fas fa-trash-alt"></i></button>
                </div>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } else {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No users registered yet.</td></tr>`;
      }

    } catch (e) {
      console.error(e);
      // alert("Session expired. Please login again.");
      // logout();
    }
  }

  // --- UTILS & ACTIONS ---
  function animateValue(id, end) {
    const obj = document.getElementById(id);
    let start = 0; const duration = 800; let startTime = null;
    function step(timestamp) {
      if (!startTime) startTime = timestamp;
      const progress = Math.min((timestamp - startTime) / duration, 1);
      obj.innerHTML = Math.floor(progress * (end - start) + start);
      if (progress < 1) window.requestAnimationFrame(step);
    }
    window.requestAnimationFrame(step);
  }

  async function resetUser(id) {
    if(!confirm("Reset this user's progress to 0%?")) return;
    await fetch(`${API_BASE}/api/admin/user/${id}/reset`, { 
      method: "POST", headers: { "Authorization": "Bearer " + ADMIN_TOKEN } 
    });
    loadDashboard();
  }

  async function deleteUser(id) {
    if(!confirm("Are you sure? This action cannot be undone.")) return;
    await fetch(`${API_BASE}/api/admin/user/${id}/purge`, { 
      method: "POST", headers: { "Authorization": "Bearer " + ADMIN_TOKEN } 
    });
    loadDashboard();
  }

  function filterUsers(query) {
    const filter = query.toLowerCase();
    const rows = document.getElementById("userTable").getElementsByTagName("tr");
    for (let i = 0; i < rows.length; i++) {
      const userCell = rows[i].getElementsByTagName("td")[0];
      if (userCell) {
        const txtValue = userCell.textContent || userCell.innerText;
        rows[i].style.display = txtValue.toLowerCase().indexOf(filter) > -1 ? "" : "none";
      }
    }
  }

  function exportData() {
    alert("Generating report... (This feature would download a CSV in production)");
  }

  function logout() {
    localStorage.removeItem("mindstep_admin_token");
    window.location.href = "AdminLogin.html";
  }

  // Init
  loadDashboard();

</script>

</body>
</html> 