<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MindStep Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
/* (exact same CSS as you provided earlier) */
:root{--cyan:#00eaff;--blue:#4d7cff;--pink:#ff3ea5;--glass:rgba(255,255,255,0.08);--border:rgba(255,255,255,0.15);}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter, sans-serif;}html{scroll-behavior:smooth}body{background:radial-gradient(circle at 20% 20%, rgba(0,150,255,0.22), transparent 60%),radial-gradient(circle at 80% 70%, rgba(255,0,140,0.22), transparent 60%),linear-gradient(135deg, #04040d, #090922 50%, #050515 100%);height:100vh;overflow-x:hidden;animation:bgMove 16s ease infinite;color:white;}
@keyframes bgMove {0%{background-position:0% 0%;}50%{background-position:100% 80%;}100%{background-position:0% 0%;}}
body::before{content:"";position:fixed;inset:0;pointer-events:none;background-image:radial-gradient(2px 2px at 30% 40%, rgba(0,229,255,0.6), transparent),radial-gradient(2px 2px at 75% 65%, rgba(255,62,160,0.6), transparent),radial-gradient(1px 1px at 50% 85%, rgba(255,255,255,0.5), transparent);animation:float 25s infinite ease-in-out;opacity:.4;}
@keyframes float{0%{transform:translateY(0);}50%{transform:translateY(-50px);}100%{transform:translateY(0);}}
nav{width:100%;padding:16px 28px;display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.03);border-bottom:1px solid var(--border);backdrop-filter:blur(12px);position:sticky;top:0;z-index:1000;}
.logo{font-family:Orbitron;font-size:24px;font-weight:700;text-shadow:0 0 15px var(--cyan);}
.nav-btn{padding:10px 18px;background:linear-gradient(90deg,var(--pink),var(--blue));border-radius:12px;color:white;border:none;cursor:pointer;font-weight:700;transition:.3s;}
.nav-btn:hover{transform:scale(1.05);}
.dashboard{display:grid;grid-template-columns:260px auto;min-height:calc(100vh - 70px);}
.sidebar{background:rgba(255,255,255,0.04);backdrop-filter:blur(18px);border-right:1px solid rgba(255,255,255,0.15);padding:20px;}
.sidebar h3{font-family:Orbitron;margin-bottom:20px;}
.side-link{padding:12px;margin-bottom:10px;border-radius:12px;cursor:pointer;color:#d8eaff;transition:.3s;}
.side-link:hover{background:rgba(255,255,255,0.1);color:var(--cyan);box-shadow:0 0 12px var(--cyan);}
.content{padding:30px;overflow-y:auto;}
.page-title{font-family:Orbitron;font-size:28px;text-shadow:0 0 12px var(--cyan);}
.widgets{margin-top:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;}
.widget{background:rgba(255,255,255,0.06);padding:18px;border-radius:14px;backdrop-filter:blur(14px);border:1px solid rgba(255,255,255,0.15);text-align:center;box-shadow:0 0 20px rgba(0,0,0,0.35);transform:translateY(20px);opacity:0;transition:.6s;}
.widget.show{opacity:1;transform:translateY(0);}
.widget h4{font-size:14px;opacity:.85;}
.widget .value{margin-top:8px;font-size:28px;font-weight:700;text-shadow:0 0 10px var(--cyan);}
.table-box{margin-top:30px;background:rgba(255,255,255,0.08);padding:20px;border-radius:14px;backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.15);box-shadow:0 0 20px rgba(0,0,0,0.35);}
.table-box h3{font-family:Orbitron;font-size:20px;margin-bottom:12px;}
table{width:100%;border-collapse:collapse;font-size:14px;}
table th, table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:left;vertical-align:middle;}
table th{background:rgba(255,255,255,0.06);font-weight:700;}
table img.user-thumb{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.06);}
.action-btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;margin-right:6px;font-weight:700;}
.view-btn{background:rgba(0,229,255,0.12);color:var(--cyan);}
.edit-btn{background:rgba(255,62,160,0.10);color:var(--pink);}
.delete-btn{background:rgba(255,80,80,0.08);color:#ff7777;}
.reset-btn{background:rgba(255,255,255,0.06);color:#fff;}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:2000;}
.modal{width:520px;background:rgba(255,255,255,0.03);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);backdrop-filter:blur(10px);}
.modal h3{font-family:Orbitron;margin-bottom:8px;}
.input-row{display:flex;gap:12px;}
.form-field{margin:10px 0;}
.form-field label{display:block;margin-bottom:6px;font-size:13px;}
.form-field input[type="text"], .form-field input[type="email"], .form-field input[type="password"]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);color:#fff;outline:none;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.small{font-size:12px;opacity:.8;}
.upload-preview{width:80px;height:80px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.06);}
.footer-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:12px;}
@media(max-width:820px){.dashboard{grid-template-columns:1fr;} .sidebar{display:none;} .modal{width:92%;}}
</style>
</head>
<body>

<nav>
  <div class="logo">Admin Panel</div>
  <div style="display:flex;gap:12px;align-items:center">
    <button class="nav-btn" id="addCourseBtn">+ Add Course</button>
    <button class="nav-btn" id="logoutBtn">Logout</button>
  </div>
</nav>

<div class="dashboard">

  <div class="sidebar">
    <h3>Dashboard</h3>
    <div class="side-link">Overview</div>
    <div class="side-link">Users</div>
    <div class="side-link">Courses</div>
    <div class="side-link">Reports</div>
    <div class="side-link">Settings</div>
  </div>

  <div class="content">
    <div class="page-title">Welcome, Admin</div>

    <div class="widgets">
      <div class="widget"><h4>Total Users</h4><div class="value" id="uCount">0</div></div>
      <div class="widget"><h4>Active Courses</h4><div class="value" id="cCount">0</div></div>
      <div class="widget"><h4>Daily Visits</h4><div class="value" id="vCount">224</div></div>
      <div class="widget"><h4>Reports</h4><div class="value" id="rCount">3</div></div>
    </div>

    <div class="table-box">
      <h3>Registered Users</h3>
      <table id="adminTable">
        <thead>
          <tr>
            <th></th>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Progress</th>
            <th>Lessons Done</th>
            <th>Joined</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="userRows"></tbody>
      </table>
    </div>

  </div>
</div>

<!-- VIEW / EDIT USER MODAL -->
<div class="modal-overlay" id="userModal">
  <div class="modal">
    <h3 id="modalTitle">View User</h3>

    <div style="display:flex;gap:14px;align-items:center">
      <img id="modalImage" class="upload-preview" src="" alt="user">
      <div>
        <div id="modalUsername" style="font-weight:700;font-size:18px"></div>
        <div class="small" id="modalEmail"></div>
      </div>
    </div>

    <div class="form-row" style="margin-top:12px">
      <div class="form-field">
        <label>Name</label>
        <input type="text" id="editName">
      </div>
      <div class="form-field">
        <label>Email</label>
        <input type="email" id="editEmail">
      </div>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label>New Password (leave blank to keep)</label>
        <input type="password" id="editPass">
      </div>
      <div class="form-field">
        <label>Upload Image</label>
        <input type="file" id="editImage">
      </div>
    </div>

    <div style="margin-top:10px">
      <div><strong>Progress:</strong> <span id="modalProgress">0%</span></div>
      <div><strong>Lessons Done:</strong> <span id="modalLessons">0</span></div>
    </div>

    <div class="footer-actions">
      <button class="action-btn reset-btn" id="resetProgressBtn">Reset Progress</button>
      <button class="action-btn edit-btn" id="saveUserBtn">Save</button>
      <button class="action-btn delete-btn" id="deleteUserBtn">Delete</button>
    </div>
  </div>
</div>

<!-- ADD COURSE MODAL -->
<div class="modal-overlay" id="courseModal">
  <div class="modal">
    <h3>Add Course</h3>
    <div class="form-field">
      <label>Course Title</label>
      <input id="courseTitle" type="text" placeholder="e.g. Full Stack">
    </div>
    <div class="form-field">
      <label>Course Description</label>
      <input id="courseDesc" type="text" placeholder="Short description">
    </div>
    <div class="footer-actions">
      <button class="action-btn cancel" id="closeCourse">Cancel</button>
      <button class="action-btn edit-btn" id="saveCourse">Create</button>
    </div>
  </div>
</div>
<script>
function el(id){return document.getElementById(id);}
function toast(msg){console.log("TOAST:", msg);}

document.querySelectorAll(".widget").forEach((w,i)=>setTimeout(()=>w.classList.add("show"),200*i));

if(localStorage.getItem("adminLogged") !== "true"){
  location.href = "AdminLogin.html";
}

el("logoutBtn").onclick = ()=> {
  localStorage.removeItem("adminLogged");
  location.href = "AdminLogin.html";
};

// ---------------- OVERVIEW ----------------
async function loadOverview(){
  try{
    const r = await fetch("/api/admin/overview");
    const d = await r.json();
    if(d.success){
      el("uCount").textContent = d.totalUsers;
      el("cCount").textContent = d.activeCourses || 0;
      el("vCount").textContent = d.dailyVisits || 0;
      el("rCount").textContent = d.reports || 0;
    }
  }catch(e){}
}

// ---------------- USERS TABLE ----------------
async function loadUsers(){
  try{
    const r = await fetch("/api/admin/users");
    const d = await r.json();
    if(!d.success) return;

    const rows = d.users.map(u=>{
      const id = u._id;  // FIXED
      const thumb = u.image ? u.image : "/placeholder.png";
      return `
      <tr data-id="${id}" data-username="${u.username}">
        <td><img src="${thumb}" class="user-thumb" /></td>
        <td>${id.slice(0,8)}</td>
        <td>${u.username}</td>
        <td>${u.email}</td>
        <td>${u.percentage || 0}%</td>
        <td id="lessons-${id}">â€”</td>
        <td>${new Date(u.created_at).toLocaleDateString()}</td>
        <td>
          <button class="action-btn view-btn" data-action="view" data-id="${id}">View</button>
          <button class="action-btn edit-btn" data-action="edit" data-id="${id}">Edit</button>
          <button class="action-btn delete-btn" data-action="delete" data-id="${id}">Delete</button>
        </td>
      </tr>`;
    });

    el("userRows").innerHTML = rows.join("");
    document.querySelectorAll('button[data-action]').forEach(b=> b.onclick = handleRowAction );

  }catch(e){
    console.log(e);
  }
}

// ---------------- ROW ACTION ----------------
async function handleRowAction(e){
  const id = e.target.getAttribute("data-id");
  const action = e.target.getAttribute("data-action");

  if(action === "view" || action === "edit"){
    openUserModal(id, action === "edit");
  } 
  else if(action === "delete"){
    if(confirm("Delete this user permanently?")) {
      await deleteUser(id);
      loadUsers();
      loadOverview();
    }
  }
}

// ---------------- MODAL ----------------
async function openUserModal(id, editable){
  try{
    const res = await fetch(`/api/admin/user/${id}`);
    const d = await res.json();
    if(!d.success) return alert("Unable to fetch user");

    const u = d.user;

    el("modalTitle").textContent = editable ? "Edit User" : "View User";
    el("modalImage").src = u.image || "/placeholder.png";
    el("modalUsername").textContent = u.username;
    el("modalEmail").textContent = u.email;

    el("editName").value = u.username;
    el("editEmail").value = u.email;
    el("editPass").value = "";

    el("modalProgress").textContent = (u.percentage||0) + "%";
    el("modalLessons").textContent = d.lessonsDone || 0;

    el("deleteUserBtn").setAttribute("data-id", id);
    el("saveUserBtn").setAttribute("data-id", id);
    el("resetProgressBtn").setAttribute("data-id", id);

    el("userModal").style.display = "flex";

  }catch(e){}
}

el("saveUserBtn").onclick = async function(){
  const id = this.getAttribute("data-id");
  const name = el("editName").value.trim();
  const email = el("editEmail").value.trim();
  const pass = el("editPass").value;

  if(!name || !email) return alert("Name & email required");

  const body = { username: name, email };
  if(pass) body.password = pass;

  const res = await fetch(`/api/admin/user/${id}`, {
    method: "PUT",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(body)
  });

  const d = await res.json();

  if(d.success){
    const file = el("editImage").files[0];
    if(file){
      const fd = new FormData();
      fd.append("image", file);
      await fetch(`/api/admin/user/${id}/image`, { method: "POST", body: fd });
    }

    alert("Saved");
    el("userModal").style.display = "none";
    loadUsers();
    loadOverview();

  } else alert(d.error || "Save failed");
};

async function deleteUser(id){
  const r = await fetch(`/api/admin/user/${id}/purge`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({force:true})
  });
  const d = await r.json();
  if(!d.success) alert(d.error);
}

el("resetProgressBtn").onclick = async function(){
  const id = this.getAttribute("data-id");
  const r = await fetch(`/api/admin/user/${id}/reset`, { method:"POST" });
  const d = await r.json();

  if(d.success){
    alert("Progress reset");
    el("userModal").style.display = "none";
    loadUsers();
    loadOverview();
  }
};

document.getElementById("userModal").onclick = function(e){
  if(e.target === this) this.style.display = "none";
};

// ---------------- LESSON COUNTS ----------------
async function fillLessonsCounts(){
  const rows = document.querySelectorAll("#userRows tr");
  for(const row of rows){
    const id = row.getAttribute("data-id");
    try{
      const res = await fetch(`/api/admin/user/${id}/lessons`);
      const d = await res.json();
      if(d.success) el(`lessons-${id}`).textContent = d.count || 0;
    }catch(e){}
  }
}

/* course modal */
el("addCourseBtn").onclick = ()=> el("courseModal").style.display = "flex";
el("closeCourse").onclick = ()=> el("courseModal").style.display = "none";

el("saveCourse").onclick = async function(){
  const title = el("courseTitle").value.trim();
  const desc = el("courseDesc").value.trim();
  if(!title) return alert("Course title required");

  const r = await fetch("/api/admin/course", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ title, desc })
  });

  const d = await r.json();
  if(d.success){
    alert("Course added");
    el("courseModal").style.display="none";
    loadOverview();
  }
};

// INIT
(async function(){
  await loadOverview();
  await loadUsers();
  await fillLessonsCounts();
})();
</script>
</body>
</html>
