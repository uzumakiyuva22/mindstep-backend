<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindStep // Command Center</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    /* --- APPLE MACOS DARK THEME --- */
    :root {
      --bg-wallpaper: #000000;
      --bg-wallpaper-image: radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
        radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
        radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);

      --glass-panel: rgba(30, 30, 35, 0.70);
      --glass-sidebar: rgba(20, 20, 25, 0.65);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-highlight: rgba(255, 255, 255, 0.05);

      --text-main: #f5f5f7;
      --text-muted: #86868b;

      --accent-blue: #0a84ff;
      --accent-green: #30d158;
      --accent-red: #ff453a;
      --accent-orange: #ff9f0a;

      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      --radius-l: 18px;
      --radius-m: 12px;
      --radius-s: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      outline: none;
      -webkit-font-smoothing: antialiased;
    }

    body {
      background-color: var(--bg-wallpaper);
      background-image: var(--bg-wallpaper-image);
      background-size: cover;
      color: var(--text-main);
      font-family: var(--font-stack);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* --- SIDEBAR (Frosted Glass) --- */
    .sidebar {
      width: 260px;
      background: var(--glass-sidebar);
      backdrop-filter: blur(25px) saturate(180%);
      -webkit-backdrop-filter: blur(25px) saturate(180%);
      border-right: 1px solid var(--glass-border);
      display: flex;
      flex-direction: column;
      padding: 20px;
      z-index: 20;
    }

    .traffic-lights {
      display: flex;
      gap: 8px;
      margin-bottom: 30px;
      padding-left: 5px;
    }

    .traffic-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .dot-red {
      background: #ff5f56;
      border: 1px solid #e0443e;
    }

    .dot-yellow {
      background: #ffbd2e;
      border: 1px solid #dea123;
    }

    .dot-green {
      background: #27c93f;
      border: 1px solid #1aab29;
    }

    .brand {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      padding-left: 10px;
    }

    .menu-item {
      padding: 10px 12px;
      border-radius: var(--radius-s);
      color: var(--text-main);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: 0.2s;
      margin-bottom: 4px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .menu-item i {
      width: 20px;
      text-align: center;
      color: var(--text-muted);
      transition: 0.2s;
    }

    .menu-item:hover {
      background: var(--glass-highlight);
    }

    .menu-item.active {
      background: rgba(10, 132, 255, 0.2);
      color: var(--accent-blue);
    }

    .menu-item.active i {
      color: var(--accent-blue);
    }

    .logout {
      margin-top: auto;
      color: var(--accent-red);
    }

    .logout i {
      color: var(--accent-red);
    }

    .logout:hover {
      background: rgba(255, 69, 58, 0.1);
    }

    /* --- CONTENT AREA --- */
    .content {
      flex: 1;
      padding: 30px 40px;
      overflow-y: auto;
      position: relative;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .action-bar {
      display: flex;
      gap: 10px;
    }

    /* BUTTONS */
    .btn {
      padding: 8px 16px;
      border-radius: var(--radius-s);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
      transition: all 0.2s ease;
    }

    .btn-glass {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(10px);
    }

    .btn-glass:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
      box-shadow: 0 2px 10px rgba(10, 132, 255, 0.3);
    }

    .btn-primary:hover {
      background: #007aff;
      transform: scale(1.02);
    }

    .btn-danger {
      background: rgba(255, 69, 58, 0.15);
      color: var(--accent-red);
      border: 1px solid rgba(255, 69, 58, 0.3);
    }

    .btn-danger:hover {
      background: rgba(255, 69, 58, 0.25);
    }

    /* WIDGETS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .widget {
      background: var(--glass-panel);
      border: 1px solid var(--glass-border);
      padding: 20px;
      border-radius: var(--radius-l);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s;
    }

    .widget-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .widget-val {
      font-size: 2.2rem;
      font-weight: 700;
      color: #fff;
      letter-spacing: -1px;
    }

    /* TABLES & FORMS */
    .table-wrapper {
      background: var(--glass-panel);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-l);
      overflow: hidden;
      margin-bottom: 30px;
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .toolbar {
      padding: 15px 20px;
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.02);
    }

    .search-spotlight,
    .input-glass,
    textarea {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid var(--glass-border);
      color: #fff;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      width: 100%;
      transition: 0.2s;
      font-family: var(--font-stack);
    }

    .search-spotlight:focus,
    .input-glass:focus,
    textarea:focus {
      border-color: var(--accent-blue);
      background-color: rgba(0, 0, 0, 0.4);
    }

    .filter-select {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      color: var(--text-main);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      width: 100%;
    }

    .filter-select option {
      background: #1c1c1e;
      color: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 15px 20px;
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.75rem;
      text-transform: uppercase;
      border-bottom: 1px solid var(--glass-border);
    }

    td {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      font-size: 0.9rem;
      vertical-align: middle;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.03);
    }

    .checkbox-ios {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 1px solid var(--text-muted);
      border-radius: 4px;
      display: grid;
      place-content: center;
      cursor: pointer;
    }

    .checkbox-ios::before {
      content: "";
      width: 10px;
      height: 10px;
      transform: scale(0);
      transition: 0.1s;
      box-shadow: inset 1em 1em var(--accent-blue);
      transform-origin: center;
      clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
    }

    .checkbox-ios:checked {
      border-color: var(--accent-blue);
      background: var(--accent-blue);
      border: none;
    }

    .checkbox-ios:checked::before {
      transform: scale(1);
      background: #fff;
      box-shadow: none;
    }

    #bulkActionBar {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(30, 30, 35, 0.9);
      backdrop-filter: blur(20px);
      padding: 12px 24px;
      border-radius: 50px;
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 100;
    }

    #bulkActionBar.visible {
      transform: translateX(-50%) translateY(0);
    }

    .avatar-stack {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: #333;
      font-size: 0.85rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-pending {
      background: rgba(255, 159, 10, 0.15);
      color: var(--accent-orange);
    }

    .badge-approved {
      background: rgba(48, 209, 88, 0.15);
      color: var(--accent-green);
    }

    .badge-rejected {
      background: rgba(255, 69, 58, 0.15);
      color: var(--accent-red);
    }

    #toastContainer {
      position: fixed;
      top: 30px;
      right: 30px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 999;
    }

    .toast {
      background: rgba(40, 40, 45, 0.8);
      backdrop-filter: blur(20px);
      color: #fff;
      padding: 14px 20px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 280px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s;
    }

    .toast i.success {
      color: var(--accent-green);
    }

    .toast i.error {
      color: var(--accent-red);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(50px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    /* Screenshot Modal */
    .screenshot-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      align-items: center;
      justify-content: center;
    }

    .screenshot-content {
      max-width: 80%;
      max-height: 80%;
      border-radius: 12px;
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 30px;
      color: #fff;
      cursor: pointer;
    }

    .mobile-tabbar {
      display: none;
    }

    .mobile-tab {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-family: var(--font-stack);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.68rem;
      font-weight: 600;
      border-radius: 12px;
      min-height: 46px;
      cursor: pointer;
      padding: 6px 8px;
      transition: 0.2s ease;
    }

    .mobile-tab i {
      font-size: 1rem;
      line-height: 1;
    }

    .mobile-tab.active {
      color: #fff;
      background: linear-gradient(135deg, rgba(10, 132, 255, 0.75), rgba(128, 90, 213, 0.72));
      box-shadow: 0 8px 20px rgba(10, 132, 255, 0.25);
    }

    @media (max-width: 900px) {
      body {
        display: block;
        min-height: 100dvh;
        height: auto;
        overflow-y: auto;
        overflow-x: hidden;
        background-image:
          radial-gradient(circle at 10% 0%, rgba(90, 132, 255, 0.24) 0, transparent 48%),
          radial-gradient(circle at 100% 100%, rgba(255, 69, 58, 0.18) 0, transparent 46%),
          linear-gradient(165deg, #05070e 0%, #0a0f1e 52%, #121025 100%);
      }

      .sidebar {
        display: none;
      }

      .content {
        padding: 12px;
        padding-bottom: calc(100px + env(safe-area-inset-bottom));
        overflow: visible;
      }

      .header {
        position: sticky;
        top: 8px;
        z-index: 80;
        margin-bottom: 16px;
        padding: 12px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 18px;
        background: linear-gradient(145deg, rgba(12, 16, 30, 0.9), rgba(15, 21, 38, 0.84));
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        box-shadow: 0 14px 28px rgba(2, 6, 23, 0.45);
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
      }

      .header h1 {
        font-size: 1.32rem;
        letter-spacing: -0.3px;
      }

      .action-bar {
        gap: 8px;
      }

      .action-bar .btn {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        padding: 0;
        justify-content: center;
        font-size: 0;
      }

      .action-bar .btn i {
        font-size: 1rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
        margin-bottom: 16px;
      }

      .widget {
        border-radius: 18px;
        padding: 16px;
        background: linear-gradient(150deg, rgba(21, 26, 42, 0.82), rgba(18, 20, 32, 0.78));
        border-color: rgba(255, 255, 255, 0.12);
        animation: slideUp 0.35s ease;
      }

      .widget-title {
        font-size: 0.72rem;
      }

      .widget-val {
        font-size: 2rem;
      }

      .table-wrapper {
        border-radius: 18px;
        margin-bottom: 14px;
        overflow: hidden;
        border-color: rgba(255, 255, 255, 0.12);
        background: linear-gradient(150deg, rgba(18, 24, 40, 0.84), rgba(14, 18, 30, 0.78));
      }

      .toolbar {
        padding: 12px;
        gap: 10px;
        flex-wrap: wrap;
      }

      .toolbar h3 {
        font-size: 0.95rem !important;
      }

      #projectsSection .toolbar>div {
        width: 100%;
        display: grid !important;
        grid-template-columns: 1fr 1fr;
        gap: 8px !important;
      }

      #projectSearch {
        width: 100% !important;
      }

      .search-spotlight,
      .filter-select,
      .input-glass,
      textarea {
        min-height: 44px;
        border-radius: 12px;
      }

      #lessonsSection>div {
        padding: 14px !important;
      }

      #lessonsSection>div>div {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
      }

      table {
        display: block;
        width: 100%;
      }

      thead {
        display: none;
      }

      tbody {
        display: grid;
        gap: 10px;
        padding: 10px;
      }

      tr {
        display: block;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        background: rgba(8, 12, 24, 0.68);
        overflow: hidden;
      }

      tr:hover td {
        background: transparent;
      }

      td {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        font-size: 0.85rem;
      }

      td::before {
        content: attr(data-label);
        font-size: 0.66rem;
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.4px;
        min-width: 86px;
      }

      td:last-child {
        border-bottom: none;
      }

      td[colspan] {
        display: block;
        text-align: center !important;
        padding: 18px 12px !important;
      }

      td[colspan]::before {
        display: none;
      }

      td[data-label="Select"] {
        align-items: center;
        justify-content: flex-end;
      }

      td[data-label="Select"]::before {
        display: none;
      }

      td[data-label="Actions"],
      td[data-label="Quick Actions"] {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        flex-wrap: wrap;
      }

      td[data-label="Actions"]::before,
      td[data-label="Quick Actions"]::before {
        margin-right: auto;
      }

      td[data-label="Identity"],
      td[data-label="Student"],
      td[data-label="User"],
      td[data-label="File Info"],
      td[data-label="Error"] {
        flex-direction: column;
      }

      td[data-label="Identity"]::before,
      td[data-label="Student"]::before,
      td[data-label="User"]::before,
      td[data-label="File Info"]::before,
      td[data-label="Error"]::before {
        min-width: 0;
      }

      td[data-label="Error"]>div {
        max-width: none !important;
        white-space: normal !important;
        overflow: visible !important;
        text-overflow: initial !important;
      }

      td .btn,
      td .btn-glass,
      td .btn-primary,
      td .btn-danger {
        min-width: 38px;
        min-height: 38px;
        border-radius: 11px;
        padding: 7px 10px !important;
      }

      #bulkActionBar {
        left: 12px;
        right: 12px;
        width: auto;
        bottom: calc(82px + env(safe-area-inset-bottom));
        transform: translateY(130%);
        border-radius: 14px;
        padding: 10px 12px;
        gap: 10px;
        justify-content: space-between;
      }

      #bulkActionBar.visible {
        transform: translateY(0);
      }

      #toastContainer {
        top: 84px;
        right: 10px;
        left: 10px;
        align-items: stretch;
      }

      .toast {
        min-width: 0;
        width: 100%;
        border-radius: 12px;
        padding: 12px 14px;
        font-size: 0.85rem;
      }

      .mobile-tabbar {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 6px;
        position: fixed;
        left: 10px;
        right: 10px;
        bottom: calc(10px + env(safe-area-inset-bottom));
        z-index: 120;
        padding: 8px;
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(10, 14, 24, 0.88);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        box-shadow: 0 16px 32px rgba(2, 8, 23, 0.58);
      }

      .screenshot-content {
        max-width: 94%;
        max-height: 78%;
      }
    }

    @media (max-width: 640px) {
      .content {
        padding: 10px;
        padding-bottom: calc(100px + env(safe-area-inset-bottom));
      }

      .header {
        top: 6px;
        padding: 10px;
        border-radius: 15px;
      }

      .header h1 {
        font-size: 1.16rem;
      }

      .widget {
        padding: 14px;
      }

      .widget-val {
        font-size: 1.78rem;
      }

      .toolbar {
        padding: 10px;
      }

      #projectsSection .toolbar>div {
        grid-template-columns: 1fr;
      }

      td {
        font-size: 0.82rem;
        padding: 9px 10px;
      }

      td::before {
        min-width: 72px;
        font-size: 0.62rem;
      }

      .mobile-tabbar {
        left: 8px;
        right: 8px;
        border-radius: 15px;
      }

      .mobile-tab {
        min-height: 44px;
        font-size: 0.62rem;
      }

      .mobile-tab i {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>

  <div class="sidebar">
    <div class="traffic-lights">
      <div class="traffic-dot dot-red"></div>
      <div class="traffic-dot dot-yellow"></div>
      <div class="traffic-dot dot-green"></div>
    </div>

    <div class="brand">Control Center</div>

    <div class="menu-item active" id="menu-users" onclick="switchTab('users')">
      <i class="fas fa-user-friends"></i> Users
    </div>
    <div class="menu-item" id="menu-projects" onclick="switchTab('projects')">
      <i class="fas fa-layer-group"></i> Projects
    </div>
    <div class="menu-item" id="menu-lessons" onclick="switchTab('lessons')">
      <i class="fas fa-book-open"></i> Lessons
    </div>
    <div class="menu-item" id="menu-issues" onclick="switchTab('issues')">
      <i class="fas fa-bug"></i> Issues
    </div>

    <div class="menu-item" style="margin-top: 20px;"><i class="fas fa-chart-pie"></i> Analytics</div>
    <div class="menu-item"><i class="fas fa-sliders-h"></i> Settings</div>

    <div class="menu-item logout" onclick="logout()"><i class="fas fa-power-off"></i> Log Out</div>
  </div>

  <div class="content">
    <div class="header">
      <div>
        <h1 id="pageTitle">Overview</h1>
        <div style="font-size:0.9rem; color:var(--text-muted); margin-top:5px;">System Status: <span
            style="color:var(--accent-green)">Operational</span></div>
      </div>
      <div class="action-bar">
        <button class="btn btn-glass" onclick="exportData()"><i class="fas fa-file-export"></i> Export CSV</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="widget">
        <div class="widget-title">Total Users</div>
        <div class="widget-val" id="totalUsers">-</div>
      </div>
      <div class="widget">
        <div class="widget-title">Active Courses</div>
        <div class="widget-val" id="activeCourses">-</div>
      </div>
      <div class="widget">
        <div class="widget-title">Pending Review</div>
        <div class="widget-val" style="color:var(--accent-orange)" id="pendingCount">0</div>
      </div>
    </div>

    <div id="usersSection" class="table-wrapper">
      <div class="toolbar">
        <h3 style="font-size:1rem; font-weight:600;">User Registry</h3>
        <button class="btn btn-glass" onclick="loadUsers()"><i class="fas fa-sync-alt"></i></button>
      </div>
      <div id="loadingUsers" style="text-align:center; padding:30px; display:none;"><i
          class="fas fa-spinner fa-spin"></i></div>
      <table>
        <thead>
          <tr>
            <th>Identity</th>
            <th>Email</th>
            <th>Progress</th>
            <th>Joined</th>
            <th style="text-align:right;">Actions</th>
          </tr>
        </thead>
        <tbody id="userTable"></tbody>
      </table>
    </div>

    <div id="projectsSection" class="table-wrapper" style="display:none;">
      <div class="toolbar">
        <div style="display:flex; gap:15px; align-items:center;">
          <input type="text" id="projectSearch" class="search-spotlight" placeholder="Search (Cmd+K)"
            onkeyup="searchProjects(this.value)" style="width:220px;">
          <select class="filter-select" onchange="filterProjects(this.value)" style="width:auto;">
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
        <button class="btn btn-glass" onclick="loadProjectSubmissions()"><i class="fas fa-sync-alt"></i></button>
      </div>
      <div id="projectList">
        <table style="width:100%;">
          <thead>
            <tr>
              <th style="width:40px;"><input type="checkbox" class="checkbox-ios" onclick="toggleSelectAll(this)"></th>
              <th>Student</th>
              <th>File Info</th>
              <th>Status</th>
              <th>Date</th>
              <th style="text-align:right;">Quick Actions</th>
            </tr>
          </thead>
          <tbody id="projectTableBody">
            <tr>
              <td colspan="6" style="text-align:center; padding:40px; color:var(--text-muted);">Loading data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="lessonsSection" class="table-wrapper" style="display:none;">
      <div class="toolbar">
        <h3 style="font-size:1rem; font-weight:600;"><i class="fas fa-edit"></i> Lesson Editor</h3>
      </div>
      <div style="padding: 30px; max-width: 800px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div class="form-group">
            <label class="form-label">Course</label>
            <select id="courseSelect" class="filter-select" onchange="loadLessonsForCourse()">
              <option>Loading courses...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Lesson</label>
            <select id="lessonSelect" class="filter-select">
              <option>Select a course first</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Video URL (YouTube/Embed)</label>
          <input id="videoInput" class="input-glass" placeholder="https://www.youtube.com/watch?v=..." />
        </div>

        <div class="form-group">
          <label class="form-label">Lesson Notes</label>
          <textarea id="notesInput" rows="6" placeholder="Enter detailed study notes here..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Study Material (PDF)</label>
          <div style="display:flex; gap:10px; align-items:center;">
            <input type="file" id="pdfInput" accept="application/pdf" style="display:none;"
              onchange="document.getElementById('fileNameDisplay').innerText = this.files[0].name">
            <button class="btn btn-glass" onclick="document.getElementById('pdfInput').click()">
              <i class="fas fa-paperclip"></i> Choose PDF
            </button>
            <span id="fileNameDisplay" style="color:var(--text-muted); font-size:0.9rem;">No file selected</span>
          </div>
        </div>

        <hr style="border:none; border-top:1px solid var(--glass-border); margin: 30px 0;">

        <button class="btn btn-primary" onclick="saveLessonContent()">
          <i class="fas fa-save"></i> Save Changes
        </button>
      </div>
    </div>

    <div id="issuesSection" class="table-wrapper" style="display:none;">
      <div class="toolbar">
        <h3 style="font-size:1rem; font-weight:600;"><i class="fas fa-bug"></i> Bug Reports</h3>
        <button class="btn btn-glass" onclick="loadIssues()">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>Error</th>
            <th>Status</th>
            <th>Date</th>
            <th style="text-align:right;">Actions</th>
          </tr>
        </thead>
        <tbody id="issuesTableBody">
          <tr>
            <td colspan="6" style="text-align:center; padding:40px; color:var(--text-muted);">
              Loading issues...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <nav class="mobile-tabbar" aria-label="Admin mobile navigation">
    <button type="button" class="mobile-tab active" data-tab="users" onclick="switchTab('users')">
      <i class="fas fa-user-friends"></i>
      <span>Users</span>
    </button>
    <button type="button" class="mobile-tab" data-tab="projects" onclick="switchTab('projects')">
      <i class="fas fa-layer-group"></i>
      <span>Projects</span>
    </button>
    <button type="button" class="mobile-tab" data-tab="lessons" onclick="switchTab('lessons')">
      <i class="fas fa-book-open"></i>
      <span>Lessons</span>
    </button>
    <button type="button" class="mobile-tab" data-tab="issues" onclick="switchTab('issues')">
      <i class="fas fa-bug"></i>
      <span>Issues</span>
    </button>
    <button type="button" class="mobile-tab" onclick="logout()">
      <i class="fas fa-power-off"></i>
      <span>Logout</span>
    </button>
  </nav>

  <div id="bulkActionBar">
    <span style="font-weight:600; font-size:0.9rem; color:#fff;"><span id="selectedCount">0</span> Selected</span>
    <div style="height:20px; width:1px; background:rgba(255,255,255,0.2);"></div>
    <button class="btn btn-primary" style="background:var(--accent-green); padding:6px 12px;"
      onclick="bulkAction('approved')">Approve</button>
    <button class="btn btn-danger" style="padding:6px 12px;" onclick="bulkAction('rejected')">Reject</button>
  </div>

  <div id="toastContainer"></div>

  <div id="screenshotModal" class="screenshot-modal" onclick="closeScreenshotModal()">
    <span class="modal-close">&times;</span>
    <img class="screenshot-content" id="modalImg">
  </div>

  <script>
    const ADMIN_TOKEN = localStorage.getItem("mindstep_admin_token");
    if (!ADMIN_TOKEN) window.location.href = "AdminLogin.html";

    let allProjects = [];
    let projectsLoaded = false;
    let currentFilter = 'all';
    let selectedProjects = new Set();

    function getIssueAdminHeaders(includeJson = false) {
      const issueSecret = ADMIN_TOKEN; // Use stored token as secret
      const headers = { "admin_secret": issueSecret };
      if (includeJson) headers["Content-Type"] = "application/json";
      return headers;
    }

    document.addEventListener("DOMContentLoaded", () => {
      init();

      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          if (document.getElementById('projectsSection').style.display !== 'none') {
            document.getElementById('projectSearch').focus();
          }
        }
      });

      setInterval(() => {
        if (projectsLoaded) loadProjectSubmissions();
      }, 30000);
    });

    async function loadOverviewStats() {
      try {
        const res = await fetch("/api/admin/overview", { headers: { "Authorization": "Bearer " + ADMIN_TOKEN } });
        if (res.status === 401) logout();
        const data = await res.json();

        document.getElementById("totalUsers").innerText = data.totalUsers ?? 0;
        document.getElementById("activeCourses").innerText = data.activeCourses ?? 0;
        document.getElementById("pendingCount").innerText = data.pendingCount ?? 0;
      } catch (e) { console.error("Stats load failed", e); }
    }

    function switchTab(tab) {
      document.getElementById('usersSection').style.display = 'none';
      document.getElementById('projectsSection').style.display = 'none';
      document.getElementById('lessonsSection').style.display = 'none';
      document.getElementById('issuesSection').style.display = 'none'; // ✅ Hide Issues

      document.getElementById('menu-users').classList.remove('active');
      document.getElementById('menu-projects').classList.remove('active');
      document.getElementById('menu-lessons').classList.remove('active');
      document.getElementById('menu-issues').classList.remove('active'); // ✅ Remove Active
      document.querySelectorAll('.mobile-tab[data-tab]').forEach((tabBtn) => tabBtn.classList.remove('active'));

      if (tab === 'users') {
        document.getElementById('usersSection').style.display = 'block';
        document.getElementById('menu-users').classList.add('active');
        document.getElementById('pageTitle').innerText = "User Management";
      } else if (tab === 'projects') {
        document.getElementById('projectsSection').style.display = 'block';
        document.getElementById('menu-projects').classList.add('active');
        document.getElementById('pageTitle').innerText = "Project Submissions";
        loadOverviewStats();
        if (!projectsLoaded) {
          loadProjectSubmissions();
          projectsLoaded = true;
        }
      } else if (tab === 'lessons') {
        document.getElementById('lessonsSection').style.display = 'block';
        document.getElementById('menu-lessons').classList.add('active');
        document.getElementById('pageTitle').innerText = "Lesson Content Editor";
        loadCoursesForLessons();
      } else if (tab === 'issues') { // ✅ Load Issues
        document.getElementById('issuesSection').style.display = 'block';
        document.getElementById('menu-issues').classList.add('active');
        document.getElementById('pageTitle').innerText = "Bug Reports";
        loadIssues();
      }

      const mobileActiveTab = document.querySelector(`.mobile-tab[data-tab="${tab}"]`);
      if (mobileActiveTab) mobileActiveTab.classList.add('active');
    }

    async function init() {
      await loadOverviewStats();
      loadUsers();
    }

    // ... (Existing User & Project Functions: loadUsers, openUserProjects, loadProjectSubmissions, etc. remain unchanged) ...

    async function loadUsers() {
      const tbody = document.getElementById("userTable");
      document.getElementById("loadingUsers").style.display = 'block';
      tbody.innerHTML = '';

      const res = await fetch("/api/admin/users", { headers: { "Authorization": "Bearer " + ADMIN_TOKEN } });
      const data = await res.json();
      document.getElementById("loadingUsers").style.display = 'none';

      if (!data.users || data.users.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--text-muted); padding:30px;">No users found.</td></tr>`;
        return;
      }

      tbody.innerHTML = data.users.map(u => `
    <tr>
      <td data-label="Identity">
        <div class="avatar-stack">
          <div class="avatar">${u.username[0].toUpperCase()}</div>
          <b>${u.username}</b>
        </div>
      </td>
      <td data-label="Email"><span style="color:var(--text-muted)">${u.email}</span></td>
      <td data-label="Progress">
        <div style="display:flex; align-items:center; gap:10px;">
          <div style="flex:1; height:4px; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden; width:80px;">
            <div style="width:${u.percentage}%; height:100%; background:var(--accent-blue);"></div>
          </div>
          <span style="font-size:0.75rem; font-weight:600;">${u.percentage}%</span>
        </div>
      </td>
      <td data-label="Joined" style="font-size:0.85rem; color:var(--text-muted);">${new Date(u.created_at).toLocaleDateString()}</td>
      <td data-label="Actions" style="text-align:right;">
        <button class="btn-glass" style="padding:6px 10px; margin-right:5px;" onclick="openUserProjects('${u._id}')" title="View Projects"><i class="fas fa-folder-open"></i></button>
        <button class="btn-glass" style="padding:6px 10px; color:var(--accent-red);" onclick="purgeUser('${u._id}')" title="Delete User"><i class="fas fa-trash"></i></button>
      </td>
    </tr>
  `).join("");
    }

    // ... [Existing Project Functions - Condensed for brevity, logic remains same] ...

    // ✅ NEW: ISSUE MANAGEMENT FUNCTIONS
    async function loadIssues() {
      const tbody = document.getElementById("issuesTableBody");
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-muted);">Loading issues...</td></tr>`;

      try {
        const res = await fetch("/api/issues", {
          headers: getIssueAdminHeaders()
        });

        const data = await res.json();

        if (!data.data || data.data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-muted);">No issues found.</td></tr>`;
          return;
        }

        tbody.innerHTML = data.data.map(issue => {
          let badgeClass = issue.status === 'Resolved' ? 'badge-approved' : 'badge-pending';

          return `
      <tr>
        <td data-label="ID" style="font-family:monospace; font-size:0.8rem; color:var(--text-muted);">${issue._id.substring(0, 8)}...</td>
        <td data-label="User">
            <div style="font-weight:600;">User: ${issue.userId?.username || issue.userId}</div>
            <div style="font-size:0.8rem; color:var(--text-muted);">Lesson: ${issue.lessonTitle || issue.lessonId?.title || "Unknown Lesson"}</div>
        </td>
        <td data-label="Error">
            <div style="max-width:300px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${issue.errorMessage}">
                <span style="color:var(--accent-red); font-weight:bold;">${issue.errorMessage}</span><br>
                <span style="font-size:0.85rem; color:var(--text-muted);">${issue.description}</span>
            </div>
            ${issue.screenshot ? `<a href="#" onclick="viewScreenshot('${issue.screenshot}'); return false;" style="font-size:0.8rem; color:var(--accent-blue);">View Screenshot</a>` : ''}
        </td>
        <td data-label="Status"><span class="badge ${badgeClass}">${issue.status}</span></td>
        <td data-label="Date" style="font-size:0.85rem; color:var(--text-muted);">${new Date(issue.createdAt).toLocaleDateString()}</td>
        <td data-label="Actions" style="text-align:right;">
          ${issue.status !== 'Resolved' ?
              `<button class="btn btn-primary" style="padding:6px 12px; font-size:0.8rem;" onclick="resolveIssue('${issue._id}')">Resolve</button>` :
              `<span style="color:var(--accent-green); font-size:0.9rem;"><i class="fas fa-check"></i> Done</span>`
            }
        </td>
      </tr>
    `}).join("");

      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--accent-red);">Error loading issues.</td></tr>`;
        console.error(err);
      }
    }

    async function resolveIssue(id) {
      if (!confirm("Mark this issue as resolved?")) return;

      try {
        const res = await fetch(`/api/issues/${id}`, {
          method: "PATCH",
          headers: getIssueAdminHeaders(true),
          body: JSON.stringify({
            status: "Resolved",
            adminReply: "Marked resolved by admin."
          })
        });

        if (res.ok) {
          showToast("Issue resolved successfully", "success");
          loadIssues();
        } else {
          showToast("Failed to resolve issue", "error");
        }
      } catch (e) {
        showToast("Connection error", "error");
      }
    }

    function viewScreenshot(url) {
      const modal = document.getElementById('screenshotModal');
      const img = document.getElementById('modalImg');
      img.src = url;
      modal.style.display = "flex";
    }

    function closeScreenshotModal() {
      document.getElementById('screenshotModal').style.display = "none";
    }

    // ... [Existing Helper Functions: showToast, logout, loadCoursesForLessons, saveLessonContent etc.] ...
    // (Ensure these are present as in previous version)

    async function loadCoursesForLessons() {
      const res = await fetch("/api/public/courses");
      const data = await res.json();
      const select = document.getElementById("courseSelect");

      if (data.results && data.results.length > 0) {
        select.innerHTML = data.results.map(c =>
          `<option value="${c.course.slug}">${c.course.title}</option>`
        ).join("");
        loadLessonsForCourse();
      } else {
        select.innerHTML = "<option>No courses found</option>";
      }
    }

    async function loadLessonsForCourse() {
      const courseSlug = document.getElementById("courseSelect").value;
      const res = await fetch(`/api/course/${courseSlug}/lessons`);
      const data = await res.json();
      const select = document.getElementById("lessonSelect");

      if (data.lessons && data.lessons.length > 0) {
        select.innerHTML = data.lessons.map(l =>
          `<option value="${l._id}">${l.title}</option>`
        ).join("");
      } else {
        select.innerHTML = "<option>No lessons found</option>";
      }
    }

    async function saveLessonContent() {
      const lessonId = document.getElementById("lessonSelect").value;
      if (!lessonId) return showToast("Select a lesson first", "error");

      await fetch(`/api/admin/lesson/${lessonId}/content`, {
        method: "PUT",
        headers: {
          "Authorization": "Bearer " + ADMIN_TOKEN,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          video: document.getElementById("videoInput").value,
          notes: document.getElementById("notesInput").value
        })
      });

      const pdfFile = document.getElementById("pdfInput").files[0];
      if (pdfFile) {
        const fd = new FormData();
        fd.append("pdf", pdfFile);
        await fetch(`/api/admin/lesson/${lessonId}/pdf`, {
          method: "POST",
          headers: { "Authorization": "Bearer " + ADMIN_TOKEN },
          body: fd
        });
      }

      showToast("Lesson updated successfully", "success");
    }

    function showToast(msg, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle success' : 'fa-exclamation-circle error'}"></i> ${msg}`;
      container.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300) }, 3000);
    }

    function logout() {
      localStorage.removeItem("mindstep_admin_token");
      window.location.href = "AdminLogin.html";
    }

    let currentSearch = '';

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function formatBytes(size) {
      const n = Number(size || 0);
      if (!Number.isFinite(n) || n <= 0) return "0 B";
      const units = ["B", "KB", "MB", "GB"];
      let value = n;
      let idx = 0;
      while (value >= 1024 && idx < units.length - 1) {
        value /= 1024;
        idx++;
      }
      return `${value.toFixed(idx === 0 ? 0 : 1)} ${units[idx]}`;
    }

    function normalizeProject(project) {
      const userObject = project && project.userId && typeof project.userId === "object" ? project.userId : null;
      const lessonObject = project && project.lessonId && typeof project.lessonId === "object" ? project.lessonId : null;
      const courseObject = project && project.courseId && typeof project.courseId === "object" ? project.courseId : null;
      const userRef = userObject ? String(userObject._id || "") : String(project?.userId || "");
      return {
        ...project,
        _id: String(project?._id || ""),
        status: String(project?.status || "pending").toLowerCase(),
        createdAt: project?.createdAt || project?.created_at || null,
        originalName: String(project?.originalName || project?.storedName || "submission"),
        fileSize: Number(project?.fileSize || 0),
        userRef,
        userName: userObject?.username || "Unknown User",
        userEmail: userObject?.email || "",
        courseName: courseObject?.title || String(project?.courseId || "Unknown Course"),
        lessonTitle: lessonObject?.title || String(project?.lessonId || "Unknown Lesson"),
        adminFeedback: String(project?.adminFeedback || project?.reviewComment || "")
      };
    }

    function isFinalMernProjectSubmission(project) {
      const fileName = String(project?.originalName || "").trim().toLowerCase().replace(/\s+/g, "_");
      return /^final_mern_project_submission(?:\.[a-z0-9]+)?$/.test(fileName);
    }

    function getFilteredProjects() {
      return allProjects.filter((project) => {
        if (currentFilter !== "all" && project.status !== currentFilter) return false;

        if (!currentSearch) return true;
        const haystack = [
          project.userName,
          project.userEmail,
          project.userRef,
          project.lessonTitle,
          project.originalName,
          project.status
        ].join(" ").toLowerCase();
        return haystack.includes(currentSearch);
      });
    }

    function getStatusBadgeClass(status) {
      if (status === "approved") return "badge-approved";
      if (status === "rejected") return "badge-rejected";
      return "badge-pending";
    }

    function getStatusLabel(status) {
      return status ? status.charAt(0).toUpperCase() + status.slice(1) : "Pending";
    }

    async function loadProjectSubmissions() {
      const tbody = document.getElementById("projectTableBody");
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--text-muted);">Loading data...</td></tr>`;

      try {
        const res = await fetch("/api/admin/projects", {
          headers: { "Authorization": "Bearer " + ADMIN_TOKEN }
        });
        if (res.status === 401 || res.status === 403) {
          logout();
          return;
        }

        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.message || "Failed to load project submissions");
        }

        allProjects = (data.projects || []).map(normalizeProject);
        selectedProjects.clear();
        updatePendingCount();
        renderProjects(getFilteredProjects());
      } catch (err) {
        console.error("Project load failed:", err);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--accent-red);">Error loading projects.</td></tr>`;
        showToast("Failed to load project submissions", "error");
      } finally {
        updateBulkBar();
      }
    }

    function updatePendingCount() {
      const pending = allProjects.filter(p => p.status === "pending").length;
      document.getElementById("pendingCount").innerText = pending;
    }

    function renderProjects(projects) {
      const tbody = document.getElementById("projectTableBody");
      if (!projects || projects.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--text-muted);">No project submissions found.</td></tr>`;
        const selectAll = document.querySelector('#projectsSection thead .checkbox-ios');
        if (selectAll) {
          selectAll.checked = false;
          selectAll.indeterminate = false;
        }
        return;
      }

      tbody.innerHTML = projects.map((p) => {
        const displayDate = p.createdAt ? new Date(p.createdAt).toLocaleString() : "N/A";
        const badgeClass = getStatusBadgeClass(p.status);
        const canApprove = p.status !== "approved";
        const canReject = p.status !== "rejected";
        const canSendCertificate = p.status === "approved" && isFinalMernProjectSubmission(p);
        const initials = (p.userName || "?").charAt(0).toUpperCase();

        return `
          <tr>
            <td data-label="Select"><input type="checkbox" class="checkbox-ios" ${selectedProjects.has(p._id) ? "checked" : ""} onchange="toggleSelect('${escapeHtml(p._id)}', this.checked)"></td>
            <td data-label="Student">
              <div class="avatar-stack">
                <div class="avatar">${escapeHtml(initials)}</div>
                <div>
                  <div style="font-weight:600;">${escapeHtml(p.userName)}</div>
                  <div style="font-size:0.8rem; color:var(--text-muted);">${escapeHtml(p.userEmail || p.userRef || "Unknown")}</div>
                </div>
              </div>
            </td>
            <td data-label="File Info">
              <div style="font-weight:600;">${escapeHtml(p.originalName)}</div>
              <div style="font-size:0.8rem; color:var(--text-muted);">${escapeHtml(p.courseName)} / ${escapeHtml(p.lessonTitle)} - ${formatBytes(p.fileSize)}</div>
              ${p.adminFeedback ? `<div style="font-size:0.78rem; color:#fca5a5; margin-top:6px;">Feedback: ${escapeHtml(p.adminFeedback)}</div>` : ""}
            </td>
            <td data-label="Status"><span class="badge ${badgeClass}">${escapeHtml(getStatusLabel(p.status))}</span></td>
            <td data-label="Date" style="font-size:0.85rem; color:var(--text-muted);">${escapeHtml(displayDate)}</td>
            <td data-label="Quick Actions" style="text-align:right; white-space:nowrap;">
              <button class="btn btn-glass" style="padding:6px 10px; margin-right:6px;" onclick="downloadProject('${escapeHtml(p._id)}')" title="Download">
                <i class="fas fa-download"></i>
              </button>
              ${canSendCertificate ? `<button class="btn btn-glass" style="padding:6px 10px; margin-right:6px;" onclick="sendCertificateEmail('${escapeHtml(p._id)}')" title="Send Certificate Email"><i class="fas fa-envelope"></i></button>` : ""}
              ${canApprove ? `<button class="btn btn-primary" style="padding:6px 10px; margin-right:6px;" onclick="updateProjectStatus('${escapeHtml(p._id)}','approved')" title="Approve"><i class="fas fa-check"></i></button>` : ""}
              ${canReject ? `<button class="btn btn-danger" style="padding:6px 10px; margin-right:6px;" onclick="updateProjectStatus('${escapeHtml(p._id)}','rejected')" title="Reject"><i class="fas fa-times"></i></button>` : ""}
              ${canReject ? `<button class="btn btn-glass" style="padding:6px 10px;" onclick="updateProjectStatus('${escapeHtml(p._id)}','request_changes')" title="Request Changes"><i class="fas fa-comment-dots"></i></button>` : ""}
            </td>
          </tr>
        `;
      }).join("");

      const visibleIds = projects.map(p => p._id);
      const selectedVisibleCount = visibleIds.filter(id => selectedProjects.has(id)).length;
      const selectAll = document.querySelector('#projectsSection thead .checkbox-ios');
      if (selectAll) {
        selectAll.checked = visibleIds.length > 0 && selectedVisibleCount === visibleIds.length;
        selectAll.indeterminate = selectedVisibleCount > 0 && selectedVisibleCount < visibleIds.length;
      }
    }

    function applyProjectFilters() {
      renderProjects(getFilteredProjects());
      updateBulkBar();
    }

    function searchProjects(val) {
      currentSearch = String(val || "").trim().toLowerCase();
      applyProjectFilters();
    }

    function filterProjects(status) {
      currentFilter = status || "all";
      applyProjectFilters();
    }

    async function openUserProjects(userId) {
      switchTab('projects');
      if (!projectsLoaded) {
        await loadProjectSubmissions();
        projectsLoaded = true;
      }
      const searchInput = document.getElementById("projectSearch");
      if (searchInput) {
        searchInput.value = String(userId || "");
      }
      searchProjects(String(userId || ""));
    }

    async function purgeUser(id) {
      if (!confirm("Delete this user and all related data permanently?")) return;
      try {
        const res = await fetch(`/api/admin/user/${id}/purge`, {
          method: "POST",
          headers: { "Authorization": "Bearer " + ADMIN_TOKEN }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
          throw new Error(data.message || "Failed to delete user");
        }
        showToast("User purged successfully", "success");
        loadUsers();
        if (projectsLoaded) loadProjectSubmissions();
        loadOverviewStats();
      } catch (err) {
        console.error(err);
        showToast(err.message || "User purge failed", "error");
      }
    }

    function exportData() {
      const rows = getFilteredProjects();
      if (!rows.length) {
        showToast("No rows to export", "error");
        return;
      }
      const header = ["Project ID", "Student", "Email", "User ID", "Lesson", "File", "Size Bytes", "Status", "Created At"];
      const csvRows = [
        header.join(","),
        ...rows.map((p) => [
          p._id,
          p.userName,
          p.userEmail,
          p.userRef,
          p.lessonTitle,
          p.originalName,
          p.fileSize,
          p.status,
          p.createdAt || ""
        ].map(v => `"${String(v ?? "").replace(/"/g, '""')}"`).join(","))
      ];
      const blob = new Blob([csvRows.join("\n")], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const ts = new Date().toISOString().replace(/[:.]/g, "-");
      link.href = URL.createObjectURL(blob);
      link.download = `project-submissions-${ts}.csv`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(link.href);
    }

    function toggleSelectAll(source) {
      const visible = getFilteredProjects();
      visible.forEach((p) => {
        if (source.checked) selectedProjects.add(p._id);
        else selectedProjects.delete(p._id);
      });
      renderProjects(visible);
      updateBulkBar();
    }

    function toggleSelect(id, checked) {
      if (checked) selectedProjects.add(id);
      else selectedProjects.delete(id);
      updateBulkBar();
      const visible = getFilteredProjects();
      const visibleIds = visible.map(p => p._id);
      const selectedVisibleCount = visibleIds.filter(projectId => selectedProjects.has(projectId)).length;
      const selectAll = document.querySelector('#projectsSection thead .checkbox-ios');
      if (selectAll) {
        selectAll.checked = visibleIds.length > 0 && selectedVisibleCount === visibleIds.length;
        selectAll.indeterminate = selectedVisibleCount > 0 && selectedVisibleCount < visibleIds.length;
      }
    }

    function updateBulkBar() {
      const count = selectedProjects.size;
      document.getElementById("selectedCount").innerText = count;
      const bar = document.getElementById("bulkActionBar");
      if (count > 0) bar.classList.add("visible");
      else bar.classList.remove("visible");
    }

    async function updateProjectStatus(id, status) {
      try {
        let adminFeedback = "";
        if (status === "rejected" || status === "request_changes") {
          const note = prompt("Enter feedback for the learner:");
          if (note === null) return;
          adminFeedback = String(note || "").trim();
          if (!adminFeedback) {
            showToast("Feedback is required for rejection/changes", "warning");
            return;
          }
        }
        const res = await fetch(`/api/admin/projects/${id}/status`, {
          method: "PUT",
          headers: {
            "Authorization": "Bearer " + ADMIN_TOKEN,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ status, adminFeedback })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
          throw new Error(data.message || "Failed to update project status");
        }
        const nextStatus = data?.project?.status || (status === "request_changes" ? "rejected" : status);
        allProjects = allProjects.map((p) => p._id === id
          ? { ...p, status: nextStatus, adminFeedback: data?.project?.adminFeedback || adminFeedback || "" }
          : p
        );
        selectedProjects.delete(id);
        updatePendingCount();
        applyProjectFilters();
        loadOverviewStats();
        showToast(`Project marked as ${nextStatus}`, "success");
        if (data.certificateIssued) {
          showToast("Certificate generated successfully", "success");
        } else if (data.certificateClaimable) {
          showToast("Certificate unlocked. Learner can claim now.", "success");
        }
        if (data.certificateEmail?.success && !data.certificateEmail?.alreadySent) {
          showToast(`Certificate email sent to ${data.certificateEmail.emailSentTo}`, "success");
        } else if (data.certificateEmail?.alreadySent) {
          showToast(`Certificate email already sent (${data.certificateEmail.emailSentTo})`, "success");
        } else if (data.certificateEmail && !data.certificateEmail.success && data.certificateEmail.message) {
          showToast(data.certificateEmail.message, "error");
        }
      } catch (err) {
        console.error(err);
        showToast(err.message || "Status update failed", "error");
      }
    }

    async function sendCertificateEmail(id) {
      try {
        const selectedProject = allProjects.find((p) => p._id === String(id));
        if (!selectedProject || !isFinalMernProjectSubmission(selectedProject)) {
          showToast("Certificate email option is available only for Final_MERN_Project_Submission.", "error");
          return;
        }

        const res = await fetch(`/api/admin/projects/${id}/send-certificate-email`, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + ADMIN_TOKEN,
            "Content-Type": "application/json"
          }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
          throw new Error(data.message || "Failed to send certificate email");
        }

        const target = data?.emailResult?.emailSentTo ? ` to ${data.emailResult.emailSentTo}` : "";
        showToast(`Certificate email sent${target}`, "success");
        if (projectsLoaded) loadProjectSubmissions();
      } catch (err) {
        console.error(err);
        showToast(err.message || "Failed to send certificate email", "error");
      }
    }

    async function downloadProject(id) {
      try {
        const res = await fetch(`/api/admin/projects/${id}/download`, {
          headers: { "Authorization": "Bearer " + ADMIN_TOKEN }
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.message || "Download failed");
        }
        const blob = await res.blob();
        const contentDisposition = res.headers.get("content-disposition") || "";
        const match = contentDisposition.match(/filename=\"?([^\";]+)\"?/i);
        const filename = match && match[1] ? match[1] : `project-${id}.zip`;

        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
        showToast(err.message || "Unable to download file", "error");
      }
    }

    async function bulkAction(status) {
      const ids = Array.from(selectedProjects);
      if (!ids.length) return;
      if (!confirm(`Update ${ids.length} selected project(s) to '${status}'?`)) return;

      try {
        const results = await Promise.all(ids.map(async (id) => {
          const res = await fetch(`/api/admin/projects/${id}/status`, {
            method: "PUT",
            headers: {
              "Authorization": "Bearer " + ADMIN_TOKEN,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ status })
          });
          return { id, ok: res.ok };
        }));

        const updatedIds = results.filter(r => r.ok).map(r => r.id);
        if (!updatedIds.length) {
          showToast("Bulk action failed", "error");
          return;
        }

        allProjects = allProjects.map((p) => updatedIds.includes(p._id) ? { ...p, status } : p);
        updatedIds.forEach(id => selectedProjects.delete(id));
        updatePendingCount();
        applyProjectFilters();
        loadOverviewStats();
        showToast(`Updated ${updatedIds.length} project(s)`, "success");
      } catch (err) {
        console.error(err);
        showToast("Bulk action failed", "error");
      }
    }

  </script>
</body>

</html>
