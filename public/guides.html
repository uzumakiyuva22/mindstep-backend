<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MindStep - Course Guides</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Orbitron:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #04070f;
      --panel: rgba(16, 20, 32, 0.9);
      --panel-2: rgba(255, 255, 255, 0.03);
      --border: rgba(148, 163, 184, 0.22);
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --accent-2: #8b5cf6;
    }

    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 12% 20%, rgba(56, 189, 248, 0.12), transparent 45%),
        radial-gradient(circle at 85% 85%, rgba(139, 92, 246, 0.12), transparent 46%),
        var(--bg);
      min-height: 100vh;
    }

    nav {
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 26px;
      border-bottom: 1px solid var(--border);
      background: rgba(4, 7, 15, 0.88);
      backdrop-filter: blur(14px);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: "Orbitron", sans-serif;
      letter-spacing: 0.5px;
      font-weight: 700;
    }
    .brand i {
      color: var(--accent);
      font-size: 1.25rem;
    }
    .nav-links {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .nav-links a {
      text-decoration: none;
      color: var(--muted);
      font-weight: 600;
      font-size: 0.9rem;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid transparent;
      transition: 0.2s ease;
    }
    .nav-links a:hover,
    .nav-links a.active {
      color: #fff;
      border-color: var(--border);
      background: rgba(255, 255, 255, 0.05);
    }

    .page {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px;
    }

    .sidebar {
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: 16px;
      padding: 16px;
      height: calc(100vh - 92px);
      position: sticky;
      top: 74px;
      overflow: auto;
    }
    .side-title {
      margin: 0 0 6px;
      font-size: 1.05rem;
      font-weight: 700;
    }
    .side-desc {
      color: var(--muted);
      font-size: 0.84rem;
      line-height: 1.5;
      margin: 0 0 14px;
    }
    .course-list {
      display: grid;
      gap: 8px;
    }
    .course-btn {
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      border-radius: 12px;
      padding: 12px;
      text-align: left;
      cursor: pointer;
      transition: 0.2s;
    }
    .course-btn:hover {
      border-color: rgba(56, 189, 248, 0.5);
    }
    .course-btn.active {
      border-color: rgba(56, 189, 248, 0.75);
      background: rgba(56, 189, 248, 0.1);
    }
    .course-name {
      margin: 0 0 4px;
      font-size: 0.94rem;
      font-weight: 700;
      color: #f8fafc;
    }
    .course-meta {
      margin: 0;
      color: var(--muted);
      font-size: 0.78rem;
    }

    .content {
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: 16px;
      padding: 22px;
      min-height: calc(100vh - 92px);
    }
    .guide-header h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: -0.5px;
    }
    .guide-header p {
      margin: 10px 0 0;
      color: var(--muted);
      line-height: 1.6;
      max-width: 900px;
    }
    .quick-row {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .chip {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 0.78rem;
      color: #cbd5e1;
      background: rgba(255, 255, 255, 0.02);
    }

    .block {
      margin-top: 24px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.02);
      overflow: hidden;
    }
    .block-head {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      background: rgba(2, 6, 23, 0.45);
      font-weight: 700;
      color: #dbeafe;
      font-size: 0.92rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .block-body {
      padding: 14px;
    }

    .lesson-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      background: rgba(15, 23, 42, 0.35);
      margin-bottom: 12px;
    }
    .lesson-title-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .lesson-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      color: #f8fafc;
    }
    .lesson-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .badge {
      font-size: 0.72rem;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: #cbd5e1;
      text-transform: uppercase;
      letter-spacing: 0.2px;
    }
    .badge.theory { background: rgba(56, 189, 248, 0.15); color: #7dd3fc; }
    .badge.project { background: rgba(245, 158, 11, 0.16); color: #fbbf24; }
    .badge.practice { background: rgba(34, 197, 94, 0.16); color: #86efac; }

    .lesson-desc {
      margin: 10px 0 0;
      color: var(--muted);
      line-height: 1.58;
      font-size: 0.9rem;
    }
    .mini-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 10px;
    }
    .mini-box {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.02);
      padding: 10px;
    }
    .mini-box h4 {
      margin: 0 0 8px;
      font-size: 0.8rem;
      color: #93c5fd;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .mini-box ul {
      margin: 0;
      padding-left: 18px;
      color: #cbd5e1;
      font-size: 0.84rem;
      line-height: 1.45;
    }
    .mini-box li { margin-bottom: 5px; }

    .playbook {
      display: grid;
      gap: 10px;
    }
    .playbook-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 11px;
      background: rgba(255, 255, 255, 0.02);
    }
    .playbook-item strong { color: #f8fafc; }
    .playbook-item p {
      margin: 6px 0 0;
      color: var(--muted);
      line-height: 1.55;
      font-size: 0.88rem;
    }

    .empty {
      text-align: center;
      color: var(--muted);
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 30px 18px;
      margin-top: 16px;
    }

    @media (max-width: 1080px) {
      .page {
        grid-template-columns: 1fr;
      }
      .sidebar {
        position: static;
        height: auto;
      }
      .content {
        min-height: auto;
      }
    }

    @media (max-width: 700px) {
      nav {
        padding: 12px 14px;
      }
      .brand span {
        display: none;
      }
      .nav-links {
        gap: 6px;
      }
      .nav-links a {
        padding: 6px 8px;
        font-size: 0.8rem;
      }
      .content {
        padding: 14px;
      }
      .guide-header h1 {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body>

  <nav>
    <div class="brand">
      <i class="fas fa-compass"></i>
      <span>MindStep Guides</span>
    </div>
    <div class="nav-links">
      <a href="MainPage.html">Dashboard</a>
      <a href="guides.html" class="active">Guides</a>
      <a href="About.html">About</a>
    </div>
  </nav>

  <main class="page">
    <aside class="sidebar">
      <h3 class="side-title">Course Guide Index</h3>
      <p class="side-desc">Choose a course to view lesson-by-lesson learning guide, implementation path, and submission checklist.</p>
      <div class="course-list" id="courseList">
        <div class="empty">Loading courses...</div>
      </div>
    </aside>

    <section class="content" id="guideRoot">
      <div class="guide-header">
        <h1>Loading Guide...</h1>
        <p>Fetching your course and lesson details.</p>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = window.location.origin;

    const state = {
      courses: [],
      activeSlug: null,
      lessonsBySlug: new Map()
    };

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function asArray(value) {
      return Array.isArray(value) ? value.filter(Boolean) : [];
    }

    function typeClass(type) {
      const t = String(type || "").toLowerCase();
      if (t === "project") return "project";
      if (t === "practice") return "practice";
      return "theory";
    }

    function getLessonSteps(lessonDoc) {
      const details = lessonDoc.lesson || {};
      const stepCandidates = [
        details.stepByStepImplementation,
        details.stepByStepGuide,
        details.projectUploadSection && details.projectUploadSection.uploadSteps,
        details.userTask && details.userTask.instructions
      ];
      for (const candidate of stepCandidates) {
        const list = asArray(candidate);
        if (list.length) return list.slice(0, 5);
      }
      return [];
    }

    function getLearningOutcomes(lessonDoc) {
      const details = lessonDoc.lesson || {};
      return asArray(details.learningOutcomes).slice(0, 4);
    }

    function getConcepts(lessonDoc) {
      const details = lessonDoc.lesson || {};
      const concepts = asArray(details.conceptBreakdown).slice(0, 3).map((item) => {
        if (item && typeof item === "object") {
          const concept = item.concept || "Concept";
          const explanation = item.explanation || "";
          return `${concept}: ${explanation}`.trim();
        }
        return String(item);
      });
      return concepts;
    }

    function getUploadChecklist(lessonDoc) {
      const details = lessonDoc.lesson || {};
      const upload = details.projectUploadSection || {};
      const checks = [];

      checks.push(...asArray(upload.allowedFiles).map((f) => `Allowed: ${f}`));
      checks.push(...asArray(upload.notAllowed).slice(0, 3).map((f) => `Avoid: ${f}`));

      const criteria = asArray(details.adminEvaluationCriteria).slice(0, 3);
      checks.push(...criteria.map((c) => `Review check: ${c}`));

      return checks.slice(0, 6);
    }

    async function fetchCourses() {
      const res = await fetch(`${API_BASE}/api/public/courses`);
      const data = await res.json();
      if (!data.success || !Array.isArray(data.results)) return [];
      return data.results
        .map((entry) => ({
          course: entry.course,
          lessonCount: Number(entry.lessonCount || 0)
        }))
        .filter((entry) => entry.course && entry.course.slug);
    }

    async function fetchLessonsForCourse(slug) {
      if (state.lessonsBySlug.has(slug)) return state.lessonsBySlug.get(slug);
      const res = await fetch(`${API_BASE}/api/course/${encodeURIComponent(slug)}/lessons`);
      const data = await res.json();
      const lessons = data.success && Array.isArray(data.lessons) ? data.lessons : [];
      state.lessonsBySlug.set(slug, lessons);
      return lessons;
    }

    function renderSidebar() {
      const list = document.getElementById("courseList");
      if (!state.courses.length) {
        list.innerHTML = '<div class="empty">No courses available.</div>';
        return;
      }

      list.innerHTML = state.courses.map((entry) => {
        const c = entry.course;
        const active = c.slug === state.activeSlug ? "active" : "";
        return `
          <button class="course-btn ${active}" data-slug="${escapeHtml(c.slug)}">
            <p class="course-name">${escapeHtml(c.title || "Untitled Course")}</p>
            <p class="course-meta">${entry.lessonCount} lessons - ${escapeHtml(c.category || "Learning Track")}</p>
          </button>
        `;
      }).join("");

      list.querySelectorAll(".course-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const slug = btn.getAttribute("data-slug");
          if (!slug || slug === state.activeSlug) return;
          state.activeSlug = slug;
          const url = new URL(window.location.href);
          url.searchParams.set("course", slug);
          history.replaceState({}, "", url);
          renderSidebar();
          renderGuide();
        });
      });
    }

    function lessonCardHtml(lessonDoc, index) {
      const outcomes = getLearningOutcomes(lessonDoc);
      const concepts = getConcepts(lessonDoc);
      const steps = getLessonSteps(lessonDoc);
      const uploadChecklist = getUploadChecklist(lessonDoc);

      const details = lessonDoc.lesson || {};
      const intro = details.intro || lessonDoc.description || "No description available.";
      const type = String(lessonDoc.type || "theory").toLowerCase();
      const time = lessonDoc.estimatedTime ? `${lessonDoc.estimatedTime}` : "Flexible";

      return `
        <article class="lesson-card">
          <div class="lesson-title-row">
            <h3 class="lesson-title">${index + 1}. ${escapeHtml(lessonDoc.title || "Untitled Lesson")}</h3>
            <div class="lesson-badges">
              <span class="badge ${typeClass(type)}">${escapeHtml(type)}</span>
              <span class="badge">${escapeHtml(time)}</span>
            </div>
          </div>
          <p class="lesson-desc">${escapeHtml(intro)}</p>
          <div class="mini-grid">
            <div class="mini-box">
              <h4>Learning outcomes</h4>
              ${outcomes.length ? `<ul>${outcomes.map((o) => `<li>${escapeHtml(o)}</li>`).join("")}</ul>` : `<p class="lesson-desc">No outcomes listed.</p>`}
            </div>
            <div class="mini-box">
              <h4>Implementation path</h4>
              ${steps.length ? `<ul>${steps.map((s) => `<li>${escapeHtml(s)}</li>`).join("")}</ul>` : `<p class="lesson-desc">No step list available.</p>`}
            </div>
            <div class="mini-box">
              <h4>Core concepts</h4>
              ${concepts.length ? `<ul>${concepts.map((c) => `<li>${escapeHtml(c)}</li>`).join("")}</ul>` : `<p class="lesson-desc">Concept notes not available.</p>`}
            </div>
          </div>
          ${type === "project" ? `
            <div class="mini-box" style="margin-top:10px;">
              <h4>Project submission checklist</h4>
              ${uploadChecklist.length ? `<ul>${uploadChecklist.map((item) => `<li>${escapeHtml(item)}</li>`).join("")}</ul>` : `<p class="lesson-desc">Upload requirements will appear in lesson details.</p>`}
            </div>
          ` : ""}
        </article>
      `;
    }

    async function renderGuide() {
      const root = document.getElementById("guideRoot");
      const entry = state.courses.find((c) => c.course.slug === state.activeSlug);
      if (!entry) {
        root.innerHTML = `
          <div class="guide-header">
            <h1>Guide unavailable</h1>
            <p>Select a course from the left panel.</p>
          </div>
        `;
        return;
      }

      root.innerHTML = `
        <div class="guide-header">
          <h1>${escapeHtml(entry.course.title || "Course Guide")}</h1>
          <p>${escapeHtml(entry.course.description || "Detailed guide for this course and all lessons.")}</p>
          <div class="quick-row">
            <span class="chip">${escapeHtml(entry.course.category || "Track")}</span>
            <span class="chip">${entry.lessonCount} Lessons</span>
            <span class="chip">Slug: ${escapeHtml(entry.course.slug)}</span>
            <span class="chip"><a href="course.html?course=${encodeURIComponent(entry.course.slug)}" style="color:#7dd3fc;text-decoration:none;">Open Course</a></span>
          </div>
        </div>
      `;

      const lessons = await fetchLessonsForCourse(entry.course.slug);

      const lessonBlock = lessons.length
        ? lessons.map((lesson, i) => lessonCardHtml(lesson, i)).join("")
        : `<div class="empty">No lessons found for this course.</div>`;

      root.innerHTML += `
        <section class="block">
          <div class="block-head"><i class="fas fa-book-open"></i> Lesson-by-Lesson Guide</div>
          <div class="block-body">${lessonBlock}</div>
        </section>

        <section class="block">
          <div class="block-head"><i class="fas fa-route"></i> How to Use This Guide Effectively</div>
          <div class="block-body playbook">
            <div class="playbook-item">
              <strong>1. Start from lesson order.</strong>
              <p>Complete lessons in sequence. Later lessons assume earlier concepts are already clear.</p>
            </div>
            <div class="playbook-item">
              <strong>2. Use lesson outcomes as checklist.</strong>
              <p>Before moving next, ensure each outcome is practically done, not just read once.</p>
            </div>
            <div class="playbook-item">
              <strong>3. For project lessons, follow upload rules exactly.</strong>
              <p>Allowed file type, folder naming, and validation checks are enforced during admin review.</p>
            </div>
            <div class="playbook-item">
              <strong>4. Track weak areas.</strong>
              <p>If one lesson is difficult, revisit the same guide card and repeat only that section.</p>
            </div>
          </div>
        </section>
      `;
    }

    async function init() {
      try {
        state.courses = await fetchCourses();
        if (!state.courses.length) {
          document.getElementById("courseList").innerHTML = '<div class="empty">No courses found.</div>';
          document.getElementById("guideRoot").innerHTML = '<div class="guide-header"><h1>No guide data</h1><p>Courses are not available right now.</p></div>';
          return;
        }

        const querySlug = new URLSearchParams(window.location.search).get("course");
        const validSlug = state.courses.some((entry) => entry.course.slug === querySlug) ? querySlug : null;
        state.activeSlug = validSlug || state.courses[0].course.slug;

        renderSidebar();
        await renderGuide();
      } catch (err) {
        console.error(err);
        document.getElementById("courseList").innerHTML = '<div class="empty">Failed to load courses.</div>';
        document.getElementById("guideRoot").innerHTML = '<div class="guide-header"><h1>Guide load failed</h1><p>Please refresh and try again.</p></div>';
      }
    }

    init();
  </script>
</body>
</html>
