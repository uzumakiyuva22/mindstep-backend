<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MindStep - Login</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
    :root {
        --primary: #33A1FD;
        --primary-dim: rgba(51, 161, 253, 0.3);
        --accent: #8A2BE2;
        --gold-soft: #f6d37a;
        --bg-deep: #030305;
        --glass-surface: rgba(255, 255, 255, 0.04);
        --glass-border: rgba(255, 255, 255, 0.08);
        --glass-highlight: rgba(255, 255, 255, 0.15);
        --glass-strong: rgba(255, 255, 255, 0.12);
        --text-main: #ffffff;
        --text-muted: #94a3b8;
        --danger: #ff4757;
        
        /* Apple-style Easing */
        --ease-spring: cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
        min-height: 100vh;
        min-height: 100svh;
        font-family: 'Inter', sans-serif;
        background:
            radial-gradient(130% 100% at 10% 0%, rgba(21, 74, 132, 0.22), transparent 60%),
            radial-gradient(130% 100% at 100% 100%, rgba(91, 32, 122, 0.16), transparent 62%),
            var(--bg-deep);
        color: var(--text-main);
        display: flex; justify-content: center; align-items: center;
        overflow: hidden;
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
    }

    /* --- Cinematic Background --- */
    .ambient-light {
        position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: -1;
        overflow: hidden;
    }
    .ambient-light::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(110deg, transparent 30%, rgba(255, 255, 255, 0.06) 50%, transparent 70%);
        transform: translateX(-100%);
        animation: ambientSweep 10s linear infinite;
        opacity: 0.25;
    }
    .blob {
        position: absolute; border-radius: 50%;
        filter: blur(80px); opacity: 0.4;
        animation: float 20s infinite ease-in-out alternate;
    }
    .blob-1 { width: 500px; height: 500px; background: var(--primary); top: -10%; left: -10%; }
    .blob-2 { width: 400px; height: 400px; background: var(--accent); bottom: -10%; right: -10%; animation-delay: -5s; }
    
    @keyframes float { 
        0% { transform: translate(0, 0) scale(1); } 
        100% { transform: translate(50px, 50px) scale(1.1); } 
    }

    /* Noise Texture */
    .noise-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        pointer-events: none; z-index: 0; opacity: 0.7;
    }

    /* --- Glass Container (Stable & Premium) --- */
    .container {
        width: 1000px;
        height: clamp(640px, 89vh, 780px);
        max-width: 90%;
        max-height: 90vh;
        background: var(--glass-surface);
        backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
        border: 1px solid var(--glass-border);
        border-top: 1px solid var(--glass-highlight);
        border-radius: 24px;
        box-shadow: 0 40px 80px rgba(0,0,0,0.5);
        opacity: 0;
        transform: translateY(24px) scale(0.985);
        animation: cardReveal 0.9s var(--ease-spring) forwards, breathe 6s ease-in-out infinite alternate 0.9s;
        display: flex; position: relative; z-index: 10;
        isolation: isolate;
        overflow: hidden;
    }
    .container::before {
        content: "";
        position: absolute;
        inset: 0;
        padding: 1px;
        border-radius: inherit;
        background: linear-gradient(125deg, rgba(113, 203, 255, 0.95), rgba(192, 120, 255, 0.85), rgba(246, 211, 122, 0.6));
        -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
        -webkit-mask-composite: xor;
        mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
        mask-composite: exclude;
        opacity: 0.75;
        animation: borderShift 9s linear infinite;
        pointer-events: none;
        z-index: 4;
    }
    .container::after {
        content: "";
        position: absolute;
        inset: 2px;
        border-radius: 22px;
        border: 1px solid rgba(255, 255, 255, 0.04);
        pointer-events: none;
        z-index: 1;
    }

    @keyframes cardReveal {
        from { opacity: 0; transform: translateY(24px) scale(0.985); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes breathe {
        0% { box-shadow: 0 40px 80px rgba(0,0,0,0.5); border-color: var(--glass-border); }
        100% { box-shadow: 0 45px 90px rgba(51, 161, 253, 0.15); border-color: rgba(255,255,255,0.15); }
    }
    @keyframes borderShift {
        0% { filter: hue-rotate(0deg); }
        100% { filter: hue-rotate(360deg); }
    }
    @keyframes ambientSweep {
        0% { transform: translateX(-120%); }
        100% { transform: translateX(120%); }
    }

    /* --- Left Side: Forms --- */
    .form-side {
        width: 45%; height: 100%;
        padding: 40px 50px;
        display: flex; flex-direction: column;
        position: relative; overflow: hidden;
        border-right: 1px solid var(--glass-border);
        background: rgba(10, 10, 12, 0.4);
    }

    .brand {
        display: flex; align-items: center; gap: 12px; margin-bottom: 40px;
        opacity: 0; animation: fadeDown 0.8s var(--ease-spring) forwards 0.2s;
    }
    .brand i { font-size: 1.8rem; color: var(--primary); filter: drop-shadow(0 0 15px var(--primary)); }
    .brand span { font-family: 'Orbitron'; font-size: 1.4rem; font-weight: 800; letter-spacing: 1px; }

    /* Form Animation Wrapper */
    .form-wrapper {
        position: relative;
        width: 100%;
        flex: 1;
        min-height: 0;
    }
    
    .form-panel {
        position: absolute; top: 0; left: 0; width: 100%;
        transition: all 0.6s var(--ease-spring);
        opacity: 0; pointer-events: none; transform: translateY(20px) scale(0.98);
        height: 100%;
        overflow-y: auto;
        -ms-overflow-style: none;
        scrollbar-width: none;
        padding-right: 0;
        padding-bottom: 18px;
    }
    .form-panel.active { opacity: 1; pointer-events: auto; transform: translateY(0) scale(1); }
    .form-panel::-webkit-scrollbar { width: 0; height: 0; display: none; }

    #loginPanel {
        overflow-y: hidden;
    }
    #signupPanel {
        overflow-y: auto;
    }

    #loginPanel .subtitle {
        margin-bottom: 16px;
    }
    #loginPanel .google-hint {
        margin-bottom: 10px;
    }
    #loginPanel .oauth-divider {
        margin: 8px 0 12px;
    }
    #loginPanel .input-group {
        margin-bottom: 14px;
    }
    #loginPanel .btn-main {
        margin-top: 6px;
    }
    #loginPanel .switch-text {
        margin-top: 14px;
    }
    #loginPanel .admin-link {
        margin-top: 8px;
    }

    /* Staggered Animations */
    .stagger-1 { opacity: 0; animation: fadeUp 0.6s var(--ease-spring) forwards 0.3s; }
    .stagger-2 { opacity: 0; animation: fadeUp 0.6s var(--ease-spring) forwards 0.4s; }
    .stagger-3 { opacity: 0; animation: fadeUp 0.6s var(--ease-spring) forwards 0.5s; }
    
    h2 { font-size: 2rem; font-weight: 700; margin-bottom: 8px; color: #fff; }
    .subtitle { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 25px; }

    /* Apple-Style Inputs */
    .input-group { position: relative; margin-bottom: 18px; }
    .input-group::after {
        content: "";
        position: absolute;
        inset: -1px;
        border-radius: 15px;
        background: linear-gradient(135deg, rgba(51, 161, 253, 0.22), rgba(246, 211, 122, 0.08));
        opacity: 0;
        transition: opacity 0.3s var(--ease-spring);
        pointer-events: none;
    }
    .input-group:focus-within::after {
        opacity: 1;
    }
    
    .input-group input {
        width: 100%; padding: 16px 16px 16px 45px;
        background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
        border-radius: 14px; color: #fff; font-size: 0.95rem; font-family: 'Inter', sans-serif;
        position: relative;
        z-index: 2;
        transition: all 0.3s var(--ease-spring);
    }
    .input-group input::placeholder {
        color: #8ea2c2;
    }
    
    .input-group i.icon-left {
        position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
        color: var(--text-muted); font-size: 1rem; transition: 0.3s; pointer-events: none;
        z-index: 3;
    }

    .toggle-pass {
        position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
        color: var(--text-muted); cursor: pointer; transition: 0.3s; font-size: 0.9rem;
        z-index: 3;
    }
    .toggle-pass:hover { color: var(--primary); transform: translateY(-50%) scale(1.1); }

    /* Focus Micro-interaction */
    .input-group input:focus {
        border-color: var(--primary); background: rgba(255,255,255,0.06);
        box-shadow: 0 0 0 4px var(--primary-dim); transform: translateY(-2px);
    }
    .input-group:focus-within i.icon-left { color: var(--primary); }

    /* Error Shake */
    .input-group.error input { border-color: var(--danger); animation: shake 0.4s ease-in-out; }
    .input-group.error i { color: var(--danger); }
    @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

    /* Button Micro-interaction */
    .btn-main {
        width: 100%; padding: 16px; border-radius: 14px; border: none;
        background: linear-gradient(130deg, #44b6ff 0%, #1f80dd 55%, #0a58bc 100%);
        color: #fff; font-size: 1rem; font-weight: 700; cursor: pointer;
        box-shadow: 0 10px 30px rgba(51, 161, 253, 0.28); margin-top: 10px;
        position: relative; overflow: hidden; 
        transition: all 0.3s var(--ease-spring);
    }
    .btn-main::before {
        content: "";
        position: absolute;
        top: 0;
        left: -120%;
        width: 60%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.35), transparent);
        transform: skewX(-20deg);
        transition: left 0.6s ease;
    }
    .btn-main:hover::before {
        left: 140%;
    }
    .btn-main:hover { transform: translateY(-3px); box-shadow: 0 20px 40px rgba(51, 161, 253, 0.4); }
    .btn-main:active { transform: scale(0.96); box-shadow: 0 5px 15px rgba(51, 161, 253, 0.2); }

    .oauth-divider {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0 16px;
        color: var(--text-muted);
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.6px;
    }
    .oauth-divider::before,
    .oauth-divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: rgba(255, 255, 255, 0.14);
    }

    .btn-google {
        width: 100%;
        min-height: 48px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: linear-gradient(130deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.06));
        color: #fff;
        font-size: 0.94rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        cursor: pointer;
        transition: all 0.25s var(--ease-spring);
        margin-bottom: 6px;
    }
    .btn-google i {
        font-size: 1rem;
    }
    .btn-google:hover {
        transform: translateY(-2px);
        border-color: rgba(255, 255, 255, 0.24);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.28);
    }
    .btn-google:active {
        transform: scale(0.98);
    }

    .google-hint {
        display: block;
        margin-bottom: 14px;
        color: #9ab3d9;
        font-size: 0.78rem;
        line-height: 1.45;
    }

    .google-auth-block {
        margin-bottom: 8px;
    }

    .google-render {
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .google-hint.error {
        color: #ffb4bc;
    }

    .google-change {
        color: var(--primary);
        font-weight: 600;
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 0;
        font-size: 0.78rem;
        margin-left: 6px;
    }
    
    /* Loading Spinner */
    .btn-main.loading { color: transparent; pointer-events: none; }
    .btn-main.loading::after {
        content: ""; position: absolute; left: 50%; top: 50%; width: 20px; height: 20px;
        border: 2px solid #fff; border-top-color: transparent; border-radius: 50%;
        animation: spin 0.8s linear infinite; transform: translate(-50%, -50%);
    }
    @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

    .switch-text { margin-top: 25px; text-align: center; font-size: 0.9rem; color: var(--text-muted); }
    .switch-link { color: var(--primary); font-weight: 600; cursor: pointer; margin-left: 5px; text-decoration: none; position: relative; }
    .switch-link::after {
        content: ''; position: absolute; width: 0; height: 1px; bottom: -2px; left: 0;
        background-color: var(--primary); transition: width 0.3s ease;
    }
    .switch-link:hover::after { width: 100%; }

    /* --- Right Side: Visuals --- */
    .visual-side {
        width: 55%; height: 100%; position: relative;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        text-align: center; padding: 40px;
        perspective: 1000px;
    }

    /* Floating Cards */
    .floater {
        position: absolute; border-radius: 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        backdrop-filter: blur(10px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        z-index: 1; pointer-events: none;
    }
    .card-1 { width: 180px; height: 100px; top: 20%; right: 15%; animation: floatCard 6s ease-in-out infinite; }
    .card-2 { width: 140px; height: 140px; bottom: 20%; left: 10%; animation: floatCard 8s ease-in-out infinite reverse; }

    @keyframes floatCard { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

    .visual-content { position: relative; z-index: 2; max-width: 400px; }
    
    .typing-text {
        font-family: 'Orbitron', sans-serif; font-size: 3rem; font-weight: 800;
        margin-bottom: 20px; line-height: 1.1;
        background: linear-gradient(135deg, #fff 0%, var(--primary) 100%);
        background-clip: text;
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        min-height: 3.5rem; filter: drop-shadow(0 0 20px var(--primary-dim));
    }
    .visual-content p { color: #ccc; font-size: 1.1rem; line-height: 1.6; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

    /* Keyframes */
    @keyframes fadeDown { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
    @keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

    /* Admin Link */
    .admin-link {
        margin-top: 15px; display: block; text-align: center; font-size: 0.8rem;
        color: var(--text-muted); text-decoration: none; opacity: 0.7; transition: 0.3s;
    }
    .admin-link:hover { color: var(--primary); opacity: 1; }

    @media (min-width: 901px) and (max-height: 860px) {
        .form-side {
            padding: 30px 42px;
        }

        .brand {
            margin-bottom: 24px;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 6px;
        }
    }

    /* Mobile */
    @media (max-width: 900px) {
        body {
            align-items: flex-start;
            overflow-y: auto;
            padding: calc(14px + env(safe-area-inset-top)) 14px calc(14px + env(safe-area-inset-bottom));
        }
        body.auth-login-active {
            align-items: center;
        }
        body.auth-signup-active {
            align-items: flex-start;
        }

        .container {
            width: 100%;
            max-width: 430px;
            min-height: 0;
            height: auto;
            max-height: none;
            margin: 0 auto;
            border-radius: 28px;
            border: 1px solid rgba(255, 255, 255, 0.16);
            background:
                radial-gradient(130% 80% at 0% 0%, rgba(51, 161, 253, 0.2), transparent 60%),
                radial-gradient(120% 80% at 100% 100%, rgba(138, 43, 226, 0.22), transparent 65%),
                rgba(10, 12, 18, 0.82);
            box-shadow: 0 30px 90px rgba(0, 0, 0, 0.6);
            animation: cardReveal 0.7s var(--ease-spring) forwards;
        }
        .container::before { opacity: 0.55; }

        .form-side {
            width: 100%;
            height: auto;
            padding: 28px 24px 30px;
            border-right: none;
            background: linear-gradient(180deg, rgba(20, 36, 66, 0.55), rgba(33, 19, 58, 0.4));
        }

        .brand {
            margin-bottom: 28px;
        }

        .form-wrapper {
            flex: none;
            height: auto;
            min-height: 0;
        }

        .form-panel {
            position: relative;
            top: auto;
            left: auto;
            transition: none;
            height: auto;
            overflow: visible;
            padding-right: 0;
            padding-bottom: 8px;
            opacity: 1;
            transform: none;
            pointer-events: auto;
            display: none;
        }
        .form-panel.active { display: block; }
        #loginPanel { overflow: visible; }
        #signupPanel { overflow: visible; }

        h2 {
            font-size: 2.2rem;
            line-height: 1.15;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1rem;
            margin-bottom: 22px;
            color: #a9b8d1;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group input {
            min-height: 54px;
            font-size: 16px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.06);
        }

        .btn-main {
            min-height: 54px;
            font-size: 1.03rem;
            letter-spacing: 0.2px;
            margin-top: 8px;
        }

        .switch-text {
            margin-top: 18px;
            font-size: 1rem;
        }

        .admin-link {
            margin-top: 14px;
            font-size: 0.9rem;
        }

        .visual-side {
            display: none;
        }
    }

    @media (max-width: 420px) {
        body {
            padding: calc(10px + env(safe-area-inset-top)) 10px calc(10px + env(safe-area-inset-bottom));
        }

        .container {
            min-height: 0;
            border-radius: 24px;
        }

        .form-side {
            padding: 24px 18px 26px;
        }

        .brand span {
            font-size: 1.3rem;
        }

        h2 {
            font-size: 1.95rem;
        }

        .subtitle {
            font-size: 0.95rem;
        }
    }

    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.001ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.001ms !important;
            scroll-behavior: auto !important;
        }
    }
</style>
</head>

<body>

    <div class="ambient-light">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="noise-overlay"></div>
    </div>

    <div class="container">
        
        <div class="form-side">
            <div class="brand">
                <i class="fas fa-brain"></i>
                <span>MindStep</span>
            </div>

            <div class="form-wrapper">
                
                <div class="form-panel active" id="loginPanel">
                    <h2 class="stagger-1">Welcome Back</h2>
                    <p class="subtitle stagger-1">Log in to continue your mastery.</p>

                    <div class="google-auth-block stagger-2">
                        <div id="googleLoginButton" class="google-render"></div>
                    </div>
                    <div class="google-hint stagger-2" id="googleLoginHint">Sign in with Google or use username/password.</div>
                    <div class="oauth-divider stagger-2">or sign in with password</div>

                    <div class="input-group stagger-2">
                        <i class="fas fa-envelope icon-left"></i>
                        <input type="text" id="login-user" placeholder="Username or Email" autocomplete="username" autocapitalize="none" enterkeyhint="next">
                    </div>
                    
                    <div class="input-group stagger-2">
                        <i class="fas fa-lock icon-left"></i>
                        <input type="password" id="login-pass" placeholder="Password" autocomplete="current-password" enterkeyhint="go">
                        <i class="fas fa-eye toggle-pass" onclick="togglePassword('login-pass', this)"></i>
                    </div>

                    <button class="btn-main stagger-3" id="btnLogin">Sign In</button>

                    <div class="switch-text stagger-3">
                        New here? <a href="#" class="switch-link" onclick="switchForm('signup')">Create Account</a>
                    </div>
                    <a href="AdminLogin.html" class="admin-link stagger-3">Admin Access -></a>
                </div>

                <div class="form-panel" id="signupPanel">
                    <h2>Create Account</h2>
                    <p class="subtitle">Start your journey today.</p>

                    <div class="google-auth-block">
                        <div id="googleSignupButton" class="google-render"></div>
                    </div>
                    <div class="google-hint" id="googleSignupHint">Create account instantly with Google.</div>
                    <div class="oauth-divider">or continue manually</div>

                    <div class="input-group">
                        <i class="fas fa-user icon-left"></i>
                        <input type="text" id="signup-name" placeholder="Full Name">
                    </div>
                    <div class="input-group">
                        <i class="fas fa-at icon-left"></i>
                        <input type="email" id="signup-email" placeholder="Email Address">
                    </div>
                    <div class="input-group">
                        <i class="fas fa-key icon-left"></i>
                        <input type="password" id="signup-pass" placeholder="Password">
                        <i class="fas fa-eye toggle-pass" onclick="togglePassword('signup-pass', this)"></i>
                    </div>
                    
                    <div style="margin-bottom:15px; display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="document.getElementById('signup-file').click()">
                        <div style="width:40px; height:40px; border-radius:50%; border:2px solid var(--primary); overflow:hidden; display:flex; justify-content:center; align-items:center;">
                            <img id="img-preview" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
                            <i class="fas fa-camera" id="cam-icon" style="color:var(--primary); font-size:0.9rem;"></i>
                        </div>
                        <span style="font-size:0.9rem; color:var(--primary);">Upload Photo</span>
                        <input type="file" id="signup-file" hidden accept="image/*">
                    </div>

                    <button class="btn-main" id="btnSignup">Sign Up</button>

                    <div class="switch-text">
                        Already a member? <a href="#" class="switch-link" onclick="switchForm('login')">Sign In</a>
                    </div>
                </div>

            </div>
        </div>

        <div class="visual-side">
            <div class="floater card-1"></div>
            <div class="floater card-2"></div>

            <div class="visual-content">
                <h1 class="typing-text" id="dynamicText">Level Up.</h1>
                <p>Interactive courses, smart guides, and real-time tracking to boost your career.</p>
            </div>
        </div>

    </div>

<script>
    // --- 1. PASSWORD TOGGLE ---
    function togglePassword(inputId, icon) {
        const input = document.getElementById(inputId);
        if (input.type === "password") {
            input.type = "text";
            icon.classList.replace("fa-eye", "fa-eye-slash");
        } else {
            input.type = "password";
            icon.classList.replace("fa-eye-slash", "fa-eye");
        }
    }

    // --- 2. IMAGE PREVIEW ---
    const fileInput = document.getElementById('signup-file');
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('img-preview').src = e.target.result;
                document.getElementById('img-preview').style.display = 'block';
                document.getElementById('cam-icon').style.display = 'none';
            }
            reader.readAsDataURL(file);
        }
    });

    // --- 3. TYPING EFFECT ---
    const phrases = ["Level Up.", "Think Big.", "Code Pro.", "MindStep."];
    let pIdx = 0, cIdx = 0, isDeleting = false;
    const typeElem = document.getElementById("dynamicText");

    function typeLoop() {
        const current = phrases[pIdx];
        if (isDeleting) {
            typeElem.textContent = current.substring(0, cIdx--);
            if (cIdx < 0) { isDeleting = false; pIdx = (pIdx + 1) % phrases.length; }
        } else {
            typeElem.textContent = current.substring(0, cIdx++);
            if (cIdx > current.length) { isDeleting = true; setTimeout(typeLoop, 2000); return; }
        }
        setTimeout(typeLoop, isDeleting ? 50 : 100);
    }
    typeLoop();

    // --- 4. UI SWITCHING ---
    function setAuthViewportMode(target) {
        const isMobileLayout = window.matchMedia('(max-width: 900px)').matches;
        document.body.classList.remove('auth-login-active', 'auth-signup-active');
        if (!isMobileLayout) return;
        document.body.classList.add(target === 'signup' ? 'auth-signup-active' : 'auth-login-active');
    }

    function switchForm(target) {
        const login = document.getElementById('loginPanel');
        const signup = document.getElementById('signupPanel');
        const active = target === 'signup' ? signup : login;
        const inactive = target === 'signup' ? login : signup;
        const isMobileLayout = window.matchMedia('(max-width: 900px)').matches;

        if (inactive) inactive.scrollTop = 0;
        if (active) active.scrollTop = 0;
        setAuthViewportMode(target);
        inactive.classList.remove('active');

        const activatePanel = () => {
            active.classList.add('active');
            active.scrollTop = 0;
            const focusInput = active.querySelector('input:not([type="file"])');
            if (focusInput) {
                focusInput.focus();
            }
        };

        if (isMobileLayout) {
            activatePanel();
        } else {
            // Small delay for smooth fade on desktop only
            setTimeout(activatePanel, 200);
        }
    }

    // --- 5. API LOGIC (Optimistic UI) ---
    const API_BASE = window.location.origin.includes("localhost") 
      ? "http://localhost:10000" 
      : window.location.origin;

    function setGoogleHint(message, isError = false) {
        const loginHint = document.getElementById('googleLoginHint');
        const signupHint = document.getElementById('googleSignupHint');
        [loginHint, signupHint].forEach(el => {
            if (!el) return;
            el.textContent = message;
            el.classList.toggle('error', Boolean(isError));
        });
    }

    function waitForGoogleLibrary(timeoutMs = 8000) {
        return new Promise((resolve, reject) => {
            const start = Date.now();
            const check = () => {
                if (window.google && window.google.accounts && window.google.accounts.id) {
                    resolve();
                    return;
                }
                if (Date.now() - start > timeoutMs) {
                    reject(new Error("Google library failed to load"));
                    return;
                }
                setTimeout(check, 120);
            };
            check();
        });
    }

    async function handleGoogleCredential(response) {
        try {
            const credential = String(response?.credential || "").trim();
            if (!credential) throw new Error("Google credential missing");
            const parseGoogleCredentialPayload = (jwtToken) => {
                try {
                    const parts = String(jwtToken || "").split(".");
                    if (parts.length < 2) return {};
                    const base64 = parts[1].replace(/-/g, "+").replace(/_/g, "/");
                    const padded = base64.padEnd(Math.ceil(base64.length / 4) * 4, "=");
                    const parsed = JSON.parse(atob(padded));
                    return parsed && typeof parsed === "object" ? parsed : {};
                } catch (_) {
                    return {};
                }
            };
            const credentialPayload = parseGoogleCredentialPayload(credential);
            const pictureHint = String(credentialPayload?.picture || "").trim();

            const res = await fetch(`${API_BASE}/api/auth/google`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ credential, pictureHint })
            });
            const data = await res.json();
            if (!res.ok || !data.success) {
                throw new Error(data.message || "Google login failed");
            }

            const mergedUser = { ...(data.user || {}) };
            if ((!mergedUser.image || !String(mergedUser.image).trim()) && pictureHint) {
                mergedUser.image = pictureHint;
            }

            localStorage.setItem("token", data.token);
            localStorage.setItem("mindstep_token", data.token);
            localStorage.setItem("user", JSON.stringify(mergedUser));
            localStorage.setItem("mindstep_user", JSON.stringify(mergedUser));
            window.location.href = "MainPage.html";
        } catch (err) {
            alert(err.message || "Google Sign-In failed");
        }
    }

    async function initGoogleSignIn() {
        const loginHost = document.getElementById("googleLoginButton");
        const signupHost = document.getElementById("googleSignupButton");
        if (!loginHost || !signupHost) return;

        try {
            const configRes = await fetch(`${API_BASE}/api/auth/google/config`);
            const config = await configRes.json();
            if (!configRes.ok || !config.success || !config.clientId) {
                throw new Error(config.message || "Google Sign-In unavailable");
            }

            await waitForGoogleLibrary();

            google.accounts.id.initialize({
                client_id: config.clientId,
                callback: handleGoogleCredential,
                auto_select: false,
                cancel_on_tap_outside: true
            });

            const renderFor = (container) => {
                const width = Math.min(360, Math.max(240, Math.floor(container.clientWidth || 320)));
                container.innerHTML = "";
                google.accounts.id.renderButton(container, {
                    type: "standard",
                    theme: "outline",
                    size: "large",
                    text: "continue_with",
                    shape: "pill",
                    logo_alignment: "left",
                    width
                });
            };

            renderFor(loginHost);
            renderFor(signupHost);
            setGoogleHint("Use Google or continue with MindStep account.");
        } catch (err) {
            loginHost.innerHTML = `<button type="button" class="btn-google" disabled><i class="fab fa-google"></i> Google unavailable</button>`;
            signupHost.innerHTML = `<button type="button" class="btn-google" disabled><i class="fab fa-google"></i> Google unavailable</button>`;
            setGoogleHint(err.message || "Google Sign-In unavailable", true);
        }
    }

    async function handleAuth(type) {
        const isLogin = type === 'login';
        const btn = document.getElementById(isLogin ? 'btnLogin' : 'btnSignup');
        const originalText = btn.innerText;
        
        // Input gathering
        const inputs = isLogin 
            ? { u: document.getElementById('login-user'), p: document.getElementById('login-pass') }
            : { n: document.getElementById('signup-name'), e: document.getElementById('signup-email'), p: document.getElementById('signup-pass'), f: document.getElementById('signup-file') };

        // Validation
        let valid = true;
        Object.values(inputs).forEach(input => {
            if(input.type !== 'file' && !input.value.trim()) {
                input.parentElement.classList.add('error');
                setTimeout(() => input.parentElement.classList.remove('error'), 500);
                valid = false;
            }
        });
        if(!valid) return;

        if(!isLogin) {
            const emailValue = inputs.e.value.trim().toLowerCase();
            const emailPattern = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/;
            if(!emailPattern.test(emailValue)) {
                alert("Please enter a valid email address.");
                return;
            }
            inputs.e.value = emailValue;
        }

        // Optimistic Loading State
        btn.classList.add('loading');
        btn.innerHTML = ''; // Hide text for spinner

        try {
            let res, data;
            if(isLogin) {
                res = await fetch(`${API_BASE}/api/login`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ usernameOrEmail: inputs.u.value.trim(), password: inputs.p.value.trim() })
                });
            } else {
                const formData = new FormData();
                formData.append("username", inputs.n.value.trim());
                formData.append("email", inputs.e.value.trim());
                formData.append("password", inputs.p.value.trim());
                if(inputs.f.files[0]) formData.append("image", inputs.f.files[0]);
                
                res = await fetch(`${API_BASE}/api/signup`, { method: "POST", body: formData });
            }

            data = await res.json();

            if(data.success) {
                if(isLogin) {
                    localStorage.setItem("token", data.token);
                    localStorage.setItem("mindstep_token", data.token);
                    localStorage.setItem("user", JSON.stringify(data.user));
                    localStorage.setItem("mindstep_user", JSON.stringify(data.user));
                    window.location.href = "MainPage.html";
                } else {
                    alert("Account Created! Please Login.");
                    const createdUsername = inputs.n.value.trim();
                    switchForm('login');
                    if (createdUsername) {
                        document.getElementById('login-user').value = createdUsername;
                        document.getElementById('login-pass').focus();
                    }
                }
            } else {
                alert(data.message || data.error || "Action Failed");
            }
        } catch(e) {
            alert("Connection Error");
        } finally {
            btn.classList.remove('loading');
            btn.innerText = originalText;
        }
    }

    document.getElementById('btnLogin').onclick = () => handleAuth('login');
    document.getElementById('btnSignup').onclick = () => handleAuth('signup');

    const loginUserInput = document.getElementById('login-user');
    const loginPassInput = document.getElementById('login-pass');
    const signupNameInput = document.getElementById('signup-name');
    const signupEmailInput = document.getElementById('signup-email');
    const signupPassInput = document.getElementById('signup-pass');

    window.addEventListener('load', () => {
        document.querySelectorAll('.form-panel').forEach(panel => { panel.scrollTop = 0; });
        const activePanel = document.querySelector('.form-panel.active');
        setAuthViewportMode(activePanel && activePanel.id === 'signupPanel' ? 'signup' : 'login');
        loginUserInput.focus();
        initGoogleSignIn();
    });

    window.addEventListener('resize', () => {
        const activePanel = document.querySelector('.form-panel.active');
        setAuthViewportMode(activePanel && activePanel.id === 'signupPanel' ? 'signup' : 'login');
    });

    loginUserInput.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter') return;
        event.preventDefault();
        loginPassInput.focus();
        loginPassInput.select();
    });

    loginPassInput.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter') return;
        event.preventDefault();
        handleAuth('login');
    });

    signupNameInput.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter') return;
        event.preventDefault();
        signupEmailInput.focus();
        signupEmailInput.select();
    });

    signupEmailInput.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter') return;
        event.preventDefault();
        signupPassInput.focus();
    });

    signupPassInput.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter') return;
        event.preventDefault();
        handleAuth('signup');
    });

</script>
</body>
</html>
